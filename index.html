<!DOCTYPE html>
<html lang="pl" class="">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prompt Panel v6.1 (Poprawiony)</title>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        
        * {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
        }
    </style>

    <!-- SECTION: CDN & Fonts / Zasoby CDN i Czcionki -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Lora:wght@400;500&family=Roboto+Mono:wght@400;500&family=Source+Code+Pro:wght@400;500&family=Hanken+Grotesk:wght@400;500;600&family=Merriweather:wght@400;700&family=Noto+Serif:wght@400;700&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- SECTION: Quill Rich Text Editor / Edytor Tekstu Quill -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

    <!-- SECTION: DOMPurify for XSS Protection / DOMPurify do ochrony przed XSS -->
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>

    <!-- SECTION: CSS Styles / Style CSS -->
    <style>
        /* -------------------------------------------------- */
        /* 1. Root Variables & Base Styles / Zmienne Główne i Style Bazowe
        /* -------------------------------------------------- */
		
        :root {
            --sidebar-top: 81px; /* Domyślna wartość, aktualizowana przez JS */
            --editor-font-family: 'Inter', sans-serif;
            --editor-font-size: 1rem; /* Domyślna wielkość czcionki w edytorze */
            --editor-line-height: 1.5; /* Domyślna interlinia */
            --editor-paragraph-spacing: 1rem; /* Domyślny odstęp między akapitami */
            
            /* Kolory akcentu (domyślnie Indigo) */
            --accent-50: 238, 242, 255;   /* indigo-50 */
            --accent-100: 224, 231, 255;  /* indigo-100 */
            --accent-200: 199, 210, 254;  /* indigo-200 */
            --accent-500: 99, 102, 241;   /* indigo-500 */
            --accent-600: 79, 70, 229;   /* indigo-600 */
            --accent-800: 55, 48, 163;   /* indigo-800 */
            --accent-950: 30, 27, 75;     /* indigo-950 */
        }

        html { font-size: 85%; }
        body { font-family: 'Inter', sans-serif; overflow-x: hidden; }
		
		

        /* -------------------------------------------------- */
        /* 2. Custom Scrollbar & Dragging / Własny Pasek Przewijania i Przeciąganie
        /* -------------------------------------------------- */
        /* Enhanced scrollbar for left sidebar */
        #left-sidebar .custom-scrollbar::-webkit-scrollbar { 
            width: 12px; 
        }
        #left-sidebar .custom-scrollbar { 
            padding-right: 8px; 
            margin-right: -8px; 
        }
        #left-sidebar .custom-scrollbar::-webkit-scrollbar-track { 
            background: rgba(15, 23, 42, 0.6); 
            border-radius: 8px;
            border: 1px solid rgba(71, 85, 105, 0.3);
        }
        #left-sidebar .custom-scrollbar::-webkit-scrollbar-thumb { 
            background: linear-gradient(180deg, rgba(var(--accent-500), 0.8), rgba(var(--accent-600), 0.9)); 
            border-radius: 8px; 
            border: 1px solid rgba(var(--accent-400), 0.4);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        #left-sidebar .custom-scrollbar::-webkit-scrollbar-thumb:hover { 
            background: linear-gradient(180deg, rgba(var(--accent-400), 0.9), rgba(var(--accent-500), 1)); 
            box-shadow: 0 2px 8px rgba(var(--accent-500), 0.4);
        }
        .dark #left-sidebar .custom-scrollbar::-webkit-scrollbar-track { 
            background: rgba(2, 6, 23, 0.8); 
        }
        .dark #left-sidebar .custom-scrollbar::-webkit-scrollbar-thumb { 
            background: linear-gradient(180deg, rgba(var(--accent-600), 0.7), rgba(var(--accent-700), 0.8)); 
        }
        .dark #left-sidebar .custom-scrollbar::-webkit-scrollbar-thumb:hover { 
            background: linear-gradient(180deg, rgba(var(--accent-500), 0.8), rgba(var(--accent-600), 0.9)); 
        }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #64748b; }

        .dragging { opacity: 0.5; background: #c7d2fe; }
        .drag-over-placeholder {
            border: 2px dashed rgba(var(--accent-500), 0.6);
            background-color: rgba(var(--accent-100), 0.5);
            border-radius: 0.5rem;
            margin: 0.25rem 0;
            height: 40px;
        }
        
        /* -------------------------------------------------- */
        /* 3. Snippet Dropdown / Rozwijane Menu Snippetów
        /* -------------------------------------------------- */
        .snippet-dropdown {
            position: fixed;
            background-color: white; border: 1px solid #e2e8f0;
            border-radius: 0.5rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            z-index: 1000; max-height: 250px; overflow-y: hidden; max-width: 20rem;
            display: flex; flex-direction: column;
        }
        .snippet-item { padding: 0.5rem 1rem; cursor: pointer; }
        .snippet-item:hover { background-color: #f1f5f9; }

        /* -------------------------------------------------- */
        /* 4. Quill Editor Styles / Style Edytora Quill
        /* -------------------------------------------------- */
        #prompt-editor-quill-container .ql-editor,
        #snippet-content-editor .ql-editor,
        .chain-step-editor .ql-editor {
            font-family: var(--editor-font-family);
            font-size: var(--editor-font-size);
            line-height: var(--editor-line-height);
        }

        .ql-editor p, .ql-editor h1, .ql-editor h2, .ql-editor h3, .ql-editor ol, .ql-editor ul {
           margin-bottom: var(--editor-paragraph-spacing);
        }
        .ql-editor > *:last-child {
            margin-bottom: 0;
        }

        .ql-toolbar {
            flex-shrink: 0;
            border-top-left-radius: 0.5rem;
            border-top-right-radius: 0.5rem;
            border-bottom: 0 !important;
        }
        .ql-container {
            flex-grow: 1;
            overflow-y: auto;
            border-bottom-left-radius: 0.5rem;
            border-bottom-right-radius: 0.5rem;
            display: flex;
            flex-direction: column;
        }
        .ql-container.ql-snow {
            border-top: 1px solid #e2e8f0;
        }
        .dark .ql-container.ql-snow {
            border-top-color: #475569;
        }
        .ql-editor {
            min-height: 150px;
            flex-grow: 1;
        }

        .ql-editor {
            background-color: white !important;
        }
        .dark .ql-editor {
            background-color: #1e293b !important;
            color: #e2e8f0 !important;
        }

        .ql-editor.ql-disabled { background-color: #f8fafc; }
        .dark .ql-editor.ql-disabled { background-color: #1e293b; }

        .ql-editor.ql-blank::before {
            font-style: normal;
        }

        /* -------------------------------------------------- */
        /* 5. Fullscreen Mode Styles / Style Trybu Pełnoekranowego
        /* -------------------------------------------------- */
        #fullscreen-overlay {
            position: fixed; inset: 0; width: 100vw; height: 100vh;
            z-index: 1001; background-color: rgba(15,23,42,0.6);
            display: flex; align-items: center; justify-content: center;
        }
        .dark #fullscreen-overlay { background-color: rgba(2,6,23,0.65); }
        #fullscreen-window {
            width: 90vw; height: 90vh;
            background-color: var(--bg-color, white);
            border-radius: 0.75rem;
            box-shadow: 0 25px 50px -12px rgb(0 0 0 / 0.25);
            display: flex; flex-direction: column;
            overflow: hidden;
        }
        .dark #fullscreen-window { --bg-color: #1e293b; }
        #fullscreen-bar {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #e2e8f0;
            display: flex; justify-content: space-between; align-items: center;
            flex-shrink: 0;
        }
        .dark #fullscreen-bar { border-color: #334155; }
        #fullscreen-window #editor-view {
            flex-grow: 1;
            padding: 1rem;
            display: flex;
            flex-direction: column;
        }
        #fullscreen-window .ql-container { height: auto !important; flex-grow: 1; }
        #fullscreen-window #prompt-content-container,
        #fullscreen-window #chain-editor-container {
            height: 100%;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        /* -------------------------------------------------- */
        /* 6. UI Components (Status, Pills, etc.) / Komponenty UI (Status, Przełączniki, itp.)
        /* -------------------------------------------------- */
        .version-date { font-size: 0.8em; color: #64748b; }
        .dark .version-date { color: #94a3b8; }
        
        .pill-switch { position: relative; display: inline-block; width: 50px; height: 26px; }
        .pill-switch input { opacity: 0; width: 0; height: 0; }
        .pill-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .pill-slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .pill-slider { background-color: rgba(var(--accent-500), 1); }
        input:checked + .pill-slider:before { transform: translateX(24px); }
        .pill-slider svg { position: absolute; top: 50%; transform: translateY(-50%); transition: opacity 0.2s; color: rgba(var(--accent-500), 1); }
        .pill-slider .lock-open-icon { right: 6px; opacity: 1; }
        .pill-slider .lock-closed-icon { left: 6px; opacity: 0; color: white; }
        input:checked + .pill-slider .lock-open-icon { opacity: 0; }
        input:checked + .pill-slider .lock-closed-icon { opacity: 1; }

        .loader {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid rgba(var(--accent-500), 1);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* -------------------------------------------------- */
        /* 7. Accent Color Helpers / Klasy Pomocnicze Koloru Akcentu
        /* -------------------------------------------------- */
        .btn-modern-50 { background-color: rgba(var(--accent-50), 1); }
        .btn-modern-100 { background-color: rgba(var(--accent-100), 1); }
        .btn-modern-500 { background-color: rgba(var(--accent-500), 1); }
        .btn-modern-600 { background-color: rgba(var(--accent-600), 1); }
        .text-accent-800 { color: rgba(var(--accent-800), 1); }
        .border-accent-500 { border-color: rgba(var(--accent-500), 1); }
        .dark .btn-modern-950-50 { background-color: rgba(var(--accent-950), 0.5); }
        .dark .text-accent-800 { color: rgba(var(--accent-100), 1); }
        .hover\:btn-modern-600:hover { background-color: rgba(var(--accent-600), 1); }
        .disabled\:bg-slate-300:disabled { background-color: #d1d5db; }
        .dark .disabled\:bg-slate-300:disabled { background-color: #475569; }

        /* -------------------------------------------------- */
        /* 8. Dark Mode Overrides - WCAG AA Enhanced / Nadpisania dla Trybu Ciemnego - WCAG AA
        /* -------------------------------------------------- */
        /* Enhanced contrast ratios for better readability */

        /* Background Colors - Deep, rich tones */
        .dark .bg-slate-100 { background-color: #0f172a; } /* slate-950 - deepest */
        .dark .bg-white { background-color: #1e293b; } /* slate-800 - cards/panels */
        .dark .bg-slate-50 { background-color: #334155; } /* slate-700 - hover states */
        .dark .bg-slate-200 { background-color: #475569; } /* slate-600 - secondary bg */

        /* Text Colors - Enhanced contrast (WCAG AA: 4.5:1 minimum) */
        .dark .text-slate-800 { color: #f1f5f9; } /* slate-100 - primary text - 15.8:1 on #1e293b */
        .dark .text-slate-700 { color: #e2e8f0; } /* slate-200 - headings - 12.6:1 on #1e293b */
        .dark .text-slate-600 { color: #cbd5e1; } /* slate-300 - secondary text - 9.8:1 on #1e293b */
        .dark .text-slate-500 { color: #94a3b8; } /* slate-400 - tertiary text - 5.3:1 on #1e293b */

        /* Border Colors - More visible */
        .dark .border-slate-300 { border-color: #64748b; } /* slate-500 - stronger borders */

        /* Hover States - Smooth transitions */
        .dark .hover\:bg-slate-100:hover { background-color: #334155; }
        .dark .hover\:bg-slate-300:hover { background-color: #64748b; }

        /* Amber/Favorite Colors - Enhanced for dark mode */
        .dark .bg-amber-200 { background-color: #d97706; } /* amber-600 - brighter */
        .dark .text-amber-800 { color: #fef3c7; } /* amber-100 - high contrast */
        .dark .hover\:bg-amber-300:hover { background-color: #f59e0b; } /* amber-500 - vibrant */

        /* Scrollbar - More visible */
        .dark .custom-scrollbar::-webkit-scrollbar-track { background: #1e293b; }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb { background: #64748b; } /* slate-500 - more visible */
        .dark .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; } /* slate-400 - brighter on hover */

        /* Dropdowns & Popovers */
        .dark .snippet-dropdown { background-color: #1e293b; border-color: #64748b; }
        .dark .snippet-item:hover { background-color: #334155; }

        /* Quill Editor - Enhanced readability */
        .dark .ql-snow .ql-stroke { stroke: #e2e8f0; } /* slate-200 */
        .dark .ql-snow .ql-fill { fill: #e2e8f0; }
        .dark .ql-snow .ql-picker-label { color: #e2e8f0; }
        .dark .ql-snow .ql-picker-options { background-color: #334155; border-color: #64748b; }
        .dark .ql-snow .ql-picker-item:hover { color: #c7d2fe; background-color: #475569; } /* indigo-200 on hover */
        .dark .ql-toolbar.ql-snow { border-color: #64748b; background-color: #0f172a; }
        .dark .ql-container.ql-snow { border-color: #64748b; }
        .dark .ql-editor { color: #f1f5f9; } /* slate-100 - highest contrast */

        /* Favorites Fade Effects */
        .dark .favorites-fade-left { background: linear-gradient(to right, #1e293b, transparent); }
        .dark .favorites-fade-right { background: linear-gradient(to left, #1e293b, transparent); }

        /* Icons & Placeholders */
        .dark .placeholder-icon { color: #64748b; } /* slate-500 - more visible */

        /* Buttons - Accent colors */
        .dark .btn-modern-100 { background-color: rgba(var(--accent-800), 0.5); }

        /* Shadows - Deeper for dark mode */
        .dark .shadow-md { box-shadow: 0 4px 6px -1px rgba(0,0,0,0.6), 0 2px 4px -2px rgba(0,0,0,0.6); }
        .dark .shadow-sm { box-shadow: 0 1px 2px 0 rgba(0,0,0,0.4); }
        .dark .shadow-lg { box-shadow: 0 10px 15px -3px rgba(0,0,0,0.6), 0 4px 6px -4px rgba(0,0,0,0.6); }
        .dark .shadow-xl { box-shadow: 0 20px 25px -5px rgba(0,0,0,0.7), 0 8px 10px -6px rgba(0,0,0,0.7); }

        /* -------------------------------------------------- */
        /* WCAG AA - Badges & Pills / Odznaki i Pigułki
        /* -------------------------------------------------- */

        /* Blue badges - Enhanced contrast */
        .dark .bg-blue-100 { background-color: rgba(59, 130, 246, 0.2); } /* blue-500 with opacity */
        .dark .text-blue-800 { color: #93c5fd; } /* blue-300 - 7.2:1 contrast on dark bg */
        .dark .bg-blue-900\/30 { background-color: rgba(30, 58, 138, 0.4); }
        .dark .text-blue-200 { color: #bfdbfe; } /* blue-200 - even higher contrast */

        /* Green badges */
        .dark .bg-green-50 { background-color: rgba(34, 197, 94, 0.15); }
        .dark .text-green-600 { color: #86efac; } /* green-300 */
        .dark .text-green-400 { color: #86efac; } /* green-300 - consistent */
        .dark .hover\:bg-green-50:hover { background-color: rgba(34, 197, 94, 0.2); }
        .dark .hover\:bg-green-900\/20:hover { background-color: rgba(20, 83, 45, 0.3); }

        /* Purple badges */
        .dark .bg-purple-50 { background-color: rgba(168, 85, 247, 0.15); }
        .dark .text-purple-600 { color: #d8b4fe; } /* purple-300 */
        .dark .text-purple-400 { color: #e9d5ff; } /* purple-200 */
        .dark .hover\:text-purple-800 { color: #f3e8ff; } /* purple-100 */
        .dark .hover\:text-purple-300 { color: #f3e8ff; } /* purple-100 */
        .dark .bg-purple-900\/20 { background-color: rgba(88, 28, 135, 0.3); }
        .dark .hover\:bg-purple-100:hover { background-color: rgba(168, 85, 247, 0.2); }
        .dark .hover\:bg-purple-900\/30:hover { background-color: rgba(88, 28, 135, 0.4); }

        /* Red badges */
        .dark .bg-red-500 { background-color: #f87171; } /* red-400 - softer in dark */
        .dark .hover\:bg-red-600:hover { background-color: #fca5a5; } /* red-300 on hover */
        .dark .hover\:bg-red-100:hover { background-color: rgba(239, 68, 68, 0.2); }
        .dark .hover\:bg-red-900\/50:hover { background-color: rgba(127, 29, 29, 0.5); }
        .dark .text-red-600 { color: #fca5a5; } /* red-300 */

        /* Emerald/Teal badges */
        .dark .text-emerald-600 { color: #6ee7b7; } /* emerald-300 */
        .dark .text-teal-600 { color: #5eead4; } /* teal-300 */

        /* Violet badges */
        .dark .text-violet-600 { color: #ddd6fe; } /* violet-300 */

        /* Indigo badges */
        .dark .text-indigo-600 { color: #c7d2fe; } /* indigo-300 */

        /* Cyan badges */
        .dark .text-cyan-600 { color: #a5f3fc; } /* cyan-200 */

        /* Lime badges */
        .dark .text-lime-600 { color: #d9f99d; } /* lime-300 */

        /* Fuchsia badges */
        .dark .text-fuchsia-600 { color: #f5d0fe; } /* fuchsia-300 */

        /* -------------------------------------------------- */
        /* WCAG AA - Gradient Backgrounds / Tła Gradientowe
        /* -------------------------------------------------- */

        /* Info boxes - Blue gradient */
        .dark .from-blue-100 { background: rgba(30, 58, 138, 0.3); }
        .dark .via-cyan-50 { background: rgba(21, 94, 117, 0.2); }
        .dark .to-teal-100 { background: rgba(19, 78, 74, 0.3); }
        .dark .border-blue-300\/60 { border-color: rgba(147, 197, 253, 0.3); }
        .dark .border-blue-600\/40 { border-color: rgba(37, 99, 235, 0.5); }

        /* Success boxes - Green gradient */
        .dark .from-emerald-100 { background: rgba(6, 95, 70, 0.3); }
        .dark .via-green-50 { background: rgba(21, 128, 61, 0.2); }
        .dark .to-lime-100 { background: rgba(77, 124, 15, 0.3); }
        .dark .border-emerald-300\/60 { border-color: rgba(110, 231, 183, 0.3); }
        .dark .border-emerald-600\/40 { border-color: rgba(5, 150, 105, 0.5); }

        /* Output panel - Violet gradient */
        .dark .from-violet-100 { background: rgba(76, 29, 149, 0.3); }
        .dark .via-purple-50 { background: rgba(88, 28, 135, 0.2); }
        .dark .to-fuchsia-100 { background: rgba(112, 26, 117, 0.3); }
        .dark .border-violet-300\/60 { border-color: rgba(196, 181, 253, 0.3); }
        .dark .border-violet-600\/40 { border-color: rgba(124, 58, 237, 0.5); }

        /* Header prompt info - Indigo gradient */
        .dark .from-indigo-50 { background: rgba(67, 56, 202, 0.2); }
        .dark .via-blue-50 { background: rgba(59, 130, 246, 0.15); }
        .dark .to-purple-50 { background: rgba(147, 51, 234, 0.2); }
        .dark .border-indigo-200\/60 { border-color: rgba(199, 210, 254, 0.2); }
        .dark .border-indigo-700\/40 { border-color: rgba(67, 56, 202, 0.5); }

        /* Favorites bar - Vibrant gradient for dark mode */
        .dark .from-indigo-200 { background: rgba(99, 102, 241, 0.25); }
        .dark .via-purple-200 { background: rgba(168, 85, 247, 0.25); }
        .dark .to-indigo-200:last-child { background: rgba(99, 102, 241, 0.25); }

        /* -------------------------------------------------- */
        /* WCAG AA - Buttons / Przyciski
        /* -------------------------------------------------- */

        /* All gradient buttons maintain white text which has high contrast */
        /* But we enhance the background colors for better visibility in dark mode */

        .dark .from-purple-500 { --tw-gradient-from: #a855f7; }
        .dark .to-purple-600 { --tw-gradient-to: #9333ea; }
        .dark .hover\:from-purple-600:hover { --tw-gradient-from: #9333ea; }
        .dark .hover\:to-purple-700:hover { --tw-gradient-to: #7e22ce; }

        .dark .from-blue-500 { --tw-gradient-from: #3b82f6; }
        .dark .to-blue-600 { --tw-gradient-to: #2563eb; }
        .dark .hover\:from-blue-600:hover { --tw-gradient-from: #2563eb; }
        .dark .hover\:to-blue-700:hover { --tw-gradient-to: #1d4ed8; }

        .dark .from-green-500 { --tw-gradient-from: #22c55e; }
        .dark .to-green-600 { --tw-gradient-to: #16a34a; }
        .dark .hover\:from-green-600:hover { --tw-gradient-from: #16a34a; }
        .dark .hover\:to-green-700:hover { --tw-gradient-to: #15803d; }

        .dark .from-emerald-500 { --tw-gradient-from: #10b981; }
        .dark .to-teal-500 { --tw-gradient-to: #14b8a6; }

        .dark .from-violet-500 { --tw-gradient-from: #8b5cf6; }
        .dark .via-purple-600 { --tw-gradient-stops: var(--tw-gradient-from), #9333ea, var(--tw-gradient-to, rgba(147, 51, 234, 0)); }
        .dark .to-indigo-600 { --tw-gradient-to: #4f46e5; }

        /* -------------------------------------------------- */
        /* WCAG AA - Tooltips & Toast Notifications
        /* -------------------------------------------------- */

        /* Toast notifications already use solid colors with white text = high contrast */
        .dark .bg-green-500 { background-color: #22c55e; } /* Already good - 4.8:1 with white */

        /* -------------------------------------------------- */
        /* WCAG AA - Interactive States / Stany Interaktywne
        /* -------------------------------------------------- */

        /* Hover states for links and buttons */
        .dark .hover\:text-blue-600:hover { color: #93c5fd; } /* blue-300 */
        .dark .hover\:text-blue-400:hover { color: #60a5fa; } /* blue-400 */
        .dark .hover\:bg-blue-50:hover { background-color: rgba(59, 130, 246, 0.1); }
        .dark .hover\:bg-blue-900\/20:hover { background-color: rgba(30, 58, 138, 0.3); }

        /* Secondary button hover states */
        .dark .bg-slate-600 { background-color: #475569; }
        .dark .hover\:bg-slate-500:hover { background-color: #64748b; }
        .dark .bg-slate-700 { background-color: #334155; }
        .dark .hover\:bg-slate-600:hover { background-color: #475569; }

        /* -------------------------------------------------- */
        /* WCAG AA - Special Elements / Elementy Specjalne
        /* -------------------------------------------------- */

        /* Green checkmark indicator */
        .dark .bg-green-500 { background-color: #22c55e; }
        .dark .from-green-400 { --tw-gradient-from: #4ade80; }
        .dark .to-emerald-500 { --tw-gradient-to: #10b981; }

        /* Project block selected state - Enhanced */
        .dark .project-block .tree-item-content.selected {
            background: linear-gradient(135deg, rgba(var(--accent-600), 0.3) 0%, rgba(var(--accent-700), 0.25) 100%);
            border-color: rgba(var(--accent-400), 0.5);
        }

        .dark .project-block .tree-item-content:not(.selected):hover {
            background-color: rgba(51, 65, 85, 0.5);
        }

        /* -------------------------------------------------- */
        /* WCAG AA - Modals & Overlays / Okna Modalne i Nakładki
        /* -------------------------------------------------- */

        /* Modal overlays - Better visibility */
        .dark .bg-black { background-color: rgba(0, 0, 0, 0.8); } /* Darker overlay */
        .dark .bg-opacity-50 { --tw-bg-opacity: 0.7; } /* Increase opacity for better backdrop */

        /* Modal content boxes */
        .dark .bg-slate-800 { background-color: #1e293b; } /* Already defined but ensuring consistency */

        /* Modal text */
        .dark #modal-title { color: #f1f5f9; } /* slate-100 */
        .dark #modal-text { color: #cbd5e1; } /* slate-300 */

        /* -------------------------------------------------- */
        /* WCAG AA - Favorites Cards / Karty Ulubionych
        /* -------------------------------------------------- */

        /* Favorites chips/cards - Enhanced for dark mode */
        .dark .from-white\/95 { background: rgba(30, 41, 59, 0.95); }
        .dark .via-violet-50 { background: rgba(109, 40, 217, 0.1); }
        .dark .to-purple-50 { background: rgba(147, 51, 234, 0.1); }
        .dark .from-slate-700 { background: rgba(51, 65, 85, 1); }
        .dark .to-slate-600\/90 { background: rgba(71, 85, 105, 0.9); }
        .dark .border-white\/60 { border-color: rgba(100, 116, 139, 0.4); }
        .dark .border-slate-500\/80 { border-color: rgba(100, 116, 139, 0.6); }
        .dark .hover\:border-violet-300:hover { border-color: rgba(196, 181, 253, 0.6); }
        .dark .hover\:border-violet-500:hover { border-color: rgba(139, 92, 246, 0.8); }

        /* Remove favorite button */
        .dark .bg-slate-200\/80 { background-color: rgba(71, 85, 105, 0.6); }
        .dark .bg-slate-700\/80 { background-color: rgba(51, 65, 85, 0.8); }

        /* -------------------------------------------------- */
        /* WCAG AA - Right Panel & Editor Area / Panel Prawy i Obszar Edytora
        /* -------------------------------------------------- */

        .dark .bg-white\/95 { background-color: rgba(30, 41, 59, 0.95); }
        .dark .bg-slate-900\/95 { background-color: rgba(15, 23, 42, 0.95); }
        .dark .border-slate-200\/60 { border-color: rgba(100, 116, 139, 0.4); }
        .dark .border-slate-700\/60 { border-color: rgba(71, 85, 105, 0.6); }

        /* -------------------------------------------------- */
        /* WCAG AA - Placeholder & Empty States / Stany Puste i Placeholder
        /* -------------------------------------------------- */

        .dark .from-accent-100 { background: rgba(var(--accent-900), 0.3); }
        .dark .to-accent-200 { background: rgba(var(--accent-800), 0.3); }
        .dark .from-accent-900\/30 { background: rgba(var(--accent-900), 0.4); }
        .dark .to-accent-800\/30 { background: rgba(var(--accent-800), 0.4); }

        /* -------------------------------------------------- */
        /* WCAG AA - Icon Containers / Kontenery Ikon
        /* -------------------------------------------------- */

        .dark .from-violet-500 { background: linear-gradient(to bottom right, #8b5cf6, #7c3aed); }
        .dark .via-purple-600 { background: #9333ea; }
        .dark .to-indigo-600 { background: #4f46e5; }

        /* -------------------------------------------------- */
        /* WCAG AA - Accent Color Enhancements / Wzmocnienia Koloru Akcentowego
        /* -------------------------------------------------- */

        /* Ensure accent colors are visible in dark mode */
        .dark .text-accent-500 { color: rgba(var(--accent-400), 1); }
        .dark .text-accent-600 { color: rgba(var(--accent-300), 1); }
        .dark .text-accent-800 { color: rgba(var(--accent-200), 1); }

        .dark .bg-accent-50 { background-color: rgba(var(--accent-950), 0.4); }
        .dark .bg-accent-100 { background-color: rgba(var(--accent-900), 0.5); }

        /* -------------------------------------------------- */
        /* WCAG AA - Final Polish: Tree, Info Box, Preview / Finalne Poprawki
        /* -------------------------------------------------- */

        /* ================================================== */
        /* LEFT SIDEBAR - DARK MODE - REWRITTEN FROM SCRATCH
        /* ================================================== */
        /* Ultra-simple, high-contrast design */

        /* CONTAINER: Very light gray background */
        .dark #left-sidebar > div.bg-white,
        .dark #left-sidebar div.bg-white {
            background-color: #64748b !important; /* slate-500 - VERY LIGHT */
            border: 3px solid #94a3b8 !important; /* slate-400 - THICK VISIBLE BORDER */
            box-shadow: 0 0 0 1px #cbd5e1, 0 20px 40px rgba(0,0,0,0.8) !important;
        }

        /* ALL TEXT IN SIDEBAR: Graphite for elegant contrast */
        .dark #left-sidebar,
        .dark #left-sidebar *,
        .dark #left-sidebar span,
        .dark #left-sidebar .tree-item-name {
            color: #0f172a !important; /* slate-950 - graphite/charcoal */
        }

        /* Search input & dropdown */
        .dark #left-sidebar input,
        .dark #left-sidebar select,
        .dark #left-sidebar input[type="text"],
        .dark #left-sidebar select#sort-mode {
            background-color: #334155 !important; /* slate-700 - darker than container */
            color: #0f172a !important; /* graphite text */
            border: 2px solid #475569 !important;
        }
        .dark #left-sidebar input::placeholder {
            color: #475569 !important; /* darker placeholder */
        }

        /* Icons - make them visible */
        .dark #left-sidebar svg {
            color: #334155 !important; /* darker icons */
        }

        /* Tree items */
        .dark #left-sidebar .tree-item-content {
            color: #0f172a !important; /* graphite */
            background-color: transparent !important;
        }
        .dark #left-sidebar .tree-item-content:hover {
            background-color: rgba(51, 65, 85, 0.5) !important; /* slate-700 semi-transparent */
        }
        .dark #left-sidebar .tree-item-content.selected {
            background-color: rgba(99, 102, 241, 0.3) !important; /* indigo with transparency */
            color: #0f172a !important; /* graphite */
        }

        /* Project and prompt names - CRITICAL */
        .dark #left-sidebar .tree-item-project .tree-item-name,
        .dark #left-sidebar .tree-item-prompt .tree-item-name {
            color: #0f172a !important; /* slate-950 - graphite */
            font-weight: 600 !important;
        }

        /* Action buttons */
        .dark #left-sidebar .tree-actions button,
        .dark #left-sidebar button {
            color: #334155 !important; /* darker gray */
        }
        .dark #left-sidebar .tree-actions button:hover {
            color: #0f172a !important; /* graphite on hover */
        }

        /* Workspace buttons */
        .dark #left-sidebar .workspace-btn {
            background-color: #334155 !important;
            color: #0f172a !important; /* graphite text */
            border: 2px solid #475569 !important;
        }
        .dark #left-sidebar .workspace-btn.active {
            background-color: #6366f1 !important; /* indigo-500 */
            color: #ffffff !important; /* white for active button */
        }

        /* Borders */
        .dark #left-sidebar .border-slate-200,
        .dark #left-sidebar .border-slate-200\/60 {
            border-color: #64748b !important; /* slate-500 */
        }
        .dark #left-sidebar .project-block {
            border-color: #64748b !important;
        }

        /* "Dodatkowe informacje (kontekst)" section - Enhanced green colors */
        .dark .text-green-800 { color: #86efac; } /* green-300 - 6.8:1 contrast instead of green-200 */
        .dark .text-green-600 { color: #86efac; } /* green-300 - consistent */
        .dark .text-green-400 { color: #86efac; } /* green-300 - consistent */
        .dark .hover\:text-green-800:hover { color: #bbf7d0; } /* green-200 on hover - brighter */
        .dark .hover\:text-green-200:hover { color: #dcfce7; } /* green-100 on hover - even brighter */

        /* Green borders and placeholders */
        .dark .border-green-300 { border-color: rgba(134, 239, 172, 0.4); } /* green-300 with opacity */
        .dark .border-green-700 { border-color: rgba(21, 128, 61, 0.6); } /* green-700 with opacity */
        .dark .placeholder-green-500::placeholder { color: rgba(134, 239, 172, 0.5); } /* green-300 */
        .dark .placeholder-green-400::placeholder { color: rgba(134, 239, 172, 0.5); } /* green-300 */

        /* "Podgląd końcowego promptu" section - Enhanced */
        .dark #combined-output-preview {
            background-color: #0f172a; /* slate-950 - deeper for better contrast with content */
            border-color: rgba(100, 116, 139, 0.6); /* slate-500 - more visible border */
            color: #f1f5f9; /* slate-100 - ensure text is readable */
        }

        /* Preview placeholder text */
        .dark #combined-output-preview .text-slate-400 {
            color: #94a3b8; /* slate-400 - already good */
        }

        /* Copy buttons in preview section */
        .dark #copy-plain-text-btn {
            color: #cbd5e1; /* slate-300 */
            border-color: rgba(100, 116, 139, 0.5);
        }
        .dark #copy-plain-text-btn:hover {
            color: #f1f5f9; /* slate-100 on hover */
            background-color: rgba(51, 65, 85, 0.6); /* slate-700 */
        }

        /* Icons in preview description */
        .dark .text-purple-500 { color: #d8b4fe; } /* purple-300 */
        .dark .text-blue-500 { color: #93c5fd; } /* blue-300 */
        .dark .text-green-500 { color: #86efac; } /* green-300 */

        /* Keyboard shortcuts badges */
        .dark .kbd {
            background-color: rgba(71, 85, 105, 0.8); /* slate-600 */
            color: #f1f5f9; /* slate-100 */
            border-color: rgba(100, 116, 139, 0.6);
        }

        /* -------------------------------------------------- */
        /* 9. Layout & Responsive Styles / Układ i Style Responsywne
        /* -------------------------------------------------- */
        .favorites-wrapper { position: relative; }
        .favorites-fade {
            position: absolute; top: 0; bottom: 0; width: 40px; pointer-events: none; z-index: 1;
        }
        .favorites-fade-left { left: 0; background: linear-gradient(to right, rgba(248, 250, 252, 0.95), transparent); }
.favorites-fade-right { right: 0; background: linear-gradient(to left, rgba(248, 250, 252, 0.95), transparent); }
.dark .favorites-fade-left { background: linear-gradient(to right, rgba(15, 23, 42, 0.95), transparent); }
.dark .favorites-fade-right { background: linear-gradient(to left, rgba(15, 23, 42, 0.95), transparent); }

/* Modern color picker */
.color-picker-panel {
    position: absolute;
    top: 100%;
    left: 0;
    margin-top: 8px;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(16px);
    border: 1px solid rgba(226, 232, 240, 0.6);
    border-radius: 16px;
    padding: 16px;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
    z-index: 1000;
    display: none;
    grid-template-columns: repeat(4, 1fr);
    gap: 8px;
    width: 160px;
}

.dark .color-picker-panel {
    background: rgba(15, 23, 42, 0.98);
    border: 1px solid rgba(100, 116, 139, 0.6);
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.6), 0 0 0 1px rgba(148, 163, 184, 0.1);
}

.dark .color-option {
    border: 2px solid rgba(148, 163, 184, 0.4);
}

.dark .color-option:hover {
    border-color: rgba(148, 163, 184, 0.8);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
}

.color-option {
    width: 24px;
    height: 24px;
    border-radius: 8px;
    cursor: pointer;
    border: 2px solid rgba(255, 255, 255, 0.8);
    transition: all 0.2s ease;
    position: relative;
}

.color-option:hover {
    transform: scale(1.2);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.color-option.selected::after {
    content: '✓';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: white;
    font-size: 12px;
    font-weight: bold;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
}

/* Smooth expand/collapse animation */
.prompt-list {
    overflow: hidden;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.prompt-list.collapsing {
    max-height: 0;
    opacity: 0;
    transform: translateY(-10px);
}

.prompt-list.expanding {
    animation: expandList 0.3s cubic-bezier(0.4, 0, 0.2, 1) forwards;
}

@keyframes expandList {
    0% {
        max-height: 0;
        opacity: 0;
        transform: translateY(-10px);
    }
    100% {
        max-height: 1000px;
        opacity: 1;
        transform: translateY(0);
    }
}

.tree-item-prompt {
    transition: all 0.2s ease;
    transform-origin: top;
}

.tree-item-prompt.slide-in {
    animation: slideInPrompt 0.3s ease-out backwards;
}

@keyframes slideInPrompt {
    0% {
        opacity: 0;
        transform: translateX(-15px) scale(0.95);
    }
    100% {
        opacity: 1;
        transform: translateX(0) scale(1);
    }
}

@media (min-width: 1024px) {
    main {
        /* Ustawiamy wysokość głównego kontenera, aby wypełnił resztę ekranu */
        height: calc(100vh - var(--sidebar-top));
    }
    #left-sidebar, #right-panel {
     /* Obie kolumny będą miały tę samą, pełną wysokość */
    height: 100%;
}
}
        
        /* -------------------------------------------------- */
        /* 10. Modals, Toasts & Tooltips / Okna Modalne, Powiadomienia i Podpowiedzi
        /* -------------------------------------------------- */
        #toast-notification {
            position: fixed; bottom: 1.5rem; left: 50%; display: none;
            transform: translate(-50%, 200%); transition: transform 0.3s ease-in-out; z-index: 1000;
        }
        #toast-notification.show {
            display: block; transform: translate(-50%, 0);
        }

        #global-tooltip {
            position: fixed; background-color: #1e293b; color: white;
            padding: 4px 8px; border-radius: 4px; font-size: 0.75rem;
            pointer-events: none; z-index: 2000; opacity: 0; transition: opacity 0.2s;
        }
        .dark #global-tooltip {
            background-color: #0f172a; /* slate-950 - deeper for better contrast */
            color: #f1f5f9; /* slate-100 - high contrast white */
            border: 1px solid rgba(100, 116, 139, 0.4);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.6);
        }
        
        #color-palette { position: relative; }
        #color-options {
            display: none; position: absolute; top: 100%; right: 0;
            margin-top: 8px; background-color: white; border-radius: 0.5rem;
            padding: 0.5rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            z-index: 100;
        }
        .dark #color-options { background-color: #1e293b; }
        .color-swatch {
            width: 24px; height: 24px; border-radius: 50%; cursor: pointer;
            border: 2px solid transparent;
        }
        .color-swatch.selected { border-color: #64748b; }
        .dark .color-swatch.selected { border-color: white; }

        /* -------------------------------------------------- */
        /* 11. Animations / Animacje
        /* -------------------------------------------------- */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }

/* -------------------------------------------------- */
/* 12. Adaptive Workspace / Adaptacyjna Przestrzeń Robocza */
/* -------------------------------------------------- */

/* Resize Handle */
.resize-handle {
    position: absolute;
    top: 50%;
    right: 0;
    width: 20px;
    height: 40px;
    background-color: white;
    border: 1px solid #e2e8f0;
    border-radius: 9999px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    cursor: col-resize;
    z-index: 10;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #94a3b8;
    transition: all 0.2s ease-in-out;
    transform: translate(50%, -50%);
}

.resize-handle:hover {
    color: rgba(var(--accent-600), 1);
    box-shadow: 0 0 0 4px rgba(var(--accent-500), 0.1);
    transform: translate(50%, -50%) scale(1.1);
}

/* Dodatkowy hint dla użytkownika */
.resize-handle:hover::before {
    animation: resize-pulse 2s infinite ease-in-out;
}

@keyframes resize-pulse {
    0%, 100% { 
        box-shadow: 0 0 16px rgba(var(--accent-500), 0.4);
    }
    50% { 
        box-shadow: 0 0 24px rgba(var(--accent-500), 0.6);
    }
}

/* Permanent resize indicator */
.resize-indicator {
    position: absolute;
    top: 50%;
    right: -1px;
    width: 2px;
    height: 40px;
    background: linear-gradient(180deg, 
        transparent,
        rgba(var(--accent-500), 0.3) 30%,
        rgba(var(--accent-600), 0.5) 50%,
        rgba(var(--accent-500), 0.3) 70%,
        transparent);
    border-radius: 2px;
    transform: translateY(-50%);
    z-index: 5;
    transition: all 0.3s ease;
}

.resize-indicator::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 8px;
    height: 8px;
    background: rgba(var(--accent-500), 0.6);
    border-radius: 50%;
    box-shadow: 0 0 6px rgba(var(--accent-500), 0.4);
}

#left-sidebar:hover .resize-indicator {
    background: linear-gradient(180deg, 
        transparent,
        rgba(var(--accent-400), 0.5) 30%,
        rgba(var(--accent-500), 0.8) 50%,
        rgba(var(--accent-400), 0.5) 70%,
        transparent);
}

#left-sidebar:hover .resize-indicator::before {
    background: rgba(var(--accent-400), 0.9);
    box-shadow: 0 0 10px rgba(var(--accent-500), 0.6);
}

@media (max-width: 1024px) {
    .resize-indicator {
        display: none;
    }
}

/* Focus Mode */
#left-sidebar.collapsed {
    width: 0 !important;
    min-width: 0 !important;
    opacity: 0;
    pointer-events: none;
    margin-right: 0;
}

#left-sidebar.transitioning {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

#right-panel.expanded {
    width: 100% !important;
}

#right-panel.transitioning {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Focus Mode Toggle Button */
.focus-mode-toggle {
    position: fixed;
    left: 1rem;
    bottom: 1rem;
    z-index: 100;
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background: rgba(var(--accent-500), 1);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 12px rgba(var(--accent-500), 0.3);
    cursor: pointer;
    transition: all 0.3s;
    opacity: 0;
    transform: translateX(-100px);
}

.focus-mode-toggle.visible {
    opacity: 1;
    transform: translateX(0);
}

.focus-mode-toggle:hover {
    box-shadow: 0 6px 20px rgba(var(--accent-500), 0.4);
    transform: scale(1.1);
}

/* Breadcrumb Navigation */
.breadcrumb-nav {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 1rem 1.5rem;
    background: rgba(248, 250, 252, 0.8);
    border-bottom: 1px solid rgba(226, 232, 240, 0.6);
    backdrop-filter: blur(12px);
    position: sticky;
    top: 0;
    z-index: 5;
    transition: all 0.3s ease;
}

.dark .breadcrumb-nav {
    background: rgba(15, 23, 42, 0.95);
    border-bottom: 1px solid rgba(100, 116, 139, 0.3);
}

.breadcrumb-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    color: rgba(51, 65, 85, 0.9);
    font-size: 0.875rem;
    transition: all 0.2s ease;
    padding: 0.375rem 0.75rem;
    border-radius: 0.75rem;
}

.dark .breadcrumb-item {
    color: rgba(241, 245, 249, 0.95); /* Enhanced contrast - slate-100 */
}

.breadcrumb-item.clickable {
    cursor: pointer;
}

.breadcrumb-item.clickable:hover {
    background: rgba(248, 250, 252, 0.8);
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
}

.dark .breadcrumb-item.clickable:hover {
    background: rgba(51, 65, 85, 0.6); /* slate-700 */
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
}

.breadcrumb-current {
    background: rgba(var(--accent-50), 0.8);
    color: rgba(var(--accent-800), 1);
}

.dark .breadcrumb-current {
    background: rgba(var(--accent-950), 0.6);
    color: rgba(var(--accent-200), 1); /* High contrast accent */
}

/* Workspace Controls */
.workspace-btn {
    width: 36px;
    height: 32px;
    border-radius: 0.5rem;
    background: #f1f5f9; /* slate-100 */
    color: #475569; /* slate-600 */
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s;
    border: 1px solid #e2e8f0; /* slate-200 */
    font-size: 0.75rem;
    font-weight: 600;
}

.workspace-btn:hover {
    background-color: rgba(var(--accent-500), 1);
    color: white;
    border-color: transparent;
    transform: scale(1.1);
}

.workspace-btn.active {
    background-color: rgba(var(--accent-600), 1);
    color: white;
    border-color: transparent;
}

/* Smooth Transitions */
.layout-transitioning * {
    pointer-events: none;
}

/* Minimum widths */
#left-sidebar {
    min-width: 280px;
    max-width: 75%; /* Zwiększamy max, aby pozwolić na układ 2:1 */
    transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Responsive adjustments */
@media (max-width: 1024px) {
    .resize-handle {
        display: none;
    }
    
    .workspace-controls {
        display: none;
    }
}

/* -------------------------------------------------- */
/* 12. Modern Design System (Glassmorphism & Animations) */
/* -------------------------------------------------- */

/* Glassmorphism Effects */
.glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.05), 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .dark .glass-panel {
            background: rgba(15, 23, 42, 0.98);
            border: 1px solid rgba(100, 116, 139, 0.5);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4), 0 1px 3px rgba(0, 0, 0, 0.6);
        }

/* Floating Elements with Enhanced Shadows */
.floating-shadow {
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 
                0 10px 10px -5px rgba(0, 0, 0, 0.04),
                0 0 0 1px rgba(0, 0, 0, 0.05);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.floating-shadow:hover {
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15),
                0 15px 20px -5px rgba(0, 0, 0, 0.08),
                0 0 0 1px rgba(0, 0, 0, 0.05);
    transform: translateY(-2px);
}

.dark .floating-shadow {
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.4), 
                0 10px 10px -5px rgba(0, 0, 0, 0.2);
}

.dark .floating-shadow:hover {
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.6),
                0 15px 20px -5px rgba(0, 0, 0, 0.3);
}

/* Micro Animations */
@keyframes pulse-glow {
    0%, 100% { 
        box-shadow: 0 0 0 0 rgba(var(--accent-500), 0.7);
        transform: scale(1);
    }
    50% { 
        box-shadow: 0 0 0 10px rgba(var(--accent-500), 0);
        transform: scale(1.02);
    }
}

@keyframes slide-in-up {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes slide-in-right {
    from {
        opacity: 0;
        transform: translateX(20px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

@keyframes pulse-attention {
    0%, 100% { 
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(22, 163, 74, 0.7);
    }
    50% { 
        transform: scale(1.05);
        box-shadow: 0 0 0 12px rgba(22, 163, 74, 0);
    }
}
.copy-pulse {
    animation: pulse-attention 2s infinite;
}

/* Button Enhancements */
.btn-modern {
    position: relative;
    overflow: hidden;
    backdrop-filter: blur(10px);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.btn-modern::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transition: left 0.5s;
}

.btn-modern:hover::before {
    left: 100%;
}

.btn-modern:hover {
    transform: translateY(-1px);
    box-shadow: 0 10px 25px rgba(var(--accent-500), 0.3);
}

/* Gradient Backgrounds */
.gradient-bg {
    background: linear-gradient(135deg, 
        rgba(var(--accent-50), 1) 0%,
        rgba(var(--accent-100), 0.8) 50%,
        rgba(var(--accent-200), 0.6) 100%);
}

.dark .gradient-bg {
    background: linear-gradient(135deg, 
        rgba(var(--accent-950), 0.8) 0%,
        rgba(var(--accent-900), 0.6) 50%,
        rgba(var(--accent-800), 0.4) 100%);
}

/* Interactive Elements */
.interactive-card {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    cursor: pointer;
}

.interactive-card:hover {
    transform: scale(1.02) translateY(-2px);
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
}

/* Particle Effects for Drag & Drop */
.drag-particles {
    position: relative;
}

.drag-particles::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: radial-gradient(circle at 50% 50%, 
        rgba(var(--accent-500), 0.1) 0%,
        rgba(var(--accent-500), 0.05) 40%,
        transparent 70%);
    opacity: 0;
    animation: pulse-glow 2s infinite;
    pointer-events: none;
}

.dragging.drag-particles::before {
    opacity: 1;
}

/* Liquid Transitions */
.liquid-transition {
    transition: all 0.6s cubic-bezier(0.23, 1, 0.32, 1);
}

.liquid-morph {
    animation: liquid-morph 4s ease-in-out infinite;
}

/* Enhanced Input Fields */
.input-modern {
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(0,0,0,0.08);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.input-modern:focus {
    background: rgba(255, 255, 255, 0.95);
    border-color: rgba(var(--accent-500), 0.5);
    box-shadow: 0 0 0 4px rgba(var(--accent-500), 0.1);
    transform: scale(1.01);
}

.dark .input-modern {
    background: rgba(30, 41, 59, 0.9);
    border: 1px solid rgba(100, 116, 139, 0.4);
    color: #f1f5f9; /* slate-100 - high contrast */
}

.dark .input-modern::placeholder {
    color: rgba(148, 163, 184, 0.6); /* slate-400 */
}

.dark .input-modern:focus {
    background: rgba(30, 41, 59, 0.95);
    border-color: rgba(var(--accent-400), 0.6);
    box-shadow: 0 0 0 4px rgba(var(--accent-500), 0.15);
}

/* Animated Icons */
@keyframes rotate-slow {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

.icon-animated {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.icon-animated:hover {
    transform: scale(1.1) rotate(5deg);
    color: rgba(var(--accent-500), 1);
}

/* Progress Indicators */
.progress-glow {
    box-shadow: 0 0 20px rgba(var(--accent-500), 0.5);
    background: linear-gradient(45deg, 
        rgba(var(--accent-500), 1), 
        rgba(var(--accent-600), 1));
}

/* Staggered Animations */
.stagger-item:nth-child(1) { animation-delay: 0.1s; }
.stagger-item:nth-child(2) { animation-delay: 0.2s; }
.stagger-item:nth-child(3) { animation-delay: 0.3s; }
.stagger-item:nth-child(4) { animation-delay: 0.4s; }
.stagger-item:nth-child(5) { animation-delay: 0.5s; }

.slide-in-up { animation: slide-in-up 0.6s cubic-bezier(0.4, 0, 0.2, 1) forwards; }
.slide-in-right { animation: slide-in-right 0.6s cubic-bezier(0.4, 0, 0.2, 1) forwards; }

/* -------------------------------------------------- */
/* 12.5. Enhanced Left Sidebar Styling / Wzmocnione style lewego panelu */
/* -------------------------------------------------- */
/* Usunięto nadmiarowe style po przejściu na jasny motyw */


/* -------------------------------------------------- */
/* 12.6. Editor locked state / Stan zablokowanego edytora */
/* -------------------------------------------------- */
/* Editor locked state */
.editor-locked .ql-editor {
    opacity: 0.5;
}

/* -------------------------------------------------- */
/* 13. Tree View / Widok Drzewa (zróżnicowana typografia + większe wcięcia) */
/* -------------------------------------------------- */

/* Project block – tło pod CAŁYM projektem (projekt + jego prompty) */
.project-block {
    --project-bg: transparent;
    background: var(--project-bg);
    border-radius: 16px;
    padding: 8px;
    margin: 8px 0;
    transition: all 0.2s ease, transform 0.15s ease-out;
    border: 1px solid rgba(226, 232, 240, 0.6);
}

/* Styl dla projektu, który jest celem upuszczenia promptu */
.drop-target-project > .tree-item-content {
    border: 2px dashed rgba(var(--accent-500), 0.8) !important;
    background: linear-gradient(135deg, rgba(var(--accent-100), 0.6) 0%, rgba(var(--accent-200), 0.4) 100%) !important;
    transform: translateX(4px) scale(1.01) !important;
    box-shadow: 0 8px 24px rgba(var(--accent-500), 0.3) !important;
}

.dark .project-block {
  border-color: rgba(71, 85, 105, 0.4);
}

.project-block .tree-item-content:not(.selected):hover {
  background-color: rgba(255,255,255,0.6);
  transform: translateX(2px);
}
.dark .project-block .tree-item-content:not(.selected):hover {
  background-color: rgba(15,23,42,0.6);
}

.tree-item-content {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.75rem 1rem;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.2s ease;
    position: relative;
}

.tree-item-content.selected {
    background: linear-gradient(135deg, rgba(var(--accent-500), 0.15) 0%, rgba(var(--accent-600), 0.1) 100%);
    color: rgba(var(--accent-900), 1);
    font-weight: 600;
    border: 1px solid rgba(var(--accent-500), 0.2);
    box-shadow: 0 4px 12px rgba(var(--accent-500), 0.2);
    transform: translateX(8px) scale(1.01);
}

.dark .tree-item-content.selected {
    background: linear-gradient(135deg, rgba(var(--accent-600), 0.25) 0%, rgba(var(--accent-700), 0.2) 100%);
    color: rgba(var(--accent-100), 1);
    border-color: rgba(var(--accent-400), 0.4);
    box-shadow: 0 4px 12px rgba(var(--accent-500), 0.3);
}

.tree-item-content:not(.selected):hover {
    background-color: rgba(248, 250, 252, 0.8);
    transform: translateX(2px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
}
.dark .tree-item-content:not(.selected):hover {
    background-color: rgba(51, 65, 85, 0.6); /* slate-700 */
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
}

.tree-toggle {
    flex-shrink: 0;
    width: 1.5rem;
    height: 1.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    border-radius: 6px;
    background: rgba(148, 163, 184, 0.1);
}
.tree-toggle:hover {
    background: rgba(148, 163, 184, 0.2);
    transform: scale(1.1);
}
.tree-toggle.expanded {
    transform: rotate(90deg);
    background: rgba(var(--accent-500), 0.15);
}
.tree-item-details {
    display: flex;
    align-items: center;
    flex-grow: 1;
    min-width: 0;
    gap: 0.75rem;
}
.tree-item-name {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    letter-spacing: -0.01em;
}
.tree-actions {
    display: flex;
    align-items: center;
    gap: 0.25rem;
    opacity: 0;
    transition: all 0.2s ease;
    background: rgba(255, 255, 255, 0.9);
    padding: 0.25rem;
    border-radius: 8px;
    border: 1px solid rgba(226, 232, 240, 0.6);
    backdrop-filter: blur(8px);
}
.dark .tree-actions {
    background: rgba(15, 23, 42, 0.9);
    border-color: rgba(71, 85, 105, 0.4);
}
.tree-item-content:hover .tree-actions,
.tree-item-content.selected .tree-actions {
    opacity: 1;
    transform: translateX(-2px);
}
.drag-handle {
    opacity: 0;
    transition: all 0.2s ease;
    padding: 0.25rem;
    border-radius: 6px;
}
.drag-handle:hover {
    background: rgba(148, 163, 184, 0.15);
}
.tree-item-content:hover .drag-handle {
    opacity: 0.6;
}

/* – różnicowanie projektów i promptów – */
/* Projekt: większy rozmiar i mocne pogrubienie */
.tree-item-project .tree-item-name {
    font-weight: 700;
    font-size: 1.1rem;
    color: #0f172a;
    letter-spacing: -0.02em;
}
.dark .tree-item-project .tree-item-name { color: #f1f5f9 !important; } /* slate-100 - bright white for maximum contrast */

/* Prompt: mniejszy rozmiar i normalna waga */
.tree-item-prompt .tree-item-name {
    font-weight: 500;
    font-size: 0.95rem;
    color: #475569;
    letter-spacing: -0.01em;
}
.dark .tree-item-prompt .tree-item-name { color: #e2e8f0 !important; } /* slate-200 - very bright for high contrast */

@keyframes newProjectPulse {
    0% { 
        transform: scale(0.95);
        opacity: 0;
        box-shadow: 0 0 0 0 rgba(var(--accent-500), 0.7);
    }
    50% {
        transform: scale(1.02);
        box-shadow: 0 0 0 8px rgba(var(--accent-500), 0);
    }
    100% { 
        transform: scale(1);
        opacity: 1;
        box-shadow: 0 0 0 0 rgba(var(--accent-500), 0);
    }
}

.new-project-animation {
    animation: newProjectPulse 0.6s ease-out;
}



@keyframes slideInFromLeft {
    0% {
        opacity: 0;
        transform: translateX(-20px);
    }
    100% {
        opacity: 1;
        transform: translateX(0);
    }
}

.tree-item-content {
    position: relative;
    overflow: hidden;
}

.tree-item-content::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
    transition: left 0.5s;
}

.tree-item-content:hover::before {
    left: 100%;
}

.tree-item-project {
    margin-bottom: 0.5rem;
}

.tree-item-prompt {
    margin-bottom: 0.25rem;
}

/* większe wcięcie listy promptów względem projektu */
.prompt-list {
    padding-left: 3rem;
    position: relative;
    margin-top: 0.5rem;
}

.prompt-list::before {
    content: '';
    position: absolute;
    left: 1.5rem;
    top: 0;
    bottom: 0;
    width: 1px;
    background: linear-gradient(to bottom, rgba(var(--accent-500), 0.3), transparent);
}

/* — wcięcia i linie prowadzące — */
#tree-view-list { padding-left: 0; }

/* większe wcięcie listy promptów względem projektu */
.prompt-list {
    padding-left: 2.5rem;     /* było 2rem – zwiększamy odstęp */
    position: relative;
}

#tree-view-list li { position: relative; }

/* Pionowy pasek koloru projektu */
.project-color-bar {
    width: 4px;
    height: 24px;
    border-radius: 4px;
    flex-shrink: 0;
    transition: all 0.2s ease-out;
}
.project-color-bar:hover {
    transform: scale(1.2);
}


.kbd {
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    border: 1px solid #e2e8f0;
    border-radius: 6px;
    padding: 0.25rem 0.5rem;
    font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
    font-size: 0.75rem;
    font-weight: 600;
    color: #475569;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 1.5rem;
    height: 1.5rem;
}
.dark .kbd {
    background: linear-gradient(135deg, #334155 0%, #1e293b 100%);
    border-color: #475569;
    color: #cbd5e1;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
}

/* === FINAL OVERRIDES (kropki i gałązki) === */
:root{ --tree-line-thickness: 2px; }

/* kropki: projekt i prompty = ten sam, mocny kolor */
.project-block .tree-item-prompt .color-dot,
.project-block .tree-item-project .color-dot{
  background-color: var(--dot-strong, #64748b) !important;
border-color: color-mix(in srgb, var(--dot-strong, #64748b) 40%, rgba(0,0,0,0.25)) !important;
}


/* podświetlenie w obrębie projektu */
.project-block .tree-item-content.selected{
  background-color: var(--highlight, color-mix(in srgb, var(--project-bg, #ffffff) 30%, #ffffff)) !important;
  color:#0f172a !important;
}
.dark .project-block .tree-item-content.selected{
  color:#f8fafc !important;
}
</style>
	
</head>

<body class="bg-slate-100 text-slate-800 transition-colors duration-300">

    <div id="app" class="flex flex-col h-screen min-h-0">
        <!-- SECTION: Header / Nagłówek -->
        <header id="main-header" class="bg-slate-800 p-6 flex justify-between items-center z-40 sticky top-0">
            <div class="flex-1">
                <h1 class="text-2xl font-semibold text-slate-100 tracking-tight">Prompt <span class="text-accent-500 font-medium">Panel</span></h1>
            </div>
            <div class="flex items-center gap-2 md:gap-4 flex-wrap justify-end">
                <button id="dark-mode-toggle" class="p-2 rounded-full text-slate-400 hover:bg-slate-700 flex-shrink-0" title="Przełącz tryb ciemny">
    <svg id="dark-mode-icon-sun" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
    </svg>
    <svg id="dark-mode-icon-moon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
    </svg>
</button>
                <button id="global-search-btn" class="p-2 rounded-full text-slate-400 hover:bg-slate-700 flex-shrink-0 flex items-center gap-2 group">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" /></svg>
    <div class="hidden group-hover:flex items-center gap-1 bg-slate-600 px-2 py-1 rounded">
        <span class="kbd text-xs">Alt</span><span class="kbd text-xs">S</span>
    </div>
</button>
                <button id="manage-snippets-btn" class="bg-gradient-to-br from-purple-500 to-purple-600 hover:from-purple-600 hover:to-purple-700 text-white font-medium py-2.5 px-5 rounded-xl transition-all duration-200 flex-shrink-0 whitespace-nowrap shadow-sm hover:shadow-md transform hover:scale-[1.02]">Snippety</button>
                <button id="import-btn" class="bg-gradient-to-br from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-medium py-2.5 px-5 rounded-xl transition-all duration-200 flex-shrink-0 whitespace-nowrap shadow-sm hover:shadow-md transform hover:scale-[1.02]">Import</button>
                <input type="file" id="import-file" class="hidden" accept=".json">
                <button id="export-btn" class="bg-gradient-to-br from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-medium py-2.5 px-5 rounded-xl transition-all duration-200 flex-shrink-0 whitespace-nowrap shadow-sm hover:shadow-md transform hover:scale-[1.02]">Eksport</button>
                <!-- Typography Controls -->
<div class="relative" id="typography-controls-wrapper">
    <button id="typography-btn" data-tooltip="Ustawienia typografii" class="bg-slate-700 hover:bg-slate-600 text-slate-300 font-medium py-2.5 px-5 rounded-xl transition-all duration-200 flex-shrink-0 whitespace-nowrap shadow-sm hover:shadow-md transform hover:scale-[1.02]">Typografia</button>
    
    <div id="typography-popover" class="hidden absolute top-full right-0 mt-2 w-72 bg-slate-800 border border-slate-700 rounded-xl shadow-lg p-4 z-50">
        <div class="flex items-center justify-between mb-4">
            <label for="font-family-select" class="text-sm font-medium text-slate-300">Krój czcionki</label>
            <select id="font-family-select" class="bg-slate-700 text-slate-200 text-sm rounded-md px-2 py-1 border-0 focus:outline-none focus:ring-2 focus:ring-accent-500/50 w-40">
                <option value="'Inter', sans-serif">Inter</option>
                <option value="'Lora', serif">Lora</option>
                <option value="'Merriweather', serif">Merriweather</option>
                <option value="'Noto Serif', serif">Noto Serif</option>
                <option value="'Hanken Grotesk', sans-serif">Hanken Grotesk</option>
                <option value="'Space Grotesk', sans-serif">Space Grotesk</option>
                <option value="'Roboto Mono', monospace">Roboto Mono</option>
                <option value="'Source Code Pro', monospace">Source Code Pro</option>
            </select>
        </div>
        <div class="flex items-center justify-between mb-4">
            <label class="text-sm font-medium text-slate-300">Rozmiar czcionki</label>
            <div class="flex items-center gap-2">
                <button id="font-size-down-btn" class="p-1 rounded-full text-slate-400 hover:bg-slate-600 w-8 h-8 flex items-center justify-center font-bold">-</button>
                <span class="text-sm w-10 text-center text-slate-300" id="font-size-display">1.0</span>
                <button id="font-size-up-btn" class="p-1 rounded-full text-slate-400 hover:bg-slate-600 w-8 h-8 flex items-center justify-center font-bold">+</button>
            </div>
        </div>
        <div class="flex items-center justify-between mb-4">
            <label class="text-sm font-medium text-slate-300">Interlinia</label>
            <div class="flex items-center gap-2">
                <button id="line-height-down-btn" class="p-1 rounded-full text-slate-400 hover:bg-slate-600 w-8 h-8 flex items-center justify-center font-bold">-</button>
                <span class="text-sm w-10 text-center text-slate-300" id="line-height-display">1.5</span>
                <button id="line-height-up-btn" class="p-1 rounded-full text-slate-400 hover:bg-slate-600 w-8 h-8 flex items-center justify-center font-bold">+</button>
            </div>
        </div>
        <div class="flex items-center justify-between">
            <label class="text-sm font-medium text-slate-300">Odstęp akapitów</label>
            <div class="flex items-center gap-2">
                <button id="paragraph-spacing-down-btn" class="p-1 rounded-full text-slate-400 hover:bg-slate-600 w-8 h-8 flex items-center justify-center font-bold">-</button>
                <span class="text-sm w-10 text-center text-slate-300" id="paragraph-spacing-display">1.0</span>
                <button id="paragraph-spacing-up-btn" class="p-1 rounded-full text-slate-400 hover:bg-slate-600 w-8 h-8 flex items-center justify-center font-bold">+</button>
            </div>
        </div>
    </div>
</div>
                <!-- Theme/Color Controls -->
                
            </div>
        </header>
        
        <!-- SECTION: Favorites Bar / Pasek Ulubionych -->
        <div id="favorites-bar" class="bg-gradient-to-r from-indigo-200 via-purple-200 to-indigo-200 border-b border-slate-300/80 px-6 py-4 hidden fixed inset-x-0 z-20 backdrop-blur-xl">            <div class="favorites-wrapper group relative flex items-center">
                <button id="fav-left" class="absolute left-2 top-1/2 -translate-y-1/2 z-20 w-8 h-8 bg-white/95 dark:bg-slate-800/95 hover:bg-white dark:hover:bg-slate-700 backdrop-blur-sm rounded-xl shadow-lg text-slate-600 dark:text-slate-300 opacity-0 group-hover:opacity-100 transition-all duration-200 flex items-center justify-center border border-slate-200/60 dark:border-slate-700/60 hover:scale-105 hidden">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" /></svg>
                </button>
                <div class="favorites-fade favorites-fade-left"></div>
                <div id="favorites-container" class="flex items-center gap-3 overflow-x-auto py-2 px-8" style="scroll-behavior: smooth; scrollbar-width: none; -ms-overflow-style: none;"></div>
                <div class="favorites-fade favorites-fade-right"></div>
                <button id="fav-right" class="absolute right-2 top-1/2 -translate-y-1/2 z-20 w-8 h-8 bg-white/95 dark:bg-slate-800/95 hover:bg-white dark:hover:bg-slate-700 backdrop-blur-sm rounded-xl shadow-lg text-slate-600 dark:text-slate-300 opacity-0 group-hover:opacity-100 transition-all duration-200 flex items-center justify-center border border-slate-200/60 dark:border-slate-700/60 hover:scale-105 hidden">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" /></svg>
                </button>
            </div>
        </div>

        <!-- SECTION: Main Content / Główna Zawartość -->
         <!-- Global Search Modal -->
<div id="search-modal" class="fixed inset-0 z-[60] hidden">
  <div class="absolute inset-0 bg-black/50"></div>
  <div class="relative mx-auto mt-20 w-[min(900px,92vw)] rounded-xl bg-white dark:bg-slate-800 shadow-xl p-5">
    <div class="flex items-center justify-between mb-3">
      <h3 class="text-lg font-bold">Wyszukaj w promptach</h3>
      <button id="close-search-modal-btn" class="p-2 text-slate-500 hover:text-slate-800 dark:hover:text-white" aria-label="Zamknij">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>

    <input id="global-search-input" type="text"
           placeholder="Szukaj po nazwach, treści wersji i kontekście (min. 2 znaki)"
           class="w-full p-3 input-modern rounded-2xl dark:bg-slate-700 dark:border-slate-600" />

    <div id="global-results-container" class="mt-4 max-h-[60vh] overflow-y-auto custom-scrollbar space-y-2">
      <div class="text-center text-slate-500">Wpisz co najmniej 2 znaki, aby rozpocząć wyszukiwanie.</div>
    </div>
  </div>
</div>

<main class="flex-grow flex flex-col lg:flex-row px-4 pb-4 gap-4 min-h-0">
            <!-- SECTION: Left Sidebar / Lewy Panel Boczny -->
            <div id="left-sidebar" class="w-full lg:w-1/3 flex flex-col gap-4 transition-all duration-300" style="position: relative;">
<div class="bg-white rounded-2xl flex flex-col h-full p-6 border border-slate-200/80 shadow-lg shadow-slate-900/5">
                        <div class="flex justify-between items-center mb-4 flex-wrap gap-3">
    <div class="flex items-center gap-3">
<select id="sort-mode" data-tooltip="Tryb sortowania" class="bg-slate-100 text-slate-800 text-sm border border-slate-300 rounded-lg px-3 py-1.5 focus:outline-none focus:ring-2 focus:ring-accent-500/30 cursor-pointer">
    <option value="manual">Własne</option>
    <option value="alpha_asc">Nazwa (A-Z)</option>
    <option value="alpha_desc">Nazwa (Z-A)</option>
    <option value="newest">Od najnowszych</option>
    <option value="oldest">Od najstarszych</option>
    <option value="updated">Ostatnio modyfikowane</option>
    <option value="color">Kolorami</option>
</select>
    </div>
    <button id="add-project-btn" class="bg-gradient-to-br from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-medium py-2.5 px-4 rounded-xl flex items-center gap-2 shadow-sm hover:shadow-md transition-all duration-200 transform hover:scale-[1.02]">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>
        <span class="text-sm">Nowy projekt</span>
        <div class="flex items-center gap-1 ml-1">
            <span class="kbd text-xs">Alt</span><span class="kbd text-xs">N</span>
        </div>
    </button>
</div>
                    <div class="relative mb-4">
<input type="text" id="tree-search" placeholder="Szukaj projektów..." class="w-full pl-10 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-accent-500/30 focus:border-accent-500/50 transition-all duration-200 placeholder-slate-400">                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 dark:text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                    </div>
                    <ul id="tree-view-list" class="flex-grow overflow-y-auto overflow-x-hidden custom-scrollbar pr-1"></ul>
                    <div id="workspace-controls" class="mt-auto pt-4 flex items-center justify-center gap-2 border-t border-slate-200/60">
    <button class="workspace-btn active" data-layout="1:3" data-tooltip="Układ 1:3">25%</button>
    <button class="workspace-btn" data-layout="1:2" data-tooltip="Układ 1:2">33%</button>
    <button class="workspace-btn" data-layout="1:1" data-tooltip="Układ 1:1">50%</button>
    <div class="relative group">
        <button class="workspace-btn" id="toggle-sidebar-btn" data-tooltip="Tryb skupienia">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
            </svg>
        </button>
        <div class="absolute -top-8 left-1/2 transform -translate-x-1/2 hidden group-hover:flex items-center gap-1 bg-slate-700 text-white px-2 py-1 rounded text-xs whitespace-nowrap">
            <span class="kbd text-xs">Ctrl</span><span class="kbd text-xs">\</span>
        </div>
    </div>
</div>
                </div>
                <!-- Resize Handle -->
                <div class="resize-handle" id="resize-handle" data-tooltip="Zmień szerokość panelu">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
        <path stroke-linecap="round" stroke-linejoin="round" d="M8 9l4-4 4 4m0 6l-4 4-4-4" />
    </svg>
</div>
                <!-- Permanent resize indicator -->
                <div class="resize-indicator"></div>
            </div>

            <!-- SECTION: Right Panel (Editor Area) / Prawy Panel (Obszar Edytora) -->
            
            <div id="right-panel" class="w-full flex-1 bg-white/95 backdrop-blur-xl border border-slate-200/60 dark:border-slate-700/60 rounded-2xl flex flex-col overflow-hidden shadow-xl shadow-slate-900/5 dark:bg-slate-900/95 dark:shadow-black/20">                
            <div id="project-overview" class="flex-grow p-6 hidden">
                <div class="mb-8">
                    <h2 class="text-2xl font-bold text-slate-900 dark:text-white tracking-tight mb-2" id="project-title">Przegląd projektu</h2>
                    <p class="text-slate-600 dark:text-slate-400" id="project-stats">Statystyki projektu</p>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="prompts-grid">
                    <!-- Prompts cards will be generated here -->
                </div>
            </div>
                <!-- Breadcrumb Navigation -->
<div class="breadcrumb-nav hidden" id="breadcrumb-nav">
    <div class="breadcrumb-item clickable" data-level="home">
        <div class="flex items-center justify-center w-6 h-6 rounded-lg bg-slate-100 dark:bg-slate-800">
            <svg class="breadcrumb-icon w-3.5 h-3.5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
            </svg>
        </div>
        <span class="font-medium">Wszystkie projekty</span>
    </div>
    <svg class="breadcrumb-separator w-4 h-4 text-slate-400" id="separator-1" style="display: none;" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
    <div class="breadcrumb-item clickable" id="breadcrumb-project" style="display: none;" data-level="project">
        <div class="flex items-center justify-center w-6 h-6 rounded-lg bg-accent-100 dark:bg-accent-900/30">
            <svg class="breadcrumb-icon w-3.5 h-3.5 text-accent-600 dark:text-accent-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
            </svg>
        </div>
        <span id="breadcrumb-project-name" class="font-medium"></span>
    </div>
    <svg class="breadcrumb-separator w-4 h-4 text-slate-400" id="separator-2" style="display: none;" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
    <div class="breadcrumb-item breadcrumb-current" id="breadcrumb-prompt" style="display: none;" data-level="prompt">
        <div class="flex items-center justify-center w-6 h-6 rounded-lg bg-accent-500">
            <svg class="breadcrumb-icon w-3.5 h-3.5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 002.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 00-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 00.75-.75 2.25 2.25 0 00-.1-.664m-5.8 0A2.251 2.251 0 0113.5 2.25H15c1.012 0 1.867.668 2.15 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m0 0H4.875c-.621 0-1.125.504-1.125 1.125v11.25c0 .621.504 1.125 1.125 1.125h9.75c0 .621-.504 1.125-1.125 1.125H18a2.25 2.25 0 01-2.25-2.25V9.375c0-.621.504-1.125 1.125-1.125H16.5a2.25 2.25 0 011.5.75"/>
            </svg>
        </div>
        <span id="breadcrumb-prompt-name" class="font-medium"></span>
    </div>
</div>

                <div id="editor-view" class="flex-grow p-4 flex flex-col min-h-0 hidden overflow-y-auto custom-scrollbar">
                    <!-- Content will be injected here -->
                </div>
                <div id="placeholder-view" class="flex-grow flex flex-col items-center justify-center text-center p-8">
                    <div class="relative mb-8">
                        <div class="w-32 h-32 rounded-3xl bg-gradient-to-br from-accent-100 to-accent-200 dark:from-accent-900/30 dark:to-accent-800/30 flex items-center justify-center shadow-2xl shadow-accent-500/10">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 10.5v6m3-3H9m4.06-7.19l-2.12-2.12a1.5 1.5 0 00-1.061-.44H4.5A2.25 2.25 0 002.25 6v12a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9a2.25 2.25 0 00-2.25-2.25h-5.379a1.5 1.5 0 01-1.06-.44z"/>
                            </svg>
                        </div>
                        <div class="absolute -top-2 -right-2 w-8 h-8 rounded-full bg-green-500 flex items-center justify-center shadow-lg">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>
                        </div>
                    </div>
                    <h3 class="text-2xl font-semibold text-slate-900 dark:text-white mb-3 tracking-tight">Witaj w Menedżerze Promptów</h3>
                    <p class="text-slate-600 dark:text-slate-400 max-w-md mb-8 leading-relaxed">
                        Wybierz element z listy po lewej lub utwórz <span class="font-semibold text-accent-600 dark:text-accent-400">nowy projekt</span>, aby rozpocząć.
                    </p>
                    <div class="flex flex-wrap justify-center gap-3 text-sm">
                        <div class="flex items-center gap-2 px-4 py-2 bg-slate-50 dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700">
                            <span class="kbd">Alt</span><span class="kbd">N</span>
                            <span class="text-slate-600 dark:text-slate-400">Nowy projekt</span>
                        </div>
                        <div class="flex items-center gap-2 px-4 py-2 bg-slate-50 dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700">
                            <span class="kbd">Alt</span><span class="kbd">S</span>
                            <span class="text-slate-600 dark:text-slate-400">Szukaj</span>
                        </div>
                    </div>
                </div>
                </div>
            
        </main>
        
        <!-- Focus Mode Toggle Button -->
        <div class="focus-mode-toggle" id="focus-mode-toggle">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h8m-8 6h16" />
            </svg>
        </div>

        <!-- Workspace Controls -->
  
    </div>

    <!-- SECTION: Modals & Notifications / Okna Modalne i Powiadomienia -->


    <div id="snippet-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden"><div class="glass-panel floating-shadow rounded-3xl p-8 bg-white dark:bg-slate-800 shadow-xl w-full max-w-7xl flex flex-col gap-4 max-h-[95vh] slide-in-up"><h2 class="text-xl font-bold">Zarządzaj wstawkami (snippetami)</h2><div class="flex flex-col md:flex-row gap-4 flex-grow min-h-0"><div class="w-full md:w-2/3 flex flex-col gap-4"><h3 id="snippet-form-title" class="text-lg font-semibold">Nowa wstawka</h3><input type="hidden" id="snippet-id-input"><div><label for="snippet-name-input" class="block text-sm font-medium text-slate-600">Nazwa (bez spacji, np. 'formalny_ton')</label><input type="text" id="snippet-name-input" class="mt-1 w-full p-2 border border-slate-300 rounded-2xl dark:bg-slate-700 dark:border-slate-600"></div><div class="flex-grow flex flex-col min-h-0"><label for="snippet-content-editor" class="block text-sm font-medium text-slate-600">Treść wstawki</label><div id="snippet-content-editor" class="mt-1 flex-grow"></div></div><div class="flex justify-end gap-2"><button id="clear-snippet-form-btn" class="px-4 py-2 bg-slate-200 hover:bg-slate-300 dark:bg-slate-600 dark:hover:bg-slate-500 rounded-2xl font-semibold hidden">Wyczyść</button><button id="save-snippet-btn" class="px-4 py-2 btn-modern-500 hover:btn-modern-600 text-white rounded-2xl font-semibold">Zapisz</button></div></div><div class="w-full md:w-1/3 flex flex-col"><h3 class="text-lg font-semibold mb-2">Istniejące wstawki</h3><ul id="snippets-list-modal" class="flex-grow overflow-y-auto custom-scrollbar border dark:border-slate-600 rounded-2xl p-2 space-y-2"></ul></div></div><button id="close-snippet-modal-btn" class="mt-4 px-4 py-2 bg-slate-600 hover:bg-slate-700 text-white rounded-2xl font-semibold self-center">Zamknij</button></div></div>

    <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden"><div class="bg-white dark:bg-slate-800 rounded-2xl shadow-xl p-6 w-full max-w-sm"><h3 id="modal-title" class="text-lg font-bold mb-4">Czy na pewno?</h3><p id="modal-text" class="text-slate-600 dark:text-slate-300 mb-6">Tej operacji nie można cofnąć.</p><div class="flex justify-end space-x-4"><button id="modal-cancel" class="px-4 py-2 bg-slate-200 hover:bg-slate-300 dark:bg-slate-600 dark:hover:bg-slate-500 rounded-2xl font-semibold">Anuluj</button><button id="modal-confirm" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-2xl font-semibold">Usuń</button></div></div></div>
    
    <div id="input-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-xl p-6 w-full max-w-sm">
            <h3 id="input-modal-title" class="text-lg font-bold mb-4">Zmień nazwę</h3>
            <input type="text" id="input-modal-field" class="w-full p-2 mb-6 border border-slate-300 rounded-2xl dark:bg-slate-700 dark:border-slate-600">
            <div class="flex justify-end space-x-4">
                <button id="input-modal-cancel" class="px-4 py-2 bg-slate-200 hover:bg-slate-300 dark:bg-slate-600 dark:hover:bg-slate-500 rounded-2xl font-semibold">Anuluj</button>
                <button id="input-modal-confirm" class="px-4 py-2 btn-modern-500 hover:btn-modern-600 text-white rounded-2xl font-semibold">Zapisz</button>
            </div>
        </div>
    </div>

    <div id="snippet-dropdown" class="snippet-dropdown custom-scrollbar hidden"></div>
    <div id="toast-notification" class="bg-green-500 text-white font-bold py-2 px-6 rounded-full shadow-lg"></div>
    <div id="global-tooltip" class="hidden"></div>
<button id="floating-copy-btn" data-tooltip="Kopiuj cały prompt (Ctrl+Shift+C)" class="hidden fixed bottom-6 right-6 z-50 w-16 h-16 rounded-full bg-gradient-to-br from-emerald-500 to-teal-500 text-white flex items-center justify-center floating-shadow copy-pulse">

        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
        </svg>
    </button>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        /*
        ==================================================
        // --- TABLE OF CONTENTS / SPIS TREŚCI ---
        ==================================================
        1.  STATE MANAGEMENT / ZARZĄDZANIE STANEM
        2.  DOM ELEMENT CACHING / PAMIĘĆ PODRĘCZNA ELEMENTÓW DOM
        3.  DYNAMIC EDITOR CONTAINER SETUP / KONFIGURACJA DYNAMICZNEGO KONTENERA EDYTORA
        4.  QUILL EDITOR INSTANCES / INSTANCJE EDYTORA QUILL
        5.  DATA PERSISTENCE (LocalStorage) / TRWAŁOŚĆ DANYCH (LocalStorage)
        6.  UTILITY FUNCTIONS / FUNKCJE POMOCNICZE
        7.  SNIPPET & VARIABLE FUNCTIONS / FUNKCJE ZWIĄZANE ZE SNIPPETAMI I ZMIENNYMI
        8.  CORE RENDER FUNCTIONS / GŁÓWNE FUNKCJE RENDERUJĄCE
        9.  UI/VIEW UPDATE FUNCTIONS / FUNKCJE AKTUALIZUJĄCE INTERFEJS UŻYTKOWNIKA
        10. CRUD & ACTION HANDLERS / OBSŁUGA AKCJI I OPERACJI CRUD
        11. DRAG & DROP LOGIC / LOGIKA PRZECIĄGNIJ I UPUŚĆ
        12. SEARCH & SORTING LOGIC / LOGIKA WYSZUKIWANIA I SORTOWANIA
        13. EVENT LISTENERS (Buttons, Inputs, etc.) / NASŁUCHIWANIE ZDARZEŃ (Przyciski, Pola, itp.)
        14. MODAL & OVERLAY LOGIC / LOGIKA OKIEN MODALNYCH I NAKŁADEK
        15. TEMPLATE LIBRARY LOGIC / LOGIKA BIBLIOTEKI SZABLONÓW
        16. GLOBAL LISTENERS (Tooltip, Resize, etc.) / GLOBALNE NASŁUCHIWANIE ZDARZEŃ
        17. THEME & PERSONALIZATION / MOTYWY I PERSONALIZACJA
        18. INITIALIZATION / INICJALIZACJA
        ==================================================
        */

        // Dedupe IDs to prevent conflicts
        (function dedupeIds() {
            const uniqueIds = [
                'search-modal','template-library-modal','snippet-modal',
                'favorites-bar','favorites-container','tree-view-list',
                'editor-view','global-search-input','global-results-container'
            ];
            uniqueIds.forEach(id => {
                const nodes = document.querySelectorAll(`#${id}`);
                nodes.forEach((n, i) => { if (i > 0) n.remove(); });
            });
        })();

        // --- 1. STATE MANAGEMENT / ZARZĄDZANIE STANEM ---
        let state = {
            projects: [],
            snippets: [],
            selectedProjectId: null,
            selectedPromptId: null,
            selectedVersionId: null,
            sortMode: 'manual', // 'manual', 'alpha', 'updated'
        };
        
        let isInitialLoad = true;

        // Add storage key constant
        const STORAGE_KEY = 'promptManagerDataV6';

        // --- 2. DOM ELEMENT CACHING / PAMIĘĆ PODRĘCZNA ELEMENTÓW DOM ---
        const mainHeader = document.getElementById('main-header');
        const darkModeToggle = document.getElementById('dark-mode-toggle');
        const darkModeIconSun = document.getElementById('dark-mode-icon-sun');
        const darkModeIconMoon = document.getElementById('dark-mode-icon-moon');
        const closeSearchModalBtn = document.getElementById('close-search-modal-btn');
        const treeViewList = document.getElementById('tree-view-list');
        const addProjectBtn = document.getElementById('add-project-btn');
        const editorView = document.getElementById('editor-view');
        const placeholderView = document.getElementById('placeholder-view');
        const importBtn = document.getElementById('import-btn');
        const exportBtn = document.getElementById('export-btn');
        const importFile = document.getElementById('import-file');
        const rightPanel = document.getElementById('right-panel');
        const treeSearch = document.getElementById('tree-search');
        const toggleAllProjectsBtn = document.getElementById('toggle-all-projects-btn');
        const sortModeSelect = document.getElementById('sort-mode');

        // Adaptive Workspace Elements
        const resizeHandle = document.getElementById('resize-handle');
        const breadcrumbNav = document.getElementById('breadcrumb-nav');
        const breadcrumbProject = document.getElementById('breadcrumb-project');
        const breadcrumbProjectName = document.getElementById('breadcrumb-project-name');
        const breadcrumbPrompt = document.getElementById('breadcrumb-prompt');
        const breadcrumbPromptName = document.getElementById('breadcrumb-prompt-name');
        const separator1 = document.getElementById('separator-1');
        const separator2 = document.getElementById('separator-2');
        const focusModeToggle = document.getElementById('focus-mode-toggle');
        const workspaceControls = document.getElementById('workspace-controls');
        const toggleSidebarBtn = document.getElementById('toggle-sidebar-btn');
        const leftSidebar = document.getElementById('left-sidebar');

        // Workspace state
        let isResizing = false;
        let startX = 0;
        let startWidth = 0;
        let focusMode = false;
        let ticking = false;
        let sidebarWidth = localStorage.getItem('sidebarWidth') || '33.333333%';
        
        // Favorites Bar Elements
        const favoritesBar = document.getElementById('favorites-bar');
        const favoritesContainer = document.getElementById('favorites-container');
        const favLeftBtn = document.getElementById('fav-left');
        const favRightBtn = document.getElementById('fav-right');
        
        // Snippet Modal Elements
        const manageSnippetsBtn = document.getElementById('manage-snippets-btn');
        const snippetModal = document.getElementById('snippet-modal');
        const closeSnippetModalBtn = document.getElementById('close-snippet-modal-btn');
        const snippetFormTitle = document.getElementById('snippet-form-title');
        const snippetIdInput = document.getElementById('snippet-id-input');
        const snippetNameInput = document.getElementById('snippet-name-input');
        const saveSnippetBtn = document.getElementById('save-snippet-btn');
        const clearSnippetFormBtn = document.getElementById('clear-snippet-form-btn');
        const snippetsListModal = document.getElementById('snippets-list-modal');
        const snippetDropdown = document.getElementById('snippet-dropdown');

        

        // Confirmation Modal Elements
        const confirmationModal = document.getElementById('confirmation-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalText = document.getElementById('modal-text');
        const modalConfirm = document.getElementById('modal-confirm');
        const modalCancel = document.getElementById('modal-cancel');
        let confirmationCallback = null;

        // Input Modal Elements
        const inputModal = document.getElementById('input-modal');
        const inputModalTitle = document.getElementById('input-modal-title');
        const inputModalField = document.getElementById('input-modal-field');
        const inputModalConfirm = document.getElementById('input-modal-confirm');
        const inputModalCancel = document.getElementById('input-modal-cancel');
        let inputCallback = null;

        // Search Modal Elements
        const globalSearchBtn = document.getElementById('global-search-btn');
        let searchModal = null;
        let globalSearchInput = null;
        let globalResultsContainer = null;
        const floatingCopyBtn = document.getElementById('floating-copy-btn');

        // Toast & Tooltip Elements
        const toast = document.getElementById('toast-notification');
        let toastTimeout;
        const globalTooltip = document.getElementById('global-tooltip');
		
        // Initialize search modal elements after DOM is ready
        searchModal = document.getElementById('search-modal');
        globalSearchInput = document.getElementById('global-search-input');
        globalResultsContainer = document.getElementById('global-results-container');

        // Typography Controls
        const fontFamilySelect = document.getElementById('font-family-select');
        const fontSizeDisplay = document.getElementById('font-size-display');
        const fontSizeUpBtn = document.getElementById('font-size-up-btn');
        const fontSizeDownBtn = document.getElementById('font-size-down-btn');

        const lineHeightDisplay = document.getElementById('line-height-display');
        const lineHeightUpBtn = document.getElementById('line-height-up-btn');
        const lineHeightDownBtn = document.getElementById('line-height-down-btn');

        const paragraphSpacingDisplay = document.getElementById('paragraph-spacing-display');
        const paragraphSpacingUpBtn = document.getElementById('paragraph-spacing-up-btn');
        const paragraphSpacingDownBtn = document.getElementById('paragraph-spacing-down-btn');

        
        // --- 3. DYNAMIC EDITOR CONTAINER SETUP / KONFIGURACJA DYNAMICZNEGO KONTENERA EDYTORA ---
        const simpleEditorContainer = document.createElement('div');
        simpleEditorContainer.id = 'prompt-content-container';
        simpleEditorContainer.className = 'flex flex-col gap-4 flex-grow min-h-0';
        simpleEditorContainer.innerHTML = `<div id="prompt-editor-quill-container" class="relative flex-grow flex flex-col"></div>
            <div class="text-sm text-slate-500 dark:text-slate-400 mt-2 px-3">
                💡 Zacznij pisać, wpisz <span class="font-mono bg-slate-100 dark:bg-slate-700 px-1 rounded">#</span> (snippet) lub <span class="font-mono bg-slate-100 dark:bg-slate-700 px-1 rounded">[zmienna]</span>
            </div>`;

        

        const sharedControlsContainer = document.createElement('div');
        sharedControlsContainer.id = 'shared-controls-container';
sharedControlsContainer.innerHTML = `
            <!-- Header kontrolek edytora -->
            <div class="mb-6 p-5 bg-gradient-to-br from-indigo-50 via-blue-50 to-purple-50 dark:from-slate-800 dark:via-indigo-900/20 dark:to-purple-900/20 rounded-2xl border border-indigo-200/60 dark:border-indigo-700/40 shadow-lg shadow-indigo-500/10">
                <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
                    <!-- Lewa strona - tytuł i podstawowe info -->
                    <div class="flex items-center gap-4">
                        <div class="flex items-center gap-4">
                            <div id="prompt-icon" class="w-14 h-14 rounded-xl bg-gradient-to-br from-violet-500 via-purple-600 to-indigo-600 flex items-center justify-center shadow-xl shadow-violet-500/30">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                </svg>
                            </div>
                            <div style="margin-left: 10px;">
                                <h2 class="text-xl font-bold text-slate-800 dark:text-white" id="prompt-title-display">Edytor promptu</h2>
                                <div class="flex items-center gap-2 mt-2">
                                    <div class="px-2.5 py-1 bg-blue-100 dark:bg-blue-900/30 text-blue-800 dark:text-blue-200 rounded-lg text-xs font-medium" id="prompt-type-badge">Prosty</div>
                                    <div id="version-dates-display" class="text-xs text-slate-500"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Prawa strona - kontrolki -->
                    <div class="flex items-center gap-3 flex-wrap">
                        <!-- Version Manager -->
                        <div id="version-manager" class="relative hidden">
                            <div class="flex items-center gap-2">
                                <span class="text-sm font-medium text-slate-600 dark:text-slate-400">Wersja:</span>
                                <div class="relative">
                                    <button id="version-dropdown-btn" class="flex items-center gap-2 px-3 py-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-lg text-sm font-medium hover:bg-slate-50 dark:hover:bg-slate-600 transition-all focus:outline-none focus:ring-2 focus:ring-blue-500/20">
                                        <span id="current-version-name">Wersja 1</span>
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                        </svg>
                                    </button>
                                    <div id="version-dropdown-menu" class="hidden absolute top-full left-0 mt-1 w-48 bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg shadow-xl z-50">
                                        <div class="py-1" id="version-list">
                                            <!-- Wersje będą wstawiane dynamicznie -->
                                        </div>
                                        <div class="border-t border-slate-200 dark:border-slate-600 py-1">
                                            <button id="add-version-btn" class="w-full text-left px-3 py-2 text-sm text-green-600 dark:text-green-400 hover:bg-green-50 dark:hover:bg-green-900/20 flex items-center gap-2">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v12m6-6H6"/></svg>
                                                Nowa wersja
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Editor Controls -->
                        <div class="flex items-center gap-3">
                            <div class="flex items-center gap-2" data-tooltip="Wyłącz, aby zapobiec przypadkowym zmianom">
                                <span class="text-sm text-slate-600 dark:text-slate-400">Edycja</span>
                                <label class="pill-switch">
                                    <input type="checkbox" id="editor-lock-checkbox">
                                    <span class="pill-slider">
                                        <svg class="lock-open-icon h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M10 2a5 5 0 00-5 5v2a2 2 0 00-2 2v5a2 2 0 002 2h10a2 2 0 002-2v-5a2 2 0 00-2-2V7a5 5 0 00-5-5zm0 2a3 3 0 013 3v2H7V7a3 3 0 013-3z" /></svg>
                                        <svg class="lock-closed-icon h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 2a5 5 0 00-5 5v2a2 2 0 00-2 2v5a2 2 0 002 2h10a2 2 0 002-2v-5a2 2 0 00-2-2V7a5 5 0 00-5-5zm-2 7a2 2 0 114 0v2H8V9z" clip-rule="evenodd" /></svg>
                                    </span>
                                </label>
                            </div>

                            <button id="change-prompt-type-btn" class="hidden px-3 py-1.5 text-sm text-purple-600 hover:text-purple-800 dark:text-purple-400 dark:hover:text-purple-300 font-semibold bg-purple-50 dark:bg-purple-900/20 rounded-lg hover:bg-purple-100 dark:hover:bg-purple-900/30 transition-all">Zmień typ</button>
                            
                            <button id="insert-snippet-btn" data-tooltip="Wstaw snippet - wpisz # w edytorze" class="flex items-center gap-2 px-3 py-1.5 text-sm text-purple-600 hover:text-purple-800 dark:text-purple-400 dark:hover:text-purple-300 font-semibold bg-purple-50 dark:bg-purple-900/20 rounded-lg hover:bg-purple-100 dark:hover:bg-purple-900/30 transition-all">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 20l4-16m2 16l4-16M6 9h14M4 15h14" /></svg>
                                Snippet
                            </button>
                            
                            <button id="toggle-fullscreen-btn" data-tooltip="Pełny ekran" class="p-2 text-slate-500 hover:text-blue-600 dark:text-slate-400 dark:hover:text-blue-400 rounded-lg hover:bg-blue-50 dark:hover:bg-blue-900/20 transition-all">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" /></svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Główny obszar edytora -->
            <div id="main-editor-area" class="flex-grow flex flex-col min-h-0 mb-6"></div>

            <!-- Zmienne dynamiczne -->
            <div id="variables-container" class="hidden mb-6">
                <div class="bg-gradient-to-br from-blue-100 via-cyan-50 to-teal-100 dark:from-blue-900/30 dark:via-cyan-900/20 dark:to-teal-900/30 rounded-2xl p-5 border-2 border-blue-300/60 dark:border-blue-600/40 shadow-lg shadow-blue-500/20">
                    <div class="flex items-center gap-2 mb-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-600 dark:text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4" /></svg>
                        <h3 class="font-semibold text-blue-800 dark:text-blue-200">Zmienne dynamiczne</h3>
                        <div class="text-xs text-blue-600 dark:text-blue-400 bg-blue-100 dark:bg-blue-800/30 px-2 py-1 rounded-full">Znajdźcie w tekście: [nazwa]</div>
                    </div>
                    <div id="variables-inputs" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                </div>
            </div>

            <!-- Kontekst/Assistant -->
            <div id="assistant-container" class="mb-6">
                <div class="bg-gradient-to-br from-emerald-100 via-green-50 to-lime-100 dark:from-emerald-900/30 dark:via-green-900/20 dark:to-lime-900/30 rounded-2xl p-5 border-2 border-emerald-300/60 dark:border-emerald-600/40 shadow-lg shadow-emerald-500/20">
                    <div class="flex justify-between items-center mb-3">
                        <div class="flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-600 dark:text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                            <label for="assistant-content" class="font-semibold text-green-800 dark:text-green-200">Dodatkowe informacje (kontekst)</label>
                        </div>
                        <button id="toggle-assistant-btn" data-tooltip="Pokaż/ukryj pole kontekstu" class="text-green-600 dark:text-green-400 hover:text-green-800 dark:hover:text-green-200 transition-transform duration-200">
                            <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" /></svg>
                        </button>
                    </div>
                    <div id="assistant-wrapper">
                        <textarea id="assistant-content" rows="4" class="w-full p-4 bg-white dark:bg-slate-800 border border-green-300 dark:border-green-700 rounded-xl text-sm placeholder-green-500 dark:placeholder-green-400 focus:outline-none focus:ring-2 focus:ring-green-500/20 focus:border-green-500 transition-all" placeholder="Wklej tutaj dodatkowe dane, artykuły, fragmenty kodu itp., które AI ma wykorzystać..."></textarea>
                    </div>
                </div>
            </div>

            <!-- Podgląd końcowego promptu -->
            <div class="relative bg-gradient-to-br from-violet-100 via-purple-50 to-fuchsia-100 dark:from-violet-900/30 dark:via-purple-900/20 dark:to-fuchsia-900/30 rounded-2xl p-6 border-2 border-violet-300/60 dark:border-violet-600/40 shadow-2xl shadow-violet-500/20 overflow-hidden">
                <div class="absolute top-0 right-0 w-32 h-32 bg-gradient-to-bl from-purple-300/20 to-transparent rounded-bl-full"></div>
                <div class="relative z-10">
                <div class="flex justify-between items-center mb-4">
                    <div class="flex items-center gap-3">
                        <div class="relative">
                            <div class="w-3 h-3 rounded-full bg-gradient-to-r from-green-400 to-emerald-500"></div>
                            <div class="absolute top-0 left-0 w-3 h-3 rounded-full bg-gradient-to-r from-green-400 to-emerald-500 animate-ping"></div>
                        </div>
                        <h3 class="text-lg font-bold text-slate-800 dark:text-slate-200">Podgląd końcowego promptu</h3>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="flex items-center gap-1 bg-slate-200 dark:bg-slate-700 px-2 py-1 rounded-lg">
                            <span class="kbd text-xs">Alt</span><span class="kbd text-xs">C</span>
        </div>
                        <button id="copy-plain-text-btn" data-tooltip="Kopiuj jako czysty tekst (bez formatowania HTML)" class="flex items-center gap-2 text-sm text-slate-600 dark:text-slate-400 hover:text-slate-800 dark:hover:text-slate-200 font-medium px-4 py-2 rounded-xl hover:bg-white dark:hover:bg-slate-700 transition-all duration-200 border border-slate-300 dark:border-slate-600">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                            Czysty tekst
                        </button>
                        <button id="copy-combined-btn" data-tooltip="Kopiuj z formatowaniem HTML" class="relative bg-gradient-to-br from-violet-500 via-purple-600 to-indigo-600 hover:from-violet-600 hover:via-purple-700 hover:to-indigo-700 text-white font-bold py-3 px-6 rounded-xl transition-all duration-300 flex items-center gap-2 shadow-xl shadow-purple-500/40 hover:shadow-2xl hover:shadow-purple-500/60 transform hover:scale-105 overflow-hidden group">
                            <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent translate-x-[-100%] group-hover:translate-x-[100%] transition-transform duration-700"></div>
                            <div class="relative z-10 flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>
                            <span class="text-sm">Kopiuj prompt</span>
                            </div>
                        </button>
                    </div>
                </div>
                <div class="mb-3 text-sm text-slate-600 dark:text-slate-400">
                    <div class="flex items-center gap-4 flex-wrap">
                        <span class="flex items-center gap-1">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-purple-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 20l4-16m2 16l4-16M6 9h14M4 15h14" /></svg>
                            Snippety zastąpione automatycznie
                        </span>
                        <span class="flex items-center gap-1">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4" /></svg>
                            Zmienne podstawione z formularza
                        </span>
                        <span class="flex items-center gap-1">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                            Gotowe do kopiowania
                        </span>
                    </div>
                </div>
                <div id="combined-output-preview" class="w-full min-h-[200px] max-h-[400px] p-6 bg-white dark:bg-slate-900 border-2 border-slate-200 dark:border-slate-700 rounded-2xl overflow-y-auto custom-scrollbar text-sm leading-relaxed shadow-inner relative">
                    <div class="text-slate-400 text-center py-8">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto mb-3 opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        <p>Zacznij pisać prompt, aby zobaczyć podgląd</p>
                    </div>
                </div>
                </div>
            </div>
        `;
        editorView.appendChild(sharedControlsContainer);

        const mainEditorArea = sharedControlsContainer.querySelector('#main-editor-area');
        const toggleFullscreenBtn = sharedControlsContainer.querySelector('#toggle-fullscreen-btn');
        const insertSnippetBtn = sharedControlsContainer.querySelector('#insert-snippet-btn');
        const combinedOutputPreview = sharedControlsContainer.querySelector('#combined-output-preview');
        const copyCombinedBtn = sharedControlsContainer.querySelector('#copy-combined-btn');
        const copyPlainTextBtn = sharedControlsContainer.querySelector('#copy-plain-text-btn');
        const editorLockCheckbox = sharedControlsContainer.querySelector('#editor-lock-checkbox');
        const changePromptTypeBtn = sharedControlsContainer.querySelector('#change-prompt-type-btn');
        const variablesContainer = sharedControlsContainer.querySelector('#variables-container');
        const variablesInputs = sharedControlsContainer.querySelector('#variables-inputs');
        const assistantContainer = sharedControlsContainer.querySelector('#assistant-container');
        const assistantWrapper = sharedControlsContainer.querySelector('#assistant-wrapper');
        const toggleAssistantBtn = sharedControlsContainer.querySelector('#toggle-assistant-btn');
        const assistantContent = sharedControlsContainer.querySelector('#assistant-content');
        const versionDatesDisplay = sharedControlsContainer.querySelector('#version-dates-display');
        const versionManager = sharedControlsContainer.querySelector('#version-manager');
        
        // --- 4. QUILL EDITOR INSTANCES / INSTANCJE EDYTORA QUILL ---
        let chainQuillInstances = new Map();
        const quillToolbarOptions = [
            [{ 'header': [1, 2, 3, false] }],
            ['bold', 'italic', 'underline'],
            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
            ['clean']
        ];

        const promptEditorHost = simpleEditorContainer.querySelector('#prompt-editor-quill-container');
        const promptEditor = new Quill(promptEditorHost, {
            modules: { toolbar: quillToolbarOptions },
            placeholder: '',
            theme: 'snow'
        });
        
        // POPRAWKA: Dodaj listener od razu po utworzeniu
        promptEditor.on('ready', () => {
            console.log('✅ Quill editor ready');
            setupEditorListeners(promptEditor);
        });

        const snippetEditor = new Quill('#snippet-content-editor', {
            modules: { toolbar: quillToolbarOptions },
            theme: 'snow'
        });

        // --- 5. DATA PERSISTENCE (LocalStorage) / TRWAŁOŚĆ DANYCH (LocalStorage) ---
        const debounce = (func, delay) => {
            let timeout;

            const debounced = function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => {
                    timeout = null;
                    func.apply(context, args);
                }, delay);
            };

            // Anuluje oczekujące wywołanie
            debounced.cancel = () => {
                clearTimeout(timeout);
                timeout = null;
            };

            // Natychmiast wykonuje funkcję, jeśli jest zaplanowana
            debounced.flush = () => {
                if (timeout) {
                    clearTimeout(timeout);
                    timeout = null;
                    func.apply(this);
                }
            };

            return debounced;
        };

        const saveData = () => {
            try {
                const dataStr = JSON.stringify(state);
                localStorage.setItem(STORAGE_KEY, dataStr);
                return true;
            } catch (e) {
                console.error("Błąd krytyczny zapisu!:", e);

                // Specjalna obsługa błędu przepełnienia localStorage
                if (e.name === 'QuotaExceededError' || e.code === 22) {
                    // Auto-backup przed pokazaniem błędu
                    try {
                        const dataStr = JSON.stringify(state);
                        const dataBlob = new Blob([dataStr], {type: 'application/json'});
                        const url = URL.createObjectURL(dataBlob);
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = `EMERGENCY-backup-${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.json`;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        URL.revokeObjectURL(url);

                        showToast("⚠️ Brak miejsca w localStorage! Pobrano awaryjny backup. Usuń stare projekty.", "error");
                    } catch (backupError) {
                        console.error("Nie udało się utworzyć awaryjnego backupu:", backupError);
                        showToast("❌ KRYTYCZNY BŁĄD: Brak miejsca! Skopiuj dane ręcznie!", "error");
                    }
                } else {
                    showToast("Błąd zapisu! Sprawdź konsolę.", "error");
                }
                return false;
            }
        };

const autoSaveChanges = () => {
    console.log('💾 autoSaveChanges called');
    
    const project = getSelectedProject();
    const prompt = getSelectedPrompt();
    const version = getSelectedVersion();
    
    if (!project || !prompt || !version) {
        console.log('❌ No project, prompt or version selected, skipping save');
        return false;
    }

    console.log('🔍 Saving for project:', project.name, 'prompt:', prompt.name, 'version:', version.name);

    const now = Date.now();
    
    try {
        // Pobierz aktualną zawartość z edytora
        if (promptEditor && promptEditor.root) {
            const currentContent = promptEditor.root.innerHTML;
            console.log('💾 Saving main editor content, length:', currentContent.length);
            
            // WAŻNE: Znajdź właściwy obiekt w state i zaktualizuj go
            const stateProject = state.projects.find(p => p.id === project.id);
            if (stateProject) {
                const statePrompt = stateProject.prompts.find(p => p.id === prompt.id);
                if (statePrompt && statePrompt.versions) {
                    const stateVersion = statePrompt.versions.find(v => v.id === version.id);
                    if (stateVersion) {
                        stateVersion.content = currentContent;
                        stateVersion.updatedAt = now;
                        statePrompt.updatedAt = now;
                        stateProject.updatedAt = now;
                        console.log('✅ Updated version content in state');
                    }
                }
            }
        } else {
            console.warn('⚠️ promptEditor not available');
        }
        
        // Zapisz zawartość pola kontekstu
        if (assistantContent && typeof assistantContent.value === 'string') {
            const stateProject = state.projects.find(p => p.id === project.id);
            if (stateProject) {
                const statePrompt = stateProject.prompts.find(p => p.id === prompt.id);
                if (statePrompt && statePrompt.versions) {
                    const stateVersion = statePrompt.versions.find(v => v.id === version.id);
                    if (stateVersion) {
                        stateVersion.assistantContent = assistantContent.value;
                        console.log('💾 Saved assistant content');
                    }
                }
            }
        }
        
        // Zapisz stan widoczności asystenta
        if (assistantWrapper) {
            const stateProject = state.projects.find(p => p.id === project.id);
            if (stateProject) {
                const statePrompt = stateProject.prompts.find(p => p.id === prompt.id);
                if (statePrompt && statePrompt.versions) {
                    const stateVersion = statePrompt.versions.find(v => v.id === version.id);
                    if (stateVersion) {
                        stateVersion.isAssistantVisible = !assistantWrapper.classList.contains('hidden');
                    }
                }
            }
        }
        
        // KLUCZOWE: Zapisz do localStorage
        const saveResult = saveData();
        console.log('💾 LocalStorage save result:', saveResult);
        
        if (saveResult) {
            console.log('✅ Successfully saved to localStorage');
            updateVersionDatesDisplay();
            return true;
        } else {
            console.error('❌ Failed to save to localStorage');
            return false;
        }
        
    } catch (error) {
        console.error('❌ Error in autoSaveChanges:', error);
        return false;
    }
};

        const debouncedAutoSave = debounce(autoSaveChanges, 1000);

        const loadData = () => {
            try {
                const stored = localStorage.getItem(STORAGE_KEY);
                if (!stored) return;
                const parsed = JSON.parse(stored);
                if (parsed && typeof parsed === 'object') {
                    state.projects = Array.isArray(parsed.projects) ? parsed.projects : [];
                    state.snippets = Array.isArray(parsed.snippets) ? parsed.snippets : [];
                    state.selectedProjectId = parsed.selectedProjectId || null;
                    state.selectedPromptId = parsed.selectedPromptId || null;
                    state.selectedVersionId = parsed.selectedVersionId || null;
                    state.sortMode = parsed.sortMode || 'manual';
                }
            } catch (e) {
                console.error("Błąd odczytu danych!", e);
                showToast("Błąd odczytu danych!", "error");
            }
        };

        // --- 6. UTILITY FUNCTIONS / FUNKCJE POMOCNICZE ---
        const generateId = () => `id_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        const formatDate = (timestamp) => {
            if (!timestamp) return '';
            const date = new Date(timestamp);
            return `${String(date.getDate()).padStart(2, '0')}.${String(date.getMonth() + 1).padStart(2, '0')}.${date.getFullYear()} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
        };
        const stripHtml = html => (html || '').replace(/<[^>]*>/g, ' ').replace(/\s+/g,' ').trim();
        const escapeHtml = s => (s||'').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));

        const findProject = (projectId) => state.projects.find(p => p.id === projectId);
        const findPrompt = (projectId, promptId) => findProject(projectId)?.prompts.find(p => p.id === promptId);
        const findVersion = (projectId, promptId, versionId) => {
            const prompt = findPrompt(projectId, promptId);
            if (!prompt || prompt.type !== 'simple') return null;
            return prompt.versions?.find(v => v.id === versionId);
        };
        
        const getSelectedProject = () => findProject(state.selectedProjectId);
        const getSelectedPrompt = () => findPrompt(state.selectedProjectId, state.selectedPromptId);
        const getSelectedVersion = () => findVersion(state.selectedProjectId, state.selectedPromptId, state.selectedVersionId);

        const showToast = (message, type = 'success') => {
            clearTimeout(toastTimeout);
            toast.textContent = message;
            toast.className = 'text-white font-bold py-2 px-6 rounded-full shadow-lg';
            toast.classList.add(type === 'success' ? 'bg-green-500' : 'bg-red-500');
            toast.classList.add('show');
            toastTimeout = setTimeout(() => toast.classList.remove('show'), 2500);
        };

        const COLORS = [
            '#F7F7F7', // bardzo jasny szary
            '#FDECEC', // blush
            '#FFF8E6', // jasny krem/peach
            '#F9FFE8', // bardzo jasna limonka
            '#EAF7FF', // bardzo jasny błękit
            '#F0EAFF', // lawendowa mgła
            '#FDF0FF', // jasny róż-fiołet
            '#FFFBEA', // wanilia
            '#EFFFF7', // mięta
            '#F6FFF9', // seledynowa biel
            '#F0FBFF', // lodowy błękit
            '#FFF0F5', // lavender-blush
            '#EEF2FF', // indigo wash
            '#FFF1F3', // rose wash
            '#F8F9FF', // off-white blue
            '#FDF7FF'  // lilac vellum
        ];

        function openColorPopover(anchorEl, onPick){

        const initProjectColorPicker = (projectId) => {
            const dotElement = document.querySelector(`.tree-item[data-id="${projectId}"] .color-dot`);
            if (!dotElement) return;

            dotElement.onclick = (e) => {
                e.stopPropagation();
                openColorPopover(dotElement, (selectedColor) => {
                    const project = findProject(projectId);
                    if (project) {
                        project.color = selectedColor;
                        saveData();
                        renderTreeView();
                    }
                });
            };
        };
            const pop = document.getElementById('colorPopover') || (()=>{ 
                const d=document.createElement('div'); 
                d.id='colorPopover'; 
                d.className='fixed bg-white dark:bg-slate-900 border dark:border-slate-700 rounded-md p-2 shadow-lg z-50'; 
                document.body.appendChild(d); 
                return d; 
            })();
            
            pop.innerHTML = '<div class="grid grid-cols-8 gap-2">' + COLORS.map(hex => {
                const pal = derivePalette(hex);
                return `<button class="w-6 h-6 rounded-full border dark:border-slate-600" data-color-value="${hex}" style="background-color:${pal.dotStrong}"></button>`;
            }).join('') + '</div>';
            
            const r = anchorEl.getBoundingClientRect();
            pop.style.left = (window.scrollX + r.left) + 'px';
            pop.style.top  = (window.scrollY + r.bottom + 6) + 'px';
            pop.style.display = 'block';
            
            const onDoc = (e)=>{ 
                if(!pop.contains(e.target) && e.target!==anchorEl){ 
                    pop.style.display='none'; 
                    document.removeEventListener('mousedown', onDoc);
                } 
            };
            document.addEventListener('mousedown', onDoc);
            
            pop.querySelectorAll('button').forEach(btn => btn.addEventListener('click', (e) => { 
                e.stopPropagation(); 
                onPick(btn.dataset.colorValue); 
                pop.style.display='none'; 
            }));
        }

        // --- 7. SNIPPET & VARIABLE FUNCTIONS / FUNKCJE ZWIĄZANE ZE SNIPPETAMI I ZMIENNYMI ---
        const replaceSnippets = (text) => {
            if (!text) return '';
            return text.replace(/#([a-zA-Z0-9_]+)/g, (match, snippetName) => {
                const snippet = state.snippets.find(s => s.name === snippetName.trim());
                if (!snippet) return match;
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = DOMPurify.sanitize(snippet.content);
                return tempDiv.innerText;
            });
        };
        
        const replaceVariables = (text, variables) => {
            if (!text) return '';
            return text.replace(/\[([^\]]+)\]/g, (match, varName) => {
                return variables[varName] || '';
            });
        };
        
        // Wersja HTML: wstawiamy zawartość snippetu jako HTML (bez zamiany na .innerText)
        const replaceSnippetsHTML = (html) => {
            if (!html) return '';
            return html.replace(/#([a-zA-Z0-9_]+)/g, (match, snippetName) => {
                const snippet = state.snippets.find(s => s.name === snippetName.trim());
                if (!snippet) return match;
                // snippet.content to już HTML – zwracamy wprost z sanityzacją
                return DOMPurify.sanitize(snippet.content || '');
            });
        };

        // Zwraca gotowy HTML do podglądu (z żywych edytorów)
function getCombinedHTML() {
            const prompt = getSelectedPrompt();
            if (!prompt) return '<div class="text-slate-400">Brak wybranego promptu</div>';

            const variableValues = {};
            if (variablesInputs) {
                variablesInputs.querySelectorAll('input[data-variable-name]').forEach(input => {
                    variableValues[input.dataset.variableName] = input.value;
                });
            }

            let coreHtml = '';
            if (prompt.type === 'simple') {
                const version = getSelectedVersion();
                if (promptEditor && promptEditor.root) {
                    coreHtml = promptEditor.root.innerHTML;
                } else if (version) {
                    coreHtml = version.content || '';
                }
            } else {
                coreHtml = (prompt.steps || []).map(s => {
                    const q = chainQuillInstances?.get?.(s.id);
                    return q ? q.root.innerHTML : (s.content || '');
                }).filter(Boolean).join('<br><br>');
            }

            // Rozwiń snippety jako HTML z kolorowaniem
            let htmlOut = coreHtml || '';
            htmlOut = htmlOut.replace(/#([a-zA-Z0-9_]+)/g, (match, snippetName) => {
                const snippet = state.snippets.find(s => s.name === snippetName.trim());
                if (!snippet) return match;

                // Tworzymy tymczasowy kontener, aby zmodyfikować elementy HTML ze snippetu
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = snippet.content || '';
                
                // Dodajemy styl tła do każdego elementu-dziecka w snippecie
                [...tempDiv.children].forEach(child => {
                    child.style.backgroundColor = 'rgba(168, 85, 247, 0.1)';
                    child.style.padding = '2px 6px';
                    child.style.borderRadius = '4px';
                    child.style.display = 'inline-block'; // Kluczowa zmiana
                });
                
                return tempDiv.innerHTML;
            });

            // Podstaw zmienne z kolorowaniem
            htmlOut = htmlOut.replace(/\[([^\]]+)\]/g, (match, varName) => {
                const value = variableValues[varName] || '';
                if (value) {
                    return `<span style="background-color: rgba(59, 130, 246, 0.15); color: rgb(37, 99, 235); padding: 2px 6px; border-radius: 4px; border: 1px solid rgba(59, 130, 246, 0.2);">${value}</span>`;
                }
                return `<span style="background-color: rgba(156, 163, 175, 0.15); color: rgb(107, 114, 128); padding: 2px 6px; border-radius: 4px; border: 1px dashed rgba(156, 163, 175, 0.3);">[${varName}]</span>`;
            });

            // Dodaj kontekst jeśli istnieje
            const version = getSelectedVersion();
            const liveCtx = (assistantContent && typeof assistantContent.value === 'string')
              ? assistantContent.value.trim()
              : '';
            const ctxRaw = liveCtx || (version?.assistantContent?.trim() || '');

            if (ctxRaw) {
                const contextHtml = `<br><br><span style="display: inline-block; background-color: rgba(22, 163, 74, 0.1); color: #065f46; padding: 2px 6px; border-radius: 4px; border: 1px solid rgba(22, 163, 74, 0.2);">${escapeHtml(ctxRaw).replace(/\n/g, '<br>')}</span>`;
                htmlOut += contextHtml;
            }

            return htmlOut || '<div class="text-slate-400">Brak treści</div>';
        }
		
        const renderVariableInputs = () => {
            const prompt = getSelectedPrompt();
            if (!prompt) {
                variablesContainer.classList.add('hidden');
                return;
            }

            let textToScan = '';
            if (prompt.type === 'simple') {
                const version = getSelectedVersion();
                if (version) {
                    textToScan = stripHtml(version.content);
                }
            } else if (prompt.type === 'chain') {
                textToScan = prompt.steps.map(step => stripHtml(step.content)).join(' ');
            }
            
            const variableRegex = /\[([^\]]+)\]/g;
            let match;
            const foundVariables = new Set();
            while ((match = variableRegex.exec(textToScan)) !== null) {
                foundVariables.add(match[1]);
            }

            if (foundVariables.size === 0) {
                variablesContainer.classList.add('hidden');
                return;
            }

            variablesContainer.classList.remove('hidden');
            variablesInputs.innerHTML = '';
            
            foundVariables.forEach(varName => {
                const div = document.createElement('div');
                div.innerHTML = `
                    <label for="var-${varName}" class="block text-sm font-medium text-slate-600 mb-1">${varName}</label>
                    <input type="text" id="var-${varName}" data-variable-name="${varName}" class="w-full p-3 input-modern rounded-2xl dark:bg-slate-700 dark:border-slate-600" placeholder="Wprowadź wartość dla ${varName}...">
                `;
                div.querySelector('input').oninput = updateCombinedOutput;
                variablesInputs.appendChild(div);
            });
        };

        const renderSnippetsInModal = () => {
            snippetsListModal.innerHTML = '';
            if (state.snippets.length === 0) {
                snippetsListModal.innerHTML = `<div class="text-center text-slate-500 py-4"><svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1"><path stroke-linecap="round" stroke-linejoin="round" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z" /></svg><p class="mt-2 text-sm">Brak zapisanych wstawek.</p></div>`;
                return;
            }
            state.snippets.forEach(snippet => {
                const li = document.createElement('li');
                li.className = 'p-2 border-b dark:border-slate-700 flex justify-between items-center group';
                li.innerHTML = `<strong class="font-semibold flex-grow truncate mr-2">${snippet.name}</strong><div class="flex gap-1"><button data-id="${snippet.id}" data-tooltip="Edytuj" class="edit-snippet-btn p-1 text-slate-400 hover:text-blue-500"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L16.732 3.732z" /></svg></button><button data-id="${snippet.id}" data-tooltip="Usuń" class="delete-snippet-btn p-1 text-slate-400 hover:text-red-500"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button></div>`;
                snippetsListModal.appendChild(li);
            });
        };

        const resetSnippetForm = () => {
            snippetFormTitle.textContent = 'Dodaj nową wstawkę';
            snippetIdInput.value = '';
            snippetNameInput.value = '';
            snippetEditor.root.innerHTML = '';
            saveSnippetBtn.textContent = 'Zapisz';
            clearSnippetFormBtn.classList.add('hidden');
        };
        
        const handleSaveSnippet = () => {
            const id = snippetIdInput.value;
            const name = snippetNameInput.value.trim().replace(/\s+/g, '_');
            const content = snippetEditor.root.innerHTML;
            const hasContent = snippetEditor.getText().trim().length > 0;

            if (!name || !hasContent) { showToast('Nazwa i treść wstawki nie mogą być puste.', 'error'); return; }
            const isNameTaken = state.snippets.some(s => s.name === name && s.id !== id);
            if (isNameTaken) { showToast('Wstawka o tej nazwie już istnieje.', 'error'); return; }

            if (id) {
                const snippet = state.snippets.find(s => s.id === id);
                if (snippet) { snippet.name = name; snippet.content = content; }
            } else {
                state.snippets.unshift({ id: generateId(), name, content });
            }

            saveData();
            renderSnippetsInModal();
            resetSnippetForm();
            updateCombinedOutput();
        };

        const handleEditSnippet = (id) => {
            const snippet = state.snippets.find(s => s.id === id);
            if (snippet) {
                snippetFormTitle.textContent = 'Edytuj wstawkę';
                snippetIdInput.value = snippet.id;
                snippetNameInput.value = snippet.name;
                snippetEditor.root.innerHTML = DOMPurify.sanitize(snippet.content);
                saveSnippetBtn.textContent = 'Aktualizuj';
                clearSnippetFormBtn.classList.remove('hidden');
            }
        };

        const handleDeleteSnippet = (id) => {
            showConfirmation('Usunąć wstawkę?', 'Tej operacji nie można cofnąć.', () => {
                state.snippets = state.snippets.filter(s => s.id !== id);
                saveData();
                renderSnippetsInModal();
                updateCombinedOutput();
            }, 'Usuń');
        };

        const showSnippetDropdown = (bounds, activeEditor, filterText = '') => {
            renderSnippetDropdown(activeEditor, filterText);
            if (bounds) {
                snippetDropdown.style.left = `${bounds.left}px`;
                snippetDropdown.style.top = `${bounds.bottom + 5}px`;
            }
            snippetDropdown.classList.remove('hidden');
            const searchInput = snippetDropdown.querySelector('.snippet-search-input');
            if (searchInput) {
                searchInput.focus({ preventScroll: true });
                searchInput.value = filterText;
            }
        };

        const renderSnippetDropdown = (activeEditor, filterText = '') => {
            snippetDropdown.innerHTML = '';
            const searchInput = document.createElement('input');
            searchInput.type = 'text';
            searchInput.placeholder = 'Szukaj...';
            searchInput.className = 'snippet-search-input w-full p-2 text-sm border-b dark:bg-slate-700 dark:border-slate-600 focus:outline-none';
            searchInput.value = filterText;
            
            const listContainer = document.createElement('div');
            listContainer.className = 'flex-grow overflow-y-auto custom-scrollbar';

            const renderList = (filter) => {
                listContainer.innerHTML = '';
                const filteredSnippets = state.snippets.filter(s => s.name.toLowerCase().includes(filter.toLowerCase()));

                if (filteredSnippets.length === 0) {
                    listContainer.innerHTML = '<div class="p-2 text-slate-500 text-sm">Brak pasujących wstawek.</div>';
                } else {
                    filteredSnippets.forEach(snippet => {
                        const item = document.createElement('div');
                        item.className = 'snippet-item';
                        item.textContent = snippet.name;
                        item.onclick = (e) => {
                            e.stopPropagation();
                            insertSnippetPlaceholder(snippet.name, activeEditor);
                            snippetDropdown.classList.add('hidden');
                        };
                        listContainer.appendChild(item);
                    });
                }
            };

            searchInput.oninput = () => renderList(searchInput.value);
            
            snippetDropdown.appendChild(searchInput);
            snippetDropdown.appendChild(listContainer);
            renderList(filterText);
        };

        const insertSnippetPlaceholder = (name, activeEditor) => {
            const editor = activeEditor || promptEditor;
            const range = editor.getSelection(true);
            
            if (!range) {
                // Jeśli nie ma selekcji, po prostu wstaw na końcu
                const length = editor.getLength();
                const placeholder = `#${name} `;
                editor.insertText(length - 1, placeholder, 'user');
                editor.setSelection(length - 1 + placeholder.length);
                return;
            }

            const textBeforeCursor = editor.getText(0, range.index);
            const lastHashIndex = textBeforeCursor.lastIndexOf('#');
            
            if (lastHashIndex === -1) {
                // Jeśli nie ma # przed kursorem, po prostu wstaw snippet na pozycji kursora
                const placeholder = `#${name} `;
                editor.insertText(range.index, placeholder, 'user');
                editor.setSelection(range.index + placeholder.length);
            } else {
                // Sprawdź czy między # a kursorem są tylko litery/cyfry/_ (bez spacji)
                const textAfterHash = textBeforeCursor.substring(lastHashIndex + 1);
                if (/^[a-zA-Z0-9_]*$/.test(textAfterHash)) {
                    // To wygląda jak niedokończony snippet - zastąp go
                    const placeholder = `#${name} `;
                    editor.deleteText(lastHashIndex, range.index - lastHashIndex, 'user');
                    editor.insertText(lastHashIndex, placeholder, 'user');
                    editor.setSelection(lastHashIndex + placeholder.length);
                } else {
                    // Między # a kursorem są inne znaki - wstaw snippet na pozycji kursora
                    const placeholder = `#${name} `;
                    editor.insertText(range.index, placeholder, 'user');
                    editor.setSelection(range.index + placeholder.length);
                }
            }
        };

        function _clamp(n,min,max){ return Math.min(max, Math.max(min,n)); }
        function _parseColor(c){
            if(!c) return null;
            if(/^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(c)){
                let r,g,b;
                if(c.length===4){ r=parseInt(c[1]+c[1],16); g=parseInt(c[2]+c[2],16); b=parseInt(c[3]+c[3],16); }
                else { r=parseInt(c.slice(1,3),16); g=parseInt(c.slice(3,5),16); b=parseInt(c.slice(5,7),16); }
                return {r,g,b};
            }
            const m = String(c).match(/rgba?\s*\(\s*([\d.]+)[,\s]+([\d.]+)[,\s]+([\d.]+)/i);
            return m ? { r:+m[1], g:+m[2], b:+m[3] } : null;
        }
        function _rgbToHsl(r,g,b){
            r/=255; g/=255; b/=255;
            const max=Math.max(r,g,b), min=Math.min(r,g,b);
            let h=0,s=0,l=(max+min)/2;
            if(max!==min){
                const d=max-min;
                s = l>0.5 ? d/(2-max-min) : d/(max+min);
                switch(max){
                    case r: h=(g-b)/d+(g<b?6:0); break;
                    case g: h=(b-r)/d+2; break;
                    case b: h=(r-g)/d+4; break;
                }
                h*=60;
            }
            return {h,s,l};
        }
        function _hslToRgb(h,s,l){
            s=_clamp(s,0,1); l=_clamp(l,0,1); h=(h%360+360)%360;
            const c=(1-Math.abs(2*l-1))*s, x=c*(1-Math.abs((h/60)%2-1)), m=l-c/2;
            let r=0,g=0,b=0;
            if(h<60){ r=c; g=x; }
            else if(h<120){ r=x; g=c; }
            else if(h<180){ g=c; b=x; }
            else if(h<240){ g=x; b=c; }
            else if(h<300){ r=x; b=c; }
            else { r=c; b=x; }
            return { r:Math.round((r+m)*255), g:Math.round((g+m)*255), b:Math.round((b+m)*255) };
        }
        function _rgbToHex(r,g,b){ return '#'+[r,g,b].map(v=>v.toString(16).padStart(2,'0')).join(''); }
function derivePalette(base){
    const p=_parseColor(base);
    if(!p){
        return {
            bg:'#f1f5f9',
            line:'#94a3b8',
            dotStrong:'#64748b',
            highlight:'#e2e8f0',
            hasColor:false
        };
    }
    const {h,s,l}=_rgbToHsl(p.r,p.g,p.b);
    
    // Mocniejsze, bardziej wyraziste kolory dla lepszej widoczności
    const bg = base;
    const lineS=_clamp(s*1.3,0,1), lineL=_clamp(l*0.5,0,1);
    const lineRGB=_hslToRgb(h,lineS,lineL), line=_rgbToHex(lineRGB.r,lineRGB.g,lineRGB.b);

    const dotS=_clamp(Math.max(s,0.6)*1.4,0,1), dotL=_clamp(l*0.35,0,1);
    const dotRGB=_hslToRgb(h,dotS,dotL), dotStrong=_rgbToHex(dotRGB.r,dotRGB.g,dotRGB.b);

    const hlS=_clamp(s*0.8,0,1), hlL=_clamp(l + (1-l)*0.4, 0, 1);
    const hlRGB=_hslToRgb(h,hlS,hlL), highlight=_rgbToHex(hlRGB.r,hlRGB.g,hlRGB.b);

    return { bg, line, dotStrong, highlight, hasColor:true };
}

        // --- 8. CORE RENDER FUNCTIONS / GŁÓWNE FUNKCJE RENDERUJĄCE ---
        const renderAll = () => {
            renderTreeView();
            renderFavoritesBar();
            updateMainView();
            updateSidebarTop();
        };
        
        const updateFavoritesScrolling = () => {
            setTimeout(() => {
                const isScrollable = favoritesContainer.scrollWidth > favoritesContainer.clientWidth;
                const atStart = favoritesContainer.scrollLeft < 1;
                const atEnd = favoritesContainer.scrollLeft + favoritesContainer.clientWidth >= favoritesContainer.scrollWidth - 1;

                favLeftBtn.classList.toggle('hidden', !isScrollable || atStart);
                favRightBtn.classList.toggle('hidden', !isScrollable || atEnd);

                const fadeLeft = favoritesBar.querySelector('.favorites-fade-left');
                const fadeRight = favoritesBar.querySelector('.favorites-fade-right');
                if (fadeLeft) fadeLeft.classList.toggle('hidden', !isScrollable || atStart);
                if (fadeRight) fadeRight.classList.toggle('hidden', !isScrollable || atEnd);
            }, 50);
        };

        const renderFavoritesBar = () => {
            favoritesContainer.innerHTML = '';
            let favorites = [];
            state.projects.forEach(project => {
                project.prompts.forEach(prompt => {
                    if (prompt.isFavorite) {
                        favorites.push({ ...prompt, projectId: project.id, projectColor: project.color });
                    }
                });
            });
            
            favorites.sort((a, b) => (a.favoriteOrder || 0) - (b.favoriteOrder || 0));

            if (favorites.length > 0) {
                favoritesBar.classList.remove('hidden');
                favorites.forEach(fav => {
                    const favChip = document.createElement('div');
                    favChip.className = 'flex-shrink-0 cursor-pointer flex items-center gap-3 pl-4 pr-5 py-3 rounded-2xl bg-white/90 dark:bg-slate-800/90 text-slate-800 dark:text-slate-200 border border-slate-200/60 dark:border-slate-700/60 hover:bg-white dark:hover:bg-slate-700 hover:shadow-lg hover:scale-[1.02] transition-all duration-200 backdrop-blur-sm';
                    const _palFav = derivePalette(fav.projectColor);
                    favChip.innerHTML = `<div class="w-5 h-5 rounded-lg flex items-center justify-center" style="background-color: ${escapeHtml(_palFav.dotStrong)};">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M11.48 3.499a.562.562 0 011.04 0l2.125 5.111a.563.563 0 00.475.345l5.518.442c.499.04.701.663.321.988l-4.204 3.602a.563.563 0 00-.182.557l1.285 5.385a.562.562 0 01-.84.61l-4.725-2.885a.563.563 0 00-.586 0L6.982 20.54a.562.562 0 01-.84-.61l1.285-5.386a.562.562 0 00-.182-.557l-4.204-3.602a.563.563 0 01.321-.988l5.518-.442a.563.563 0 00.475-.345L11.48 3.5z"/></svg>
                                         </div>
                                         <span class="font-medium truncate text-slate-800 dark:text-slate-200" style="max-width: 18ch;">${escapeHtml(fav.name)}</span>
                                         <button class="remove-favorite-btn w-5 h-5 rounded-full bg-slate-200/80 dark:bg-slate-700/80 hover:bg-red-100 dark:hover:bg-red-900/50 flex items-center justify-center transition-all duration-200 ml-auto hover:scale-110" data-project-id="${fav.projectId}" data-prompt-id="${fav.id}">                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 text-slate-500 dark:text-slate-400 hover:text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
                                         </button>`;
                    favChip.className = 'group flex-shrink-0 cursor-pointer flex items-center gap-3 pl-4 pr-3 py-3 rounded-2xl bg-gradient-to-br from-white/95 via-violet-50 to-purple-50 dark:from-slate-700 dark:to-slate-600/90 text-slate-800 dark:text-slate-100 border-2 border-white/60 dark:border-slate-500/80 hover:shadow-2xl hover:scale-[1.05] hover:border-violet-300 dark:hover:border-violet-500 transition-all duration-300 backdrop-blur-sm shadow-xl shadow-violet-500/20';
                    favChip.dataset.projectId = fav.projectId;
                    favChip.dataset.promptId = fav.id;
                    favChip.dataset.type = 'favorite';
                    favChip.draggable = true;
                    favChip.onclick = () => { selectProject(fav.projectId); selectPrompt(fav.id); };
                    favoritesContainer.appendChild(favChip);
                });
            } else {
                favoritesBar.classList.add('hidden');
            }
            updateSidebarTop();
            updateFavoritesScrolling();
        };
        
        // Re-implemented the missing renderTreeView function
        const renderTreeView = () => {
    const searchTerm = (treeSearch.value || '').trim().toLowerCase();
    let projectsToRender = Array.isArray(state.projects) ? state.projects : [];

    if (searchTerm) {
        projectsToRender = projectsToRender
          .map(p => {
            const matchingPrompts = (p.prompts || []).filter(pr =>
              (pr.name || '').toLowerCase().includes(searchTerm)
            );
            if ((p.name || '').toLowerCase().includes(searchTerm) || matchingPrompts.length > 0) {
                return { ...p, prompts: p.name.toLowerCase().includes(searchTerm) ? p.prompts : matchingPrompts };
            }
            return null;
          })
          .filter(Boolean);
    }

    const sortedProjects = sortArray(projectsToRender, state.sortMode);
    treeViewList.innerHTML = '';

    if (sortedProjects.length === 0 && searchTerm.length > 0) {
        treeViewList.innerHTML = `<li class="text-center text-slate-500 p-4">Brak pasujących wyników.</li>`;
        return;
    }
    if (sortedProjects.length === 0) {
        treeViewList.innerHTML = `<li class="text-center text-slate-500 p-4">Brak projektów. Kliknij "Nowy projekt", aby zacząć.</li>`;
        return;
    }

    sortedProjects.forEach(project => {
        const projectLi = document.createElement('li');
        let projectClasses = 'tree-item tree-item-project mb-2 interactive-card';
        if (isInitialLoad) {
            projectClasses += ' stagger-item slide-in-up';
        }
        projectLi.className = projectClasses;
        projectLi.dataset.type = 'project';
        projectLi.dataset.id = project.id;

        const isSelected = state.selectedProjectId === project.id && !state.selectedPromptId;
        const sortedPrompts = sortArray(project.prompts || [], state.sortMode);

       projectLi.innerHTML = `
          <div class="tree-item-content ${isSelected ? 'selected' : ''}">
            <div class="tree-item-details">
              <span class="drag-handle cursor-grab">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-slate-400" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" /></svg>
              </span>
              <span class="tree-toggle ${project.isExpanded ? 'expanded' : ''}">
                <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
              </span>
              <div class="relative">
    <button class="color-dot w-6 h-6 rounded-lg flex-shrink-0 border-2 border-white dark:border-slate-800 shadow-sm transition-all duration-200 hover:scale-110 cursor-pointer relative" data-action="set-color" data-tooltip="Zmień kolor" style="background-color: var(--dot-strong, #64748b);">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 text-white absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 opacity-0 hover:opacity-100 transition-opacity" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01"/></svg>
    </button>
    <div class="color-picker-panel" id="color-picker-${project.id}">
        <!-- Color options will be generated by JavaScript -->
    </div>
</div>
              <span class="tree-item-name" id="project-name-${project.id}">${escapeHtml(project.name || '')}</span>
            </div>
            <div class="tree-actions">
              <button data-action="add-prompt" data-tooltip="Dodaj prompt" class="p-1 text-slate-400 hover:text-green-500">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v6m3-3H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
              </button>
              <button data-action="rename-project" data-tooltip="Zmień nazwę" class="p-1 text-slate-400 hover:text-blue-500">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L6.832 19.82a4.5 4.5 0 01-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 011.13-1.897L16.863 4.487zm0 0L19.5 7.125" /></svg>
              </button>
              <button data-action="delete-project" data-tooltip="Usuń" class="p-1 text-slate-400 hover:text-red-500">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.134-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.067-2.09 1.02-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" /></svg>
              </button>
            </div>
          </div>
        `;

        // USTAWIENIE PALETY POD PROJEKT
        projectLi.classList.add('project-block');
        const pal = derivePalette(project.color);

        projectLi.style.setProperty('--project-bg', pal.bg);
        projectLi.style.setProperty('--line-color', pal.line);
        projectLi.style.setProperty('--dot-strong', pal.dotStrong);
        projectLi.style.setProperty('--highlight', pal.highlight);
        projectLi.setAttribute('data-hascolor', pal.hasColor ? '1' : '0');

        // lista promptów
        const promptsUl = document.createElement('ul');
        promptsUl.className = 'prompt-list';
        promptsUl.style.display = project.isExpanded ? 'block' : 'none';

if (sortedPrompts.length > 0) {
            sortedPrompts.forEach(pr => {
                const promptLi = document.createElement('li');
                promptLi.className = 'tree-item tree-item-prompt';
                promptLi.dataset.type = 'prompt';
                promptLi.dataset.id = pr.id;
                promptLi.dataset.projectId = project.id;

                const isPromptSelected = state.selectedProjectId === project.id && state.selectedPromptId === pr.id;

                const versionCount = pr.versions ? pr.versions.length : 0;
                promptLi.innerHTML = `
        <div class="tree-item-content ${isPromptSelected ? 'selected' : ''}">
          <div class="tree-item-details">
            <span class="drag-handle cursor-grab">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-slate-400" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" /></svg>
            </span>
            <span class="tree-item-name" id="prompt-name-${pr.id}">${escapeHtml(pr.name || '')}</span>
            ${versionCount > 1 ? `<span class="ml-1.5 px-1.5 py-0.5 text-xs font-medium bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 rounded" title="${versionCount} wersji">v${versionCount}</span>` : ''}
          </div>
          <div class="tree-actions">
            <button data-action="toggle-favorite" data-tooltip="Ulubione" class="p-1 text-slate-400 hover:text-amber-500">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="${pr.isFavorite ? 'currentColor' : 'none'}"><path stroke-linecap="round" stroke-linejoin="round" d="M11.48 3.499a.562.562 0 011.04 0l2.125 5.111a.563.563 0 00.475.345l5.518.442c.499.04.701.663.321.988l-4.204 3.602a.563.563 0 00-.182.557l1.285 5.385a.562.562 0 01-.84.61l-4.725-2.885a.563.563 0 00-.586 0L6.982 20.54a.562.562 0 01-.84-.61l1.285-5.386a.562.562 0 00-.182-.557l-4.204-3.602a.563.563 0 01.321-.988l5.518-.442a.563.563 0 00.475-.345L11.48 3.5z" /></svg>
            </button>
            <button data-action="rename-prompt" data-tooltip="Zmień nazwę" class="p-1 text-slate-400 hover:text-blue-500">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L6.832 19.82a4.5 4.5 0 01-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 011.13-1.897L16.863 4.487zm0 0L19.5 7.125" /></svg>
            </button>
            <button data-action="duplicate-prompt" data-tooltip="Duplikuj" class="p-1 text-slate-400 hover:text-purple-500">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 01-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 011.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 00-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 01-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 00-3.375-3.375h-1.5a1.125 1.125 0 01-1.125-1.125v-1.5a3.375 3.375 0 00-3.375-3.375H9.75" /></svg>
            </button>
            <button data-action="delete-prompt" data-tooltip="Usuń" class="p-1 text-slate-400 hover:text-red-500">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.134-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.067-2.09 1.02-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" /></svg>
            </button>
          </div>
        </div>
      `;
                promptsUl.appendChild(promptLi);
            });
        } else {
            // Display a placeholder if there are no prompts
            const placeholderLi = document.createElement('li');
            placeholderLi.className = 'px-3 py-2 text-sm text-slate-500 text-center';
            placeholderLi.innerHTML = `Ten projekt jest pusty. <button data-action="add-prompt" class="font-semibold text-accent-600 hover:underline">Dodaj prompt</button>`;
            promptsUl.appendChild(placeholderLi);
        }

                projectLi.appendChild(promptsUl);
                treeViewList.appendChild(projectLi);
            });
    if (isInitialLoad) {
        isInitialLoad = false;
    }
    
    // Inicjalizuj color pickery dla wszystkich projektów
    setTimeout(() => {
        sortedProjects.forEach(project => {
            const dotElement = document.querySelector(`.tree-item[data-id="${project.id}"] .color-dot`);
            if (dotElement) {
                dotElement.onclick = (e) => {
                    e.stopPropagation();
                    openColorPopover(dotElement, (selectedColor) => {
                        const proj = findProject(project.id);
                        if (proj) {
                            proj.color = selectedColor;
                            saveData();
                            renderTreeView();
                        }
                    });
                };
            }
        });
    }, 100);
};

        // --- 9. UI/VIEW UPDATE FUNCTIONS / FUNKCJE AKTUALIZUJĄCE INTERFEJS UŻYTKOWNIKA ---
        const updateLockTooltip = () => {
            const tooltipContainer = editorLockCheckbox.closest('[data-tooltip]');
            if (!tooltipContainer) return;

            if (editorLockCheckbox.checked) {
                tooltipContainer.dataset.tooltip = "Edycja jest zablokowana. Kliknij, aby odblokować.";
            } else {
                tooltipContainer.dataset.tooltip = "Edycja jest włączona. Kliknij, aby zablokować i zapobiec przypadkowym zmianom.";
            }
        };
        const setEditorLock = (isLocked) => {
            promptEditor.enable(!isLocked);
            chainQuillInstances.forEach(quill => quill.enable(!isLocked));
            editorLockCheckbox.checked = isLocked;
            
            // Dodaj/usuń klasę dla zablokowanego edytora
            const editorContainer = document.getElementById('prompt-editor-quill-container');
            const lockMessage = document.getElementById('editor-lock-message');
            
            if (isLocked) {
                editorContainer.classList.add('editor-locked');
                if (!lockMessage) {
                    const message = document.createElement('div');
                    message.id = 'editor-lock-message';
                    message.className = 'absolute inset-0 bg-slate-50/80 dark:bg-slate-800/80 backdrop-blur-sm flex items-center justify-center z-10 rounded-lg';
                    message.innerHTML = `
                        <div class="text-center p-4">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-slate-400 mx-auto mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                            </svg>
                            <p class="text-slate-600 dark:text-slate-300 text-sm">Edycja promptu jest zablokowana.</p>
                            <p class="text-slate-500 dark:text-slate-400 text-xs mt-1">Odblokuj ją, klikając ikonę kłódki powyżej.</p>
                        </div>
                    `;
                    editorContainer.appendChild(message);
                }
            } else {
                editorContainer.classList.remove('editor-locked');
                if (lockMessage) {
                    lockMessage.remove();
                }
            }
        };


        const updateMainView = () => {
            const project = getSelectedProject();
            const prompt = getSelectedPrompt();
            const projectOverview = document.getElementById('project-overview');
            const breadcrumbNav = document.getElementById('breadcrumb-nav');

            console.log('updateMainView - project:', project?.name, 'prompt:', prompt?.name); // Debug

            if (prompt) { // A prompt is selected, show the editor and breadcrumb
                placeholderView.classList.add('hidden');
                if(projectOverview) projectOverview.classList.add('hidden');
                editorView.classList.remove('hidden');
                breadcrumbNav.classList.remove('hidden');
                floatingCopyBtn.classList.remove('hidden');
                renderEditor();
            } else if (project) { // Only a project is selected, show its overview and hide breadcrumb
                placeholderView.classList.add('hidden');
                editorView.classList.add('hidden');
                if(projectOverview) {
                    projectOverview.classList.remove('hidden');
                    console.log('Showing project overview for:', project.name); // Debug
                }
                breadcrumbNav.classList.add('hidden');
                floatingCopyBtn.classList.add('hidden');
                renderProjectOverview(project.id);
            } else { // Nothing is selected, show the placeholder and hide breadcrumb
                editorView.classList.add('hidden');
                if(projectOverview) projectOverview.classList.add('hidden');
                placeholderView.classList.remove('hidden');
                breadcrumbNav.classList.add('hidden');
                floatingCopyBtn.classList.add('hidden');
            }
            updateBreadcrumb();
        };

        const renderEditor = () => {
            const prompt = getSelectedPrompt();
            if (!prompt) return;
            renderSimpleEditor();
        };

       const renderSimpleEditor = () => {
    mainEditorArea.innerHTML = '';
    mainEditorArea.appendChild(simpleEditorContainer);
    
    changePromptTypeBtn.classList.add('hidden');
    editorLockCheckbox.parentElement.parentElement.classList.remove('hidden');
    assistantContainer.classList.remove('hidden');
    versionManager.classList.remove('hidden');

    const prompt = getSelectedPrompt();
    if (!prompt) return;

    const promptTypeBadge = document.getElementById('prompt-type-badge');
    if (promptTypeBadge) {
        promptTypeBadge.textContent = 'Prompt';
        promptTypeBadge.className = 'px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-medium';
    }

    updateVersionDropdown();

    const version = getSelectedVersion();
    if (version) {
        console.log('🔄 Loading version content:', version.name);
        
        // Wyłącz autosave podczas ładowania
        debouncedAutoSave.cancel();
        
        // POPRAWKA: Niezawodne ładowanie zawartości
        const contentToLoad = version.content || '';
        console.log('🔄 Loading content into editor, length:', contentToLoad.length);
        
        // Wyłącz listenery na czas ładowania
        promptEditor.off('text-change');
        
        if (contentToLoad.trim()) {
            promptEditor.root.innerHTML = DOMPurify.sanitize(contentToLoad);
        } else {
            promptEditor.setText(''); // Wyczyść edytor jeśli brak zawartości
        }
        
        // Poczekaj chwilę i ponownie podłącz listenery
        setTimeout(() => {
            setupEditorListeners(promptEditor);
        }, 100);
        
        // Test - sprawdź czy zawartość została załadowana
        setTimeout(() => {
            const loadedContent = promptEditor.container.querySelector('.ql-editor').innerHTML;
            console.log('✅ Content loaded verification, length:', loadedContent.length);
        }, 100);
        
        assistantContent.value = version.assistantContent || '';
        assistantWrapper.classList.toggle('hidden', !version.isAssistantVisible);
        toggleAssistantBtn.classList.toggle('rotate-180', version.isAssistantVisible);
        
        updateVersionDatesDisplay();
        setEditorLock(editorLockCheckbox.checked);
        updateLockTooltip();
    } else {
        promptEditor.root.innerHTML = '';
        assistantContent.value = '';
        versionDatesDisplay.innerHTML = '';
    }
    
    renderVariableInputs();
    updatePromptTitleDisplay();
    updatePromptIconColor();
    setTimeout(() => updateCombinedOutput(), 50);
};
        
        const updateVersionDatesDisplay = () => {
            const version = getSelectedVersion();
            if (version) {
                versionDatesDisplay.innerHTML = `Utw: ${formatDate(version.createdAt)} | Akt: ${formatDate(version.updatedAt)}`;
            } else {
                versionDatesDisplay.innerHTML = '';
            }
        };

        const updateSidebarTop = () => {
            const headerHeight = mainHeader.offsetHeight;
            const favBarVisible = !favoritesBar.classList.contains('hidden');
            const favBarHeight = favBarVisible ? favoritesBar.offsetHeight : 0;
            favoritesBar.style.top = `${headerHeight}px`;
            const mainEl = document.querySelector('main');
            if (mainEl) mainEl.style.paddingTop = `${favBarVisible ? favBarHeight + 16 : 16}px`;
            const totalTop = headerHeight + favBarHeight;
            document.documentElement.style.setProperty('--sidebar-top', `${totalTop}px`);
        };

        // --- ADAPTIVE WORKSPACE FUNCTIONS ---
        const initializeAdaptiveWorkspace = () => {
            // Set initial sidebar width
            if (window.innerWidth >= 1024) {
                leftSidebar.style.width = sidebarWidth;
                leftSidebar.style.position = 'relative';
            }
            
            // Initialize breadcrumb
            updateBreadcrumb();
            

        };

        const updateBreadcrumb = () => {
            const project = getSelectedProject();
            const prompt = getSelectedPrompt();
            
            if (!project && !prompt) {
                // Visibility is now controlled by updateMainView, so we just exit
                return;
            }
            
            if (project) {
                breadcrumbProjectName.textContent = project.name;
                breadcrumbProject.style.display = 'flex';
                separator1.style.display = 'block';
                
                if (prompt) {
                    breadcrumbPromptName.textContent = prompt.name;
                    breadcrumbPrompt.style.display = 'flex';
                    separator2.style.display = 'block';
                    breadcrumbProject.classList.add('clickable');
                    breadcrumbProject.classList.remove('breadcrumb-current');
                    breadcrumbPrompt.classList.add('breadcrumb-current');
                } else {
                    breadcrumbPrompt.style.display = 'none';
                    separator2.style.display = 'none';
                    breadcrumbProject.classList.add('clickable');
        breadcrumbProject.classList.remove('breadcrumb-current');
                    breadcrumbPrompt.classList.remove('breadcrumb-current');
                }
            } else {
        breadcrumbProject.style.display = 'none';
        breadcrumbPrompt.style.display = 'none';
        separator1.style.display = 'none';
        separator2.style.display = 'none';
    }
    
    // "Wszystkie projekty" zawsze nieklikalne
    const homeItem = breadcrumbNav.querySelector('[data-level="home"]');
    if (homeItem) {
        homeItem.classList.remove('clickable');
    }
        };

        const renderProjectOverview = (projectId) => {
            console.log('renderProjectOverview called with projectId:', projectId); // Debug
            
            const project = findProject(projectId);
            if (!project) {
                console.log('Project not found!'); // Debug
                return;
            }

            console.log('Found project:', project.name, 'with', project.prompts.length, 'prompts'); // Debug

            const projectOverview = document.getElementById('project-overview');
            const projectTitle = document.getElementById('project-title');
            const projectStats = document.getElementById('project-stats');
            const promptsGrid = document.getElementById('prompts-grid');

            if (!projectOverview || !projectTitle || !projectStats || !promptsGrid) {
                console.log('Missing DOM elements!', {projectOverview, projectTitle, projectStats, promptsGrid}); // Debug
                return;
            }

            projectTitle.textContent = project.name;
            projectStats.textContent = `${project.prompts.length} promptów • Utworzony ${formatDate(project.createdAt)}`;

            promptsGrid.innerHTML = project.prompts.map(prompt => {
                // Pobierz paletę kolorów dla KAŻDEGO promptu z jego projektu
                const palette = derivePalette(project.color);
                const iconColor = palette.dotStrong;
                
                return `
                <div class="group bg-white/80 dark:bg-slate-800/80 backdrop-blur-sm rounded-2xl p-6 border border-slate-200/60 dark:border-slate-700/60 hover:shadow-xl hover:scale-[1.02] transition-all duration-300 cursor-pointer" onclick="selectPrompt('${project.id}', '${prompt.id}')">
                    <div class="flex items-start justify-between mb-4">
                        <div class="w-12 h-12 rounded-xl flex items-center justify-center text-white shadow-lg" style="background: linear-gradient(135deg, ${iconColor} 0%, ${palette.line} 100%);">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 002.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 00-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 00.75-.75 2.25 2.25 0 00-.1-.664m-5.8 0A2.251 2.251 0 0113.5 2.25H15c1.012 0 1.867.668 2.15 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m0 0H4.875c-.621 0-1.125.504-1.125 1.125v11.25c0 .621.504 1.125 1.125 1.125h9.75c0 .621-.504 1.125-1.125 1.125H18a2.25 2.25 0 01-2.25-2.25V9.375c0-.621.504-1.125 1.125-1.125H16.5a2.25 2.25 0 011.5.75"/>
                            </svg>
                        </div>
                        ${prompt.isFavorite ? `
                        <div class="w-6 h-6 rounded-full bg-amber-100 dark:bg-amber-900/30 flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-amber-600 dark:text-amber-400" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M11.48 3.499a.562.562 0 011.04 0l2.125 5.111a.563.563 0 00.475.345l5.518.442c.499.04.701.663.321.988l-4.204 3.602a.563.563 0 00-.182.557l1.285 5.385a.562.562 0 01-.84.61l-4.725-2.885a.563.563 0 00-.586 0L6.982 20.54a.562.562 0 01-.84-.61l1.285-5.386a.562.562 0 00-.182-.557l-4.204-3.602a.563.563 0 01.321-.988l5.518-.442a.563.563 0 00.475-.345L11.48 3.5z"/>
                            </svg>
                        </div>` : ''}
                    </div>
                    <h3 class="font-semibold text-slate-900 dark:text-white mb-2 group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors">${escapeHtml(prompt.name)}</h3>
                    <p class="text-sm text-slate-600 dark:text-slate-400 mb-4">${prompt.type === 'simple' ? `${prompt.versions?.length || 0} wersji` : `${prompt.steps?.length || 0} kroków`}</p>
                    <div class="text-xs text-slate-500 dark:text-slate-500">Ostatnio: ${formatDate(prompt.updatedAt)}</div>
                </div>
                `;
            }).join('');

            console.log('Project overview rendered successfully'); // Debug

            // Show project overview, hide others
            projectOverview.classList.remove('hidden');
            editorView.classList.add('hidden');
            placeholderView.classList.add('hidden');
            floatingCopyBtn.classList.add('hidden');
        };



        const toggleFocusMode = () => {
            focusMode = !focusMode;
            
            if (focusMode) {
                // Enter focus mode
                leftSidebar.classList.add('transitioning', 'collapsed');
                rightPanel.classList.add('transitioning', 'expanded');
                focusModeToggle.classList.add('visible');
                
                // Update button icon to show "expand" icon
                focusModeToggle.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h8m-8 6h16" />
                    </svg>
                `;
                
                showToast('Focus Mode: Włączony');
            } else {
                // Exit focus mode
                leftSidebar.classList.remove('collapsed');
                rightPanel.classList.remove('expanded');
                focusModeToggle.classList.remove('visible');
                
                setTimeout(() => {
                    leftSidebar.classList.remove('transitioning');
                    rightPanel.classList.remove('transitioning');
                }, 300);
                
                showToast('Focus Mode: Wyłączony');
            }
            
            localStorage.setItem('focusMode', focusMode);
        };


        // Resize functionality
        const startResize = (e) => {
    if (window.innerWidth < 1024) return;
    
    isResizing = true;
    startX = e.clientX;
    startWidth = leftSidebar.offsetWidth;
    
    resizeHandle.classList.add('dragging');
    workspaceControls.classList.add('visible'); // Pokaż kontrolki
    document.body.style.cursor = 'col-resize';
    document.body.style.userSelect = 'none';
    
    // Add overlay to prevent iframe interference
    const overlay = document.createElement('div');
    overlay.id = 'resize-overlay';
    overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;z-index:9999;cursor:col-resize;';
    document.body.appendChild(overlay);
};

let lastClientX = 0;
const doResize = (e) => {
    lastClientX = e.clientX;
    if (!isResizing || ticking) return;

    ticking = true;
    window.requestAnimationFrame(() => {
        const deltaX = lastClientX - startX;
        const newWidth = startWidth + deltaX;
        const containerWidth = leftSidebar.parentElement.offsetWidth;
        const percentWidth = (newWidth / containerWidth) * 100;

        // Limit between 20% and 50%
        if (percentWidth >= 20 && percentWidth <= 50) {
            leftSidebar.style.width = `${percentWidth}%`;
            sidebarWidth = `${percentWidth}%`;
        }
        ticking = false;
    });
};

        const stopResize = () => {
            if (!isResizing) return;
            
            isResizing = false;
            resizeHandle.classList.remove('dragging');
            document.body.style.cursor = '';
            document.body.style.userSelect = '';
            
            // Remove overlay
            const overlay = document.getElementById('resize-overlay');
            if (overlay) overlay.remove();
            
            // Save width to localStorage
            localStorage.setItem('sidebarWidth', sidebarWidth);
        };

        // --- 10. CRUD & ACTION HANDLERS / OBSŁUGA AKCJI I OPERACJI CRUD ---

        const selectProject = (projectId) => {
            const project = findProject(projectId);
            if (!project) return;

            console.log('💾 Changing project selection, saving current content');
            if (typeof autoSaveChanges === 'function') {
                autoSaveChanges();
            }

            const isAlreadySelected = state.selectedProjectId === projectId;
            const wasExpanded = project.isExpanded;

            state.projects.forEach(p => {
                p.isExpanded = false;
            });

            if (isAlreadySelected && wasExpanded) {
                project.isExpanded = false;
                state.selectedProjectId = null;
                state.selectedPromptId = null;
                state.selectedVersionId = null;
            } else {
                project.isExpanded = true;
                state.selectedProjectId = projectId;
                state.selectedPromptId = null;
                state.selectedVersionId = null;
            }

            saveData();
            renderTreeView();
            updateMainView();
            updatePromptIconColor();
        };

        const selectPrompt = (projectId, promptId) => {
            if (state.selectedPromptId === promptId && state.selectedProjectId === projectId) return;

            console.log('💾 Changing prompt selection, saving current content');
            if (typeof autoSaveChanges === 'function') {
                autoSaveChanges();
            }

            state.selectedProjectId = projectId;
            state.selectedPromptId = promptId;

            const prompt = getSelectedPrompt();
            if (prompt && prompt.type === 'simple' && prompt.versions?.length > 0) {
                state.selectedVersionId = prompt.versions[0].id;
            } else {
                state.selectedVersionId = null;
            }

            renderTreeView();
            updateMainView();
        };
        window.selectPrompt = selectPrompt; 

const selectVersion = (versionId) => {
            if (state.selectedVersionId !== versionId) {
                // Natychmiast zapisz obecną treść przed zmianą wersji
                console.log('💾 Changing version, saving current content first');
                if (typeof autoSaveChanges === 'function') {
                    autoSaveChanges();
                }
                
                // Zmień wersję i odśwież edytor
                state.selectedVersionId = versionId;
                saveData(); // Zapisz zmianę wybranej wersji
                renderEditor();
                setTimeout(() => updateCombinedOutput(), 100);
            }
        };

        const addProject = () => {
            let newProjectName;
            let counter = state.projects.length + 1;
            do {
                newProjectName = `Nowy Projekt ${counter}`;
                counter++;
            } while (state.projects.some(p => p.name === newProjectName));

            const now = Date.now();
            const newVersion = { id: generateId(), name: 'Wersja 1', content: '', createdAt: now, updatedAt: now, isAssistantVisible: true, assistantContent: '' };
            const newPrompt = {
                id: generateId(),
                type: 'simple',
                name: `Nowy Prompt 1`,
                versions: [newVersion],
                isFavorite: false,
                createdAt: now,
                updatedAt: now,
                isExpanded: true,
                color: null
            };

            const newProject = {
                id: generateId(),
                name: newProjectName,
                prompts: [newPrompt],
                isExpanded: true,
                createdAt: now,
                updatedAt: now,
                color: '#f1f5f9'
            };

            state.projects.unshift(newProject);
            state.selectedProjectId = newProject.id;
            state.selectedPromptId = newPrompt.id;
            state.selectedVersionId = newVersion.id;

            saveData();
            renderAll();

            setTimeout(() => {
                const renameBtn = document.querySelector(`.tree-item-project[data-id="${newProject.id}"] [data-action="rename-project"]`);
                if (renameBtn) {
                    renameBtn.click();
                }
            }, 50);
        };

        const addPromptHandler = (projectId = null) => {
            const targetProjectId = projectId || state.selectedProjectId;

            if (!targetProjectId) {
                showToast('Najpierw wybierz projekt.', 'error');
                return;
            }

            const project = findProject(targetProjectId);
            if (!project) {
                showToast('Projekt nie istnieje.', 'error');
                return;
            }

            state.projects.forEach(p => {
                if (p.id !== targetProjectId) {
                    p.isExpanded = false;
                }
            });

            let newPromptName;
            let counter = project.prompts.length + 1;
            do {
                newPromptName = `Nowy Prompt ${counter}`;
                counter++;
            } while (project.prompts.some(p => p.name === newPromptName));

            const now = Date.now();
            const newVersion = { id: generateId(), name: 'Wersja 1', content: '', createdAt: now, updatedAt: now, isAssistantVisible: true, assistantContent: '' };
            const newPrompt = { id: generateId(), type: 'simple', name: newPromptName, versions: [newVersion], isFavorite: false, createdAt: now, updatedAt: now, isExpanded: true, color: null };
            
            project.prompts.unshift(newPrompt);
            project.isExpanded = true; 
            project.updatedAt = now;
            
            state.selectedProjectId = targetProjectId;
            state.selectedPromptId = newPrompt.id;
            state.selectedVersionId = newVersion.id;
            
            saveData();
            renderAll();
        };

        const deleteProject = (projectId) => {
            state.projects = state.projects.filter(p => p.id !== projectId);
            if (state.selectedProjectId === projectId) {
                state.selectedProjectId = null;
                state.selectedPromptId = null;
                state.selectedVersionId = null;
            }
            saveData();
            renderTreeView();
            updateMainView();
        };
        
        const deletePrompt = (projectId, promptId) => {
            const project = findProject(projectId);
            if (project) {
                project.prompts = project.prompts.filter(p => p.id !== promptId);
                if (state.selectedPromptId === promptId) {
                    state.selectedPromptId = null;
                    state.selectedVersionId = null;
                }
                saveData();
                renderTreeView();
                if (state.selectedProjectId === projectId) {
                    updateMainView();
                }
            }
        };
        
        const updateProjectName = (id, newName) => { 
            const p = findProject(id); 
            if (p) { 
                p.name = newName; 
                p.updatedAt = Date.now(); 
                renderTreeView(); 
                saveData(); 
            } 
        };
        
        const updatePromptName = (projectId, promptId, newName) => { 
            const p = findPrompt(projectId, promptId); 
            if (p) { 
                p.name = newName; 
                p.updatedAt = Date.now(); 
                findProject(projectId).updatedAt = p.updatedAt; 
                renderAll(); 
                saveData(); 
            } 
        };
        
        const updateVersionName = (projectId, promptId, versionId, newName) => { 
            const v = findVersion(projectId, promptId, versionId); 
            if (v) { 
                v.name = newName; 
                v.updatedAt = Date.now(); 
                findPrompt(projectId, promptId).updatedAt = v.updatedAt; 
                findProject(projectId).updatedAt = v.updatedAt; 
                renderAll(); 
                saveData(); 
            } 
        };

        // --- 11. DRAG & DROP LOGIC / LOGIKA PRZECIĄGNIJ I UPUŚĆ ---
        let draggedItem = null;
        // Funkcja do rozwijania projektu podczas przeciągania
        const expandProjectForDrag = (projectId) => {
            const project = findProject(projectId);
            if (project && !project.isExpanded) {
                project.isExpanded = true;
                renderTreeView();
            }
        };
        let placeholder = null;
        let isDragHandleActive = false;
        let expandProjectTimeout = null;
        let hoveredProjectId = null;

        const createDragPlaceholder = () => {
    const p = document.createElement('li');
    p.className = 'drag-over-placeholder drag-particles liquid-transition';
    return p;
};

        const handleFavoritesDragStart = (e) => {
            draggedItem = e.target;
            setTimeout(() => { if(draggedItem) draggedItem.classList.add('dragging'); }, 0);
        };
        
        const handleFavoritesDragEnd = () => {
            if (draggedItem) draggedItem.classList.remove('dragging');
            draggedItem = null;
        };
        
        const handleFavoritesDragOver = (e) => {
            e.preventDefault();
            const target = e.target.closest('div[data-prompt-id]');
            if (target && target !== draggedItem) {
                const rect = target.getBoundingClientRect();
                const isAfter = e.clientX > rect.left + rect.width / 2;
                if (isAfter) target.parentNode.insertBefore(draggedItem, target.nextSibling);
                else target.parentNode.insertBefore(draggedItem, target);
            }
        };
        
        const handleFavoritesDrop = () => {
            if (!draggedItem) return;
            const children = Array.from(favoritesContainer.children);
            const newOrderIds = children.map(child => child.dataset.promptId);
            const allFavorites = [];
            state.projects.forEach(p => p.prompts.forEach(pr => { if (pr.isFavorite) allFavorites.push(pr); }));
            newOrderIds.forEach((promptId, index) => {
                const prompt = allFavorites.find(p => p.id === promptId);
                if(prompt) prompt.favoriteOrder = index;
            });
            saveData();
        };
        
        const handleTreeDragStart = (e) => {
            const li = e.target.closest('li[data-type]');
            if (!isDragHandleActive || !li || state.sortMode !== 'manual') {
                e.preventDefault();
                return;
            }

            draggedItem = li;
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', JSON.stringify({
                type: li.dataset.type,
                id: li.dataset.id,
                projectId: li.dataset.projectId
            }));
            setTimeout(() => { if (draggedItem) draggedItem.classList.add('dragging'); }, 0);
        };

        const handleTreeDragEnd = () => {
            if (draggedItem) {
                draggedItem.classList.remove('dragging');
                draggedItem.draggable = false;
            }
            if (placeholder && placeholder.parentNode) {
                placeholder.parentNode.removeChild(placeholder);
            }
            
            // Czyszczenie po zakończeniu przeciągania
            clearTimeout(expandProjectTimeout); // Anulujemy timer rozwijania
            hoveredProjectId = null;
            document.querySelectorAll('.drop-target-project').forEach(el => el.classList.remove('drop-target-project'));
            
            draggedItem = null;
            placeholder = null;
            isDragHandleActive = false;
        };
        
        const handleTreeDragOver = (e) => {
            e.preventDefault();
            if (!draggedItem || state.sortMode !== 'manual') return;

            const draggedType = draggedItem.dataset.type;
            document.querySelectorAll('.drop-target-project').forEach(el => el.classList.remove('drop-target-project'));
            
            const overProjectElement = e.target.closest('.tree-item-project');
            
            // Sprawdzamy, czy zmieniliśmy cel najechania
            const currentHoverId = overProjectElement ? overProjectElement.dataset.id : null;
            if (currentHoverId !== hoveredProjectId) {
                // Anulujemy poprzedni timer, jeśli istniał
                clearTimeout(expandProjectTimeout);
                hoveredProjectId = currentHoverId;
                
                // Jeśli najeżdżamy na nowy, zwinięty projekt, ustawiamy timer do jego rozwinięcia
                if (hoveredProjectId && draggedType === 'prompt') {
                    const project = findProject(hoveredProjectId);
                    if (project && !project.isExpanded) {
                        expandProjectTimeout = setTimeout(() => {
                            // UŻYWAMY NASZEJ NOWEJ, "LEKKIEJ" FUNKCJI
                            expandProjectForDrag(hoveredProjectId); 
                        }, 700); // 700ms opóźnienia
                    }
                }
            }

            // Logika podświetlania celu
            if (draggedType === 'prompt' && overProjectElement) {
                overProjectElement.classList.add('drop-target-project');
            }

            const overElement = e.target.closest('li[data-type]');
            if (!placeholder) placeholder = createDragPlaceholder();
            if (draggedType === 'prompt' && overElement && overElement.dataset.type === 'project') {
                const promptList = overElement.querySelector('.prompt-list');
                if (promptList) {
                   promptList.style.display = 'block'; // Upewniamy się, że lista jest widoczna
                   if (!promptList.contains(placeholder)) promptList.appendChild(placeholder);
                }
                return;
            }

            if (!overElement || overElement === draggedItem || draggedType !== overElement.dataset.type) return;
            
            const rect = overElement.getBoundingClientRect();
            const isAfter = e.clientY > rect.top + rect.height / 2;
            overElement.parentNode.insertBefore(placeholder, isAfter ? overElement.nextSibling : overElement);
        };

const handleTreeDrop = (e) => {
    e.preventDefault();
    if (!draggedItem || !placeholder || !placeholder.parentNode || state.sortMode !== 'manual') {
        handleTreeDragEnd();
        return;
    }

    const data = JSON.parse(e.dataTransfer.getData('text/plain'));
    const domChildren = Array.from(placeholder.parentNode.children);
    const placeholderDomIndex = domChildren.indexOf(placeholder);
    const now = Date.now();

    if (data.type === 'project') {
        const sourceArray = state.projects;
        const originalIndex = sourceArray.findIndex(item => item.id === data.id);
        if (originalIndex === -1) {
            handleTreeDragEnd();
            return;
        }
        const [movedItem] = sourceArray.splice(originalIndex, 1);

        let newIndex = 0;
        for (let i = 0; i < placeholderDomIndex; i++) {
            if (domChildren[i].dataset.type === 'project') {
                newIndex++;
            }
        }
        sourceArray.splice(newIndex, 0, movedItem);

    } else if (data.type === 'prompt') {
        const sourceProject = findProject(data.projectId);
        if (!sourceProject) {
            handleTreeDragEnd();
            return;
        }

        const dropTargetElement = e.target.closest('li[data-type]');
        const targetProjectId = dropTargetElement?.dataset.projectId || dropTargetElement?.dataset.id;
        const targetProject = findProject(targetProjectId);

        if (!targetProject) {
            handleTreeDragEnd();
            return;
        }

        const originalIndex = sourceProject.prompts.findIndex(p => p.id === data.id);
        if (originalIndex === -1) {
            handleTreeDragEnd();
            return;
        }
        const [movedPrompt] = sourceProject.prompts.splice(originalIndex, 1);

        let newIndex = 0;
        for (let i = 0; i < placeholderDomIndex; i++) {
            if (domChildren[i].dataset.type === 'prompt') {
                newIndex++;
            }
        }
        
        targetProject.prompts.splice(newIndex, 0, movedPrompt);
        sourceProject.updatedAt = now;
        targetProject.updatedAt = now;
    }

    saveData();
    renderTreeView();
    updateMainView(); // <<< DODANA LINIA DO ODŚWIEŻENIA PRAWEGO PANELU
    handleTreeDragEnd();
};

        // --- 12. SEARCH & SORTING LOGIC / LOGIKA WYSZUKIWANIA I SORTOWANIA ---
function sortArray(arr, mode) {
    if (!Array.isArray(arr)) return [];
    const base = [...arr];

    const by = {
        alpha_asc: (a, b) => (a.name || '').localeCompare(b.name || '', 'pl', { sensitivity: 'base' }),
        alpha_desc: (a, b) => (b.name || '').localeCompare(a.name || '', 'pl', { sensitivity: 'base' }),
        newest: (a, b) => (b.createdAt || 0) - (a.createdAt || 0),
        oldest: (a, b) => (a.createdAt || 0) - (b.createdAt || 0),
        updated: (a, b) => (b.updatedAt || 0) - (a.updatedAt || 0),
        color: (a, b) => {
            const pa = _parseColor(a.color);
            const pb = _parseColor(b.color);
            if (!pa && !pb) return 0;
            if (!pa) return 1;
            if (!pb) return -1;
            const ha = _rgbToHsl(pa.r, pa.g, pa.b);
            const hb = _rgbToHsl(pb.r, pb.g, pb.b);
            if (ha.h !== hb.h) return ha.h - hb.h;
            return ha.l - hb.l;
        }
    };

    const cmp = by[mode] || (() => 0);
    return base.sort(cmp);
}


        // Funkcja do renderowania wyników wyszukiwania globalnego
        function buildGlobalResults(query) {
            if (!globalResultsContainer) return;
            
            const q = query.trim().toLowerCase();

            if (q.length < 2) {
                globalResultsContainer.innerHTML = '<div class="text-center text-slate-500">Wpisz co najmniej 2 znaki, aby rozpocząć wyszukiwanie.</div>';
                return;
            }

            let results = [];
            state.projects.forEach(p => {
                p.prompts.forEach(pr => {
                    const check = (text) => text && text.toLowerCase().includes(q);
                    let matchFound = false;
                    let matchSnippet = pr.name;

                    if (pr.type === 'simple') {
                        (pr.versions || []).forEach(v => {
                            const strippedContent = stripHtml(v.content);
                            if (check(pr.name) || check(v.name) || check(strippedContent) || check(v.assistantContent)) {
                                if (!matchFound) {
                                    if (check(strippedContent)) {
                                        const index = strippedContent.toLowerCase().indexOf(q);
                                        const start = Math.max(0, index - 30);
                                        const end = Math.min(strippedContent.length, index + q.length + 30);
                                        matchSnippet = '...' + strippedContent.substring(start, end) + '...';
                                    }
                                    results.push({ projectId: p.id, promptId: pr.id, path: `${p.name} > ${pr.name}`, snippet: matchSnippet });
                                    matchFound = true;
                                }
                            }
                        });
                    } else {
                        let combinedContent = (pr.steps || []).map(s => stripHtml(s.content)).join(' ');
                        if (check(pr.name) || check(combinedContent)) {
                            if (check(combinedContent)) {
                                const index = combinedContent.toLowerCase().indexOf(q);
                                const start = Math.max(0, index - 30);
                                const end = Math.min(combinedContent.length, index + q.length + 30);
                                matchSnippet = '...' + combinedContent.substring(start, end) + '...';
                            }
                            results.push({ projectId: p.id, promptId: pr.id, path: `${p.name} > ${pr.name}`, snippet: matchSnippet });
                        }
                    }
                });
            });

            if (results.length === 0) {
                globalResultsContainer.innerHTML = '<div class="text-center text-slate-500 p-4">Brak wyników.</div>';
            } else {
                globalResultsContainer.innerHTML = results.map(r => `
                    <div class="p-3 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-2xl cursor-pointer result-item" data-project-id="${r.projectId}" data-prompt-id="${r.promptId}">
                        <div class="font-semibold text-slate-800 dark:text-slate-200">${escapeHtml(r.path)}</div>
                        <p class="text-sm text-slate-500">${escapeHtml(r.snippet)}</p>
                    </div>
                `).join('');
            }
        }

const updatePromptIconColor = () => {
            const project = getSelectedProject();
            const promptIcon = document.getElementById('prompt-icon');
            if (promptIcon && project) {
                if (project.color) {
                    const palette = derivePalette(project.color);
                    // Użyj koloru projektu jako głównego koloru z delikatnym gradientem
                    promptIcon.style.background = `linear-gradient(135deg, ${palette.dotStrong} 0%, ${palette.line} 100%)`;
                    promptIcon.style.boxShadow = `0 8px 25px ${palette.dotStrong}30`;
                } else {
                    // Domyślny gradient fioletowy gdy projekt nie ma koloru
                    promptIcon.style.background = 'linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%)';
                    promptIcon.style.boxShadow = '0 8px 25px rgba(139, 92, 246, 0.3)';
                }
            }
        };

        const updatePromptTitleDisplay = () => {
            
            const titleDisplay = document.getElementById('prompt-title-display');
            const prompt = getSelectedPrompt();
            if (titleDisplay && prompt) {
                titleDisplay.textContent = prompt.name;
            }
        };


        const updateVersionDropdown = () => {
            const prompt = getSelectedPrompt();
            const currentVersionName = document.getElementById('current-version-name');
            const versionList = document.getElementById('version-list');
            
            if (!prompt || !currentVersionName || !versionList) return;
            
            const currentVersion = getSelectedVersion();
            if (currentVersion) {
                currentVersionName.textContent = currentVersion.name;
            }
            
            // Wygeneruj listę wersji
            versionList.innerHTML = '';
            prompt.versions.forEach(version => {
                const isActive = version.id === state.selectedVersionId;
                const item = document.createElement('div');
                item.className = `px-3 py-2 text-sm cursor-pointer flex items-center justify-between group ${isActive ? 'bg-blue-50 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300' : 'hover:bg-slate-50 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-300'}`;
                item.innerHTML = `
                    <span>${version.name}</span>
                    <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                        <button onclick="event.stopPropagation(); duplicateVersion('${version.id}')" class="p-1 text-slate-400 hover:text-purple-600 rounded">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor"><path d="M7 9a2 2 0 012-2h6a2 2 0 012 2v6a2 2 0 01-2 2H9a2 2 0 01-2-2V9z"/><path d="M5 3a2 2 0 00-2 2v6a2 2 0 002 2V5h6a2 2 0 00-2-2H5z"/></svg>
                        </button>
                        <button onclick="event.stopPropagation(); renameVersion('${version.id}')" class="p-1 text-slate-400 hover:text-amber-600 rounded">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" /></svg>
                        </button>
                        ${prompt.versions.length > 1 ? `<button onclick="event.stopPropagation(); deleteVersion('${version.id}')" class="p-1 text-slate-400 hover:text-red-600 rounded">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-1 12a2 2 0 01-2 2H8a2 2 0 01-2-2L5 7m0 0h14M9 7V5a2 2 0 012-2h2a2 2 0 012 2v2"/></svg>
                        </button>` : ''}
                    </div>
                `;
                item.onclick = () => {
                    if (!isActive) {
                        selectVersion(version.id);
                        document.getElementById('version-dropdown-menu').classList.add('hidden');
                    }
                };
                versionList.appendChild(item);
            });
        };

        // Globalne funkcje do zarządzania wersjami
        window.duplicateVersion = (versionId) => {
            const prompt = getSelectedPrompt();
            const version = prompt.versions.find(v => v.id === versionId);
            if (prompt && version) {
                const copy = JSON.parse(JSON.stringify(version));
                copy.id = generateId();
                copy.name = (version.name || 'Wersja') + ' (kopia)';
                const now = Date.now();
                copy.createdAt = now;
                copy.updatedAt = now;
                prompt.versions.unshift(copy);
                prompt.updatedAt = now;
                findProject(state.selectedProjectId).updatedAt = now;
                state.selectedVersionId = copy.id;
                saveData();
                renderEditor();
            }
        };

        window.renameVersion = (versionId) => {
            const prompt = getSelectedPrompt();
            const version = prompt.versions.find(v => v.id === versionId);
            if (version) {
                showInputModal('Zmień nazwę wersji:', version.name, (newName) => {
                    updateVersionName(state.selectedProjectId, state.selectedPromptId, versionId, newName);
                });
            }
        };

        window.deleteVersion = (versionId) => {
            const prompt = getSelectedPrompt();
            if (!prompt || prompt.versions.length <= 1) {
                showToast('Nie można usunąć jedynej wersji.', 'error');
                return;
            }
            showConfirmation('Usunąć wersję?', 'Tej operacji nie można cofnąć.', () => {
                const vIndex = prompt.versions.findIndex(v => v.id === versionId);
                prompt.versions = prompt.versions.filter(v => v.id !== versionId);
                if (prompt.versions.length > 0) {
                    const newIndex = Math.max(0, vIndex - 1);
                    state.selectedVersionId = prompt.versions[newIndex].id;
                } else {
                    state.selectedVersionId = null;
                }
                const now = Date.now();
                prompt.updatedAt = now;
                findProject(state.selectedProjectId).updatedAt = now;
                saveData();
                renderEditor();
                showToast('Wersja usunięta');
            }, 'Usuń');
        };

        // --- 13. EVENT LISTENERS (Buttons, Inputs, etc.) / NASŁUCHIWANIE ZDARZEŃ (Przyciski, Pola, itp.) ---
        
        addProjectBtn.onclick = addProject;

const setupEditorListeners = (editor) => {
    if (!editor || !editor.on) {
        console.warn('⚠️ Invalid editor passed to setupEditorListeners');
        return;
    }
    
    // Usuń poprzednie listenery jeśli istnieją
    editor.off('text-change');
    editor.off('selection-change');
    
    // Dodaj listener dla zmian tekstu
    editor.on('text-change', (delta, oldDelta, source) => {
        if (source === 'user') {
            console.log('🔄 Editor changed by user');
            
            // Natychmiastowo zapisz
            const version = getSelectedVersion();
            if (version && editor.root) {
                version.content = editor.root.innerHTML;
                console.log('💾 Immediate content update');
            }
            
            updateCombinedOutput();
            debouncedAutoSave();
            renderVariableInputs();
        }
    });
    
    // Osobny listener dla selection (dla snippetów)
    editor.on('selection-change', (range, oldRange, source) => {
        if (range && source === 'user') {
            const textBeforeCursor = editor.getText(0, range.index);
            const lastHashIndex = textBeforeCursor.lastIndexOf('#');
            if (lastHashIndex !== -1 && !textBeforeCursor.substring(lastHashIndex + 1).includes(' ')) {
                const filterText = textBeforeCursor.substring(lastHashIndex + 1);
                const editorBounds = editor.container.getBoundingClientRect();
                const rangeBounds = editor.getBounds(lastHashIndex);
                const finalBounds = {
                    left: editorBounds.left + rangeBounds.left,
                    bottom: editorBounds.top + rangeBounds.bottom,
                };
                showSnippetDropdown(finalBounds, editor, filterText);
            } else {
               snippetDropdown.classList.add('hidden');
            }
        }
    });
};

// Inicjalizuj listenery dla głównego edytora
setupEditorListeners(promptEditor);
        
        editorLockCheckbox.onchange = () => {
        setEditorLock(editorLockCheckbox.checked);
        updateLockTooltip();
        };


document.getElementById('add-version-btn').onclick = () => {
            const prompt = getSelectedPrompt();
            if (prompt) {
                const now = Date.now();
                const newVersion = { id: generateId(), name: `Wersja ${prompt.versions.length + 1}`, content: '', createdAt: now, updatedAt: now, isAssistantVisible: true, assistantContent: '' };
                prompt.versions.unshift(newVersion);
                prompt.updatedAt = now;
                findProject(state.selectedProjectId).updatedAt = now;
                selectVersion(newVersion.id);
                saveData();
                document.getElementById('version-dropdown-menu').classList.add('hidden');
            }
        };
        
        

        const handleTreeAction = (action, projectId, promptId, buttonEl) => {
            const project = findProject(projectId);
            const prompt = promptId ? findPrompt(projectId, promptId) : null;

            switch (action) {
                case 'toggle-project':
                    // Kliknięcie strzałki teraz działa tak samo jak kliknięcie nazwy projektu
                    selectProject(projectId);
                    break;
                case 'add-prompt':
                    addPromptHandler(projectId);
                    break;
                case 'set-color':
                    if (project) {
                        initProjectColorPicker(projectId);
                    }
                    break;
                case 'rename-project':
                    if (project) {
                        const nameSpan = document.getElementById(`project-name-${projectId}`);
                        const originalName = project.name;

                        if (!nameSpan || nameSpan.querySelector('input')) break; // Prevent double-clicking

                        const input = document.createElement('input');
                        input.type = 'text';
                        input.value = originalName;
                        input.className = 'w-full bg-slate-100 dark:bg-slate-700 rounded-md px-1 py-0 -ml-1 focus:outline-none focus:ring-2 focus:ring-accent-500';
                        
                        // Function to save and switch back to span
                        const saveChanges = () => {
                            const newName = input.value.trim();
                            if (newName && newName !== originalName) {
                                updateProjectName(projectId, newName);
                            }
                            // Re-render the whole tree to ensure consistency
                            renderTreeView();
                        };

                        // Replace span with input
                        nameSpan.textContent = '';
                        nameSpan.appendChild(input);
                        input.focus();
                        input.select();

                        // Event listeners for saving or canceling
                        input.addEventListener('blur', saveChanges);
                        input.addEventListener('keydown', (e) => {
                            if (e.key === 'Enter') {
                                e.preventDefault();
                                saveChanges();
                            } else if (e.key === 'Escape') {
                                e.preventDefault();
                                renderTreeView(); // Just re-render to cancel
                            }
                        });
                    }
                    break;
                case 'delete-project':
                    if (project) {
                        showConfirmation('Usunąć projekt?', `Spowoduje to usunięcie wszystkich promptów w projekcie "${project.name}".`, () => {
                            deleteProject(projectId);
                        }, 'Usuń');
                    }
                    break;
                case 'toggle-favorite':
                    if (prompt) {
                        prompt.isFavorite = !prompt.isFavorite;
                        saveData();
                        renderAll();
                    }
                    break;
                case 'duplicate-prompt':
                    if (prompt) {
                        duplicatePrompt(projectId, promptId);
                    }
                    break;
                case 'rename-prompt':
                    if (prompt) {
                        const nameSpan = document.getElementById(`prompt-name-${promptId}`);
                        const originalName = prompt.name;

                        if (!nameSpan || nameSpan.querySelector('input')) break;

                        const input = document.createElement('input');
                        input.type = 'text';
                        input.value = originalName;
                        input.className = 'w-full bg-slate-100 dark:bg-slate-700 rounded-md px-1 py-0 -ml-1 focus:outline-none focus:ring-2 focus:ring-accent-500';

                        const saveChanges = () => {
                            const newName = input.value.trim();
                            if (newName && newName !== originalName) {
                                updatePromptName(projectId, promptId, newName);
                            } else {
                                renderTreeView();
                            }
                        };
                        
                        nameSpan.textContent = '';
                        nameSpan.appendChild(input);
                        input.focus();
                        input.select();

                        input.addEventListener('blur', saveChanges);
                        input.addEventListener('keydown', (e) => {
                            if (e.key === 'Enter') {
                                e.preventDefault();
                                saveChanges();
                            } else if (e.key === 'Escape') {
                                e.preventDefault();
                                renderTreeView();
                            }
                        });
                    }
                    break;
                case 'delete-prompt':
                    if (prompt) {
                        showConfirmation('Usunąć prompt?', `Czy na pewno chcesz usunąć "${prompt.name}"?`, () => {
                            deletePrompt(projectId, promptId);
                        }, 'Usuń');
                    }
                    break;
            }
        };
        
        const duplicatePrompt = (projectId, promptId) => {
            const project = findProject(projectId);
            const prompt = findPrompt(projectId, promptId);
            if (!project || !prompt) return;
            
            const duplicatedPrompt = JSON.parse(JSON.stringify(prompt));
            duplicatedPrompt.id = generateId();
            duplicatedPrompt.name = `${prompt.name} (kopia)`;
            const now = Date.now();
            duplicatedPrompt.createdAt = now;
            duplicatedPrompt.updatedAt = now;
            duplicatedPrompt.isFavorite = false;
            
            // Generuj nowe ID dla wersji
            if (duplicatedPrompt.type === 'simple' && duplicatedPrompt.versions) {
                duplicatedPrompt.versions.forEach(v => {
                    v.id = generateId();
                    v.createdAt = now;
                    v.updatedAt = now;
                });
            } else if (duplicatedPrompt.type === 'chain' && duplicatedPrompt.steps) {
                duplicatedPrompt.steps.forEach(s => {
                    s.id = generateId();
                    s.createdAt = now;
                    s.updatedAt = now;
                });
            }
            
            const promptIndex = project.prompts.findIndex(p => p.id === promptId);
            project.prompts.splice(promptIndex + 1, 0, duplicatedPrompt);
            project.updatedAt = now;
            
            state.selectedPromptId = duplicatedPrompt.id;
            if (duplicatedPrompt.type === 'simple' && duplicatedPrompt.versions.length > 0) {
                state.selectedVersionId = duplicatedPrompt.versions[0].id;
            }
            
            saveData();
            renderAll();
            showToast('Prompt zduplikowany');
        };

         treeViewList.addEventListener('click', (e) => {
            const treeItem = e.target.closest('.tree-item');
            if (!treeItem) return;

            const projectId = treeItem.dataset.type === 'project' ? treeItem.dataset.id : treeItem.dataset.projectId;
            const promptId = treeItem.dataset.type === 'prompt' ? treeItem.dataset.id : null;
            const actionTarget = e.target.closest('[data-action]');

            if (actionTarget) {
                // Jeśli kliknięto przycisk akcji (np. usuń, zmień nazwę)
                e.stopPropagation();
                handleTreeAction(actionTarget.dataset.action, projectId, promptId, actionTarget);
            } else if (treeItem.dataset.type === 'project') {
                // Jeśli kliknięto gdziekolwiek na elemencie projektu
                e.stopPropagation();
                selectProject(projectId);
            } else if (treeItem.dataset.type === 'prompt') {
                // Jeśli kliknięto na prompt
                e.stopPropagation();
                selectPrompt(projectId, promptId);
            }
        });

        function getCombinedPlainText() {
            const prompt = getSelectedPrompt();
            if (!prompt) return '';

            // 1) zmienne
            const variableValues = {};
            variablesInputs.querySelectorAll('input[data-variable-name]').forEach(input => {
                variableValues[input.dataset.variableName] = input.value;
            });

            // 2) rdzeń treści – BIEŻĄCY HTML z edytorów (bez czekania na autosave)
            let coreHtml = '';
            if (prompt.type === 'simple') {
                // jeśli mamy działający edytor – bierzemy z niego, fallback do zapisanej wersji
                const version = getSelectedVersion();
                const liveHtml = (typeof promptEditor !== 'undefined' && promptEditor) 
                    ? promptEditor.root.innerHTML 
                    : (version?.content || '');
                coreHtml = liveHtml || '';
            } else {
                // chain – zbierz bieżący HTML z każdego kroku; fallback do zapisanych wartości
                coreHtml = (prompt.steps || []).map(s => {
                    const q = (typeof chainQuillInstances !== 'undefined' && chainQuillInstances?.get && chainQuillInstances.get(s.id)) 
                        ? chainQuillInstances.get(s.id).root.innerHTML 
                        : (s.content || '');
                    return q || '';
                }).filter(Boolean).join('\n\n');
            }

            // 3) plain text – stript HTML i rozwiń snippety + zmienne
            const coreText = stripHtml(coreHtml || '');
            let processedText = replaceSnippets(coreText);
            processedText = replaceVariables(processedText, variableValues);

            // 4) kontekst – BEZ frazy "# Kontekst"
            const version = getSelectedVersion();
            // bierzemy live wartość z #assistant-content, fallback do zapisanej w wersji
            const liveCtx = (typeof assistantContent !== 'undefined' && assistantContent && typeof assistantContent.value === 'string')
              ? assistantContent.value.trim()
              : '';
            const ctxRaw = liveCtx || (version?.assistantContent?.trim() || '');
            const ctx = ctxRaw ? `\n\n${ctxRaw}` : '';

            return processedText + ctx;
        }

        function updateCombinedOutput() {
            if (!combinedOutputPreview) return;
            try {
                const htmlContent = getCombinedHTML();
                if (htmlContent && htmlContent !== '<div class="text-slate-400">Brak treści</div>') {
                    combinedOutputPreview.innerHTML = htmlContent;
                    combinedOutputPreview.classList.remove('text-center');
                } else {
                    combinedOutputPreview.innerHTML = `
                        <div class="text-slate-400 text-center py-8">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto mb-3 opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            <p>Zacznij pisać prompt, aby zobaczyć podgląd</p>
                        </div>
                    `;
                    combinedOutputPreview.classList.add('text-center');
                }
            } catch (error) {
                console.error('Błąd w updateCombinedOutput:', error);
                combinedOutputPreview.innerHTML = '<div class="text-red-500 text-center p-4">⚠️ Błąd generowania podglądu</div>';
            }
        }
        
        assistantContent.oninput = () => {
            updateCombinedOutput();
            debouncedAutoSave();
        };

        

// Dodatkowy listener dla pola kontekstu
if (assistantContent) {
    assistantContent.addEventListener('blur', () => {
        console.log('💾 Assistant content lost focus, saving');
        autoSaveChanges();
    });
}

// Automatyczny zapis przy opuszczeniu aplikacji
window.addEventListener('beforeunload', (e) => {
    console.log('💾 Page unloading, forcing save');
    // Natychmiast zapisz bez debounce
    autoSaveChanges();
    saveData();
});

// Automatyczny zapis przy utracie focus
window.addEventListener('blur', () => {
    console.log('💾 Window lost focus, saving');
    autoSaveChanges();
    saveData();
});

// Automatyczny zapis przy zmianie widoczności strony
document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
        console.log('💾 Page hidden, saving');
        autoSaveChanges();
        saveData();
    }
});

// Automatyczny zapis co 10 sekund jako backup
setInterval(() => {
    if (state.selectedPromptId) {
        console.log('💾 Periodic backup save');
        autoSaveChanges();
        saveData();
    }
}, 10000);

        toggleAssistantBtn.onclick = () => {
            const version = getSelectedVersion();
            if (version) {
                version.isAssistantVisible = !version.isAssistantVisible;
                assistantWrapper.classList.toggle('hidden', !version.isAssistantVisible);
                toggleAssistantBtn.classList.toggle('rotate-180', version.isAssistantVisible);
                saveData();
            }
        };

        copyCombinedBtn.onclick = () => {
            const textToCopy = combinedOutputPreview.innerText;
            if (!textToCopy) {
                showToast("Brak treści do skopiowania", "error");
                return;
            }
            navigator.clipboard.writeText(textToCopy).then(() => {
                showToast("Skopiowano do schowka!");
            }).catch(err => { console.error('Could not copy text: ', err); showToast("Błąd kopiowania", "error"); });
        };
        
        copyPlainTextBtn.onclick = () => {
            const plainText = getCombinedPlainText();
             if (!plainText) {
                showToast("Brak treści do skopiowania", "error");
                return;
            }
            navigator.clipboard.writeText(plainText).then(() => {
                showToast("Skopiowano czysty tekst!");
            }).catch(err => { console.error('Could not copy text: ', err); showToast("Błąd kopiowania", "error"); });
        };
        
        exportBtn.onclick = () => { 
            const dataStr = JSON.stringify(state, null, 2); 
            const dataBlob = new Blob([dataStr], {type: 'application/json'}); 
            const url = URL.createObjectURL(dataBlob); 
            const link = document.createElement('a'); 
            link.href = url; 
            link.download = `prompt-manager-backup-${new Date().toISOString().slice(0,10)}.json`; 
            document.body.appendChild(link); 
            link.click(); 
            document.body.removeChild(link); 
            URL.revokeObjectURL(url); 
        };
        
        importBtn.onclick = () => importFile.click();
        
        importFile.onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const importedState = JSON.parse(event.target.result);
                    if (importedState && Array.isArray(importedState.projects)) {
                        showConfirmation('Importować dane?', 'Spowoduje to nadpisanie wszystkich obecnych danych.', () => {
                            state = { projects: [], snippets: [], selectedProjectId: null, selectedPromptId: null, selectedVersionId: null, sortMode: 'manual' };
                            loadData(); // To apply migrations to the imported data
                            state = importedState;
                            saveData(); 
                            renderAll(); 
                            showToast('Dane zaimportowano!');
                        }, 'Importuj');
                    } else { 
                        throw new Error('Invalid file format'); 
                    }
                } catch (err) { 
                    console.error('Error importing file:', err); 
                    showToast('Błąd podczas importu pliku.', 'error'); 
                } 
                finally { 
                    importFile.value = ''; 
                }
            };
            reader.readAsText(file);
        };
        
        // Event listenery dla dropdown wersji
        document.addEventListener('click', (e) => {
            const dropdownBtn = document.getElementById('version-dropdown-btn');
            const dropdownMenu = document.getElementById('version-dropdown-menu');
            
            if (dropdownBtn && e.target.closest('#version-dropdown-btn')) {
                e.stopPropagation();
                dropdownMenu.classList.toggle('hidden');
                if (!dropdownMenu.classList.contains('hidden')) {
                    updateVersionDropdown();
                }
            } else if (dropdownMenu && !dropdownMenu.contains(e.target)) {
                dropdownMenu.classList.add('hidden');
            }
        });


// --- Logika dla panelu typografii ---
        const typographyBtn = document.getElementById('typography-btn');
        const typographyPopover = document.getElementById('typography-popover');
        
        typographyBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            typographyPopover.classList.toggle('hidden');
        });

        document.addEventListener('click', (e) => {
            if (!typographyPopover.classList.contains('hidden') && !e.target.closest('#typography-controls-wrapper')) {
                typographyPopover.classList.add('hidden');
            }
        });

        // --- Nowa logika dla panelu Workspace Controls ---

        // Przywracamy klikalność dla pływającego przycisku wyjścia
        focusModeToggle.addEventListener('click', toggleFocusMode);
        const workspaceControlsContainer = document.getElementById('workspace-controls');

        const setLayoutWidth = (widthPercentage, clickedButton) => {
            if (window.innerWidth < 1024) return; 
            leftSidebar.style.width = widthPercentage;
            sidebarWidth = widthPercentage;
            localStorage.setItem('sidebarWidth', sidebarWidth);

            // Aktualizacja aktywnego przycisku
            workspaceControlsContainer.querySelectorAll('.workspace-btn[data-layout]').forEach(btn => btn.classList.remove('active'));
            if (clickedButton) {
                clickedButton.classList.add('active');
            }
        };

        workspaceControlsContainer.addEventListener('click', (e) => {
            const button = e.target.closest('.workspace-btn');
            if (!button || !button.dataset.layout) return;

            const layout = button.dataset.layout;
            if (layout === '1:3') setLayoutWidth('25%', button);
            if (layout === '1:2') setLayoutWidth('33.33%', button);
            if (layout === '1:1') setLayoutWidth('50%', button);
        });



        
        // --- 14. MODAL & OVERLAY LOGIC / LOGIKA OKIEN MODALNYCH I NAKŁADEK ---
        const showConfirmation = (title, text, callback, confirmText = 'Usuń') => { 
            modalTitle.textContent = title; 
            modalText.textContent = text; 
            modalConfirm.textContent = confirmText;
            confirmationCallback = callback; 
            confirmationModal.classList.remove('hidden'); 
        };
        
        modalConfirm.onclick = () => { 
            if (confirmationCallback) { 
                confirmationCallback(); 
            } 
            confirmationModal.classList.add('hidden'); 
            confirmationCallback = null; 
        };
        
        modalCancel.onclick = () => { 
            confirmationModal.classList.add('hidden'); 
            confirmationCallback = null; 
        };
        
        const showInputModal = (title, initialValue, callback) => {
            inputModalTitle.textContent = title;
            inputModalField.value = initialValue;
            inputCallback = callback;
            inputModal.classList.remove('hidden');
            inputModalField.focus();
            inputModalField.select();
        };

        inputModalConfirm.onclick = () => {
            const newValue = inputModalField.value.trim();
            if (newValue && inputCallback) {
                inputCallback(newValue);
            }
            inputModal.classList.add('hidden');
            inputCallback = null;
        };

        inputModalCancel.onclick = () => {
            inputModal.classList.add('hidden');
            inputCallback = null;
        };

        inputModalField.onkeydown = (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                inputModalConfirm.click();
            } else if (e.key === 'Escape') {
                e.preventDefault();
                inputModalCancel.click();
            }
        };

        const handleExitFullscreen = () => {
            const overlay = document.getElementById('fullscreen-overlay');
            if (!overlay) return;
            rightPanel.appendChild(editorView);
            overlay.remove();
            document.body.style.overflow = '';
            toggleFullscreenBtn.classList.remove('hidden');
            renderEditor();
        };

        toggleFullscreenBtn.onclick = () => {
            const overlay = document.createElement('div');
            overlay.id = 'fullscreen-overlay';
            overlay.onclick = (e) => { if(e.target === overlay) handleExitFullscreen(); };

            const windowDiv = document.createElement('div');
windowDiv.id = 'fullscreen-window';
windowDiv.className = 'slide-in-up';

            const bar = document.createElement('div');
            bar.id = 'fullscreen-bar';
            bar.innerHTML = `<h3 class="font-semibold">Tryb pełnoekranowy</h3>`;

            const closeBtn = document.createElement('button');
            closeBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>`;
            closeBtn.className = 'text-slate-500 hover:text-slate-800 dark:hover:text-white';
            closeBtn.onclick = handleExitFullscreen;
            bar.appendChild(closeBtn);
            
            windowDiv.appendChild(bar);
            windowDiv.appendChild(editorView);
            overlay.appendChild(windowDiv);
            document.body.appendChild(overlay);
            document.body.style.overflow = 'hidden';
            toggleFullscreenBtn.classList.add('hidden');
        };

        
        
        // --- 16. GLOBAL LISTENERS (Tooltip, Resize, etc.) / GLOBALNE NASŁUCHIWANIE ZDARZEŃ ---
        let tooltipHideTimeout;
        const showTooltip = (target) => {
            clearTimeout(tooltipHideTimeout);
            globalTooltip.textContent = target.dataset.tooltip;
            globalTooltip.classList.remove('hidden');
            const targetRect = target.getBoundingClientRect();

            requestAnimationFrame(() => {
                const top = targetRect.top - globalTooltip.offsetHeight - 6;
                const left = targetRect.left + (targetRect.width / 2) - (globalTooltip.offsetWidth / 2);
                globalTooltip.style.left = `${left}px`;
                globalTooltip.style.top = `${top < 0 ? targetRect.bottom + 6 : top}px`;
                globalTooltip.style.opacity = 1;
globalTooltip.classList.add('slide-in-up');            });
        };

        const hideTooltip = () => {
            tooltipHideTimeout = setTimeout(() => {
                globalTooltip.style.opacity = 0;
                setTimeout(() => globalTooltip.classList.add('hidden'), 200);
            }, 100);
        };

        document.body.addEventListener('mouseover', e => {
            const target = e.target.closest('[data-tooltip]');
            if (target) {
                showTooltip(target);
            }
        });

        document.body.addEventListener('mouseout', e => {
            const target = e.target.closest('[data-tooltip]');
            if (target) {
                hideTooltip();
            }
        });

        globalTooltip.addEventListener('mouseenter', () => clearTimeout(tooltipHideTimeout));
        globalTooltip.addEventListener('mouseleave', hideTooltip);

        document.addEventListener('click', (e) => { 
            if (!snippetDropdown.contains(e.target) && !e.target.closest('#insert-snippet-btn')) { 
                snippetDropdown.classList.add('hidden'); 
            } 
            if (!colorOptionsContainer.contains(e.target) && !e.target.closest('#color-palette-btn')) { 
                colorOptionsContainer.style.display = 'none'; 
            } 
        });
        
        window.addEventListener('resize', () => { 
            snippetDropdown.classList.add('hidden'); 
            updateSidebarTop(); 
            updateFavoritesScrolling(); 
        });
        
        favLeftBtn.onclick = () => { favoritesContainer.scrollBy({ left: -favoritesContainer.clientWidth * 0.8, behavior: 'smooth' }); };
        favRightBtn.onclick = () => { favoritesContainer.scrollBy({ left: favoritesContainer.clientWidth * 0.8, behavior: 'smooth' }); };
        favoritesContainer.addEventListener('scroll', updateFavoritesScrolling);

        favoritesContainer.addEventListener('dragstart', handleFavoritesDragStart);
        favoritesContainer.addEventListener('dragend', handleFavoritesDragEnd);
        favoritesContainer.addEventListener('dragover', handleFavoritesDragOver);
        favoritesContainer.addEventListener('drop', handleFavoritesDrop);

        // Handle remove from favorites
favoritesContainer.addEventListener('click', (e) => {
    if (e.target.closest('.remove-favorite-btn')) {
        e.stopPropagation();
        const btn = e.target.closest('.remove-favorite-btn');
        const projectId = btn.dataset.projectId;
        const promptId = btn.dataset.promptId;
        
        const prompt = findPrompt(projectId, promptId);
        if (prompt) {
            prompt.isFavorite = false;
            saveData();
            renderAll();
            showToast('Usunięto z ulubionych');
        }
    }
});

        treeViewList.addEventListener('mousedown', (e) => {
            const handle = e.target.closest('.drag-handle');
            const li = e.target.closest('li[data-type="project"], li[data-type="prompt"]');
            if (handle && li && state.sortMode === 'manual') {
                isDragHandleActive = true;
                li.draggable = true;
            }
        });

        document.addEventListener('mouseup', () => { isDragHandleActive = false; });
        treeViewList.addEventListener('dragstart', handleTreeDragStart);
        treeViewList.addEventListener('dragend', handleTreeDragEnd);
        treeViewList.addEventListener('dragover', handleTreeDragOver);
        treeViewList.addEventListener('drop', handleTreeDrop);

        treeSearch.oninput = renderTreeView;
        sortModeSelect.onchange = (e) => {
            state.sortMode = e.target.value;
            saveData();
            renderTreeView();
        };

        manageSnippetsBtn.onclick = () => { resetSnippetForm(); renderSnippetsInModal(); snippetModal.classList.remove('hidden'); };
        const closeSnippetModal = () => snippetModal.classList.add('hidden');
        closeSnippetModalBtn.onclick = closeSnippetModal;
        snippetModal.onclick = (e) => { if (e.target === snippetModal) closeSnippetModal(); };
        
        saveSnippetBtn.onclick = handleSaveSnippet;
        clearSnippetFormBtn.onclick = resetSnippetForm;
        
        snippetsListModal.addEventListener('click', (e) => { 
            if (e.target.closest('.edit-snippet-btn')) { 
                handleEditSnippet(e.target.closest('.edit-snippet-btn').dataset.id); 
            } 
            if (e.target.closest('.delete-snippet-btn')) { 
                handleDeleteSnippet(e.target.closest('.delete-snippet-btn').dataset.id); 
            } 
        });
        
        insertSnippetBtn.onclick = (e) => {
            const bounds = e.target.getBoundingClientRect();
            showSnippetDropdown(bounds, promptEditor);
        };
    
        
        // --- Search & Sorting Listeners ---
        treeSearch.addEventListener('input', renderTreeView);
        

        // --- Search Modal Listeners ---
        const openSearchModal = () => {
            searchModal.classList.remove('hidden');
            globalSearchInput.focus();
            globalSearchInput.select();
            buildGlobalResults(''); // Wyczyść poprzednie wyniki
        };
        
        const closeSearchModal = () => {
            searchModal.classList.add('hidden');
            globalSearchInput.value = '';
            globalResultsContainer.innerHTML = '<div class="text-center text-slate-500">Wpisz co najmniej 2 znaki, aby rozpocząć wyszukiwanie.</div>';
        };

        globalSearchBtn.onclick = openSearchModal;
        searchModal.onclick = (e) => { if (e.target === searchModal) closeSearchModal(); };
        globalSearchInput.oninput = () => buildGlobalResults(globalSearchInput.value);
        globalResultsContainer.onclick = (e) => {
            const resultEl = e.target.closest('[data-prompt-id]');
            if (resultEl) {
                selectProject(resultEl.dataset.projectId);
                selectPrompt(resultEl.dataset.promptId);
                if(resultEl.dataset.versionId) {
                    selectVersion(resultEl.dataset.versionId);
                }
                closeSearchModal();
            }
        };

        closeSearchModalBtn.onclick = closeSearchModal;

        // Event Listeners for Adaptive Workspace
        resizeHandle.addEventListener('mousedown', startResize);
        document.addEventListener('mousemove', doResize);
        document.addEventListener('mouseup', stopResize);

       // Breadcrumb navigation
        breadcrumbNav.addEventListener('click', (e) => {
            const item = e.target.closest('.breadcrumb-item');
            if (!item || !item.classList.contains('clickable')) return;

            const level = item.dataset.level;

            if (level === 'project') {
                // If a project is clicked, deselect any active prompt
                state.selectedPromptId = null;
                state.selectedVersionId = null;
                saveData(); // Save the new selection state
                renderTreeView(); // Update the tree to show the prompt is deselected
                updateMainView(); // Update the main panel to show the project overview
            }
        });

if (floatingCopyBtn) {
            if (floatingCopyBtn) {
            floatingCopyBtn.onclick = () => {
                if (copyCombinedBtn) {
                    copyCombinedBtn.click();
                }
            };
        }
        }


        // Workspace controls
        toggleSidebarBtn.addEventListener('click', toggleFocusMode);

        // Keyboard Shortcuts - Enhanced reliability
        document.addEventListener('keydown', (e) => {
            // Sprawdź czy jesteśmy w polu edycji
            const isInEditor = e.target.closest('.ql-editor') || 
                              e.target.tagName === 'INPUT' || 
                              e.target.tagName === 'TEXTAREA' || 
                              e.target.contentEditable === 'true';
            
            const key = e.key.toLowerCase();
            
            // Globalne skróty (działają zawsze, nawet w edytorach)
            
            // Alt+N - Nowy projekt (zawsze dostępny)
            if (e.altKey && !e.ctrlKey && !e.shiftKey && key === 'n') {
                e.preventDefault();
                e.stopPropagation();
                addProject();
                return;
            }
            
            // Alt+S - Wyszukiwanie (zawsze dostępny)
            if (e.altKey && !e.ctrlKey && !e.shiftKey && key === 's') {
                e.preventDefault();
                e.stopPropagation();
                openSearchModal();
                return;
            }
            
            // Alt+C - Kopiuj prompt (tylko gdy jest otwarty edytor)
            if (e.altKey && !e.ctrlKey && !e.shiftKey && key === 'c') {
                const isEditorVisible = !editorView.classList.contains('hidden');
                const hasSelectedPrompt = state.selectedPromptId !== null;
                
                if (isEditorVisible && hasSelectedPrompt && copyCombinedBtn) {
                    e.preventDefault();
                    e.stopPropagation();
                    copyCombinedBtn.click();
                    return;
                }
            }
            
            // Ctrl/Cmd + \ - Focus mode
            if ((e.ctrlKey || e.metaKey) && e.key === '\\') {
                e.preventDefault();
                e.stopPropagation();
                toggleFocusMode();
                return;
            }

            // Ctrl/Cmd + S - Ręczny zapis
            if ((e.ctrlKey || e.metaKey) && key === 's') {
                e.preventDefault();
                e.stopPropagation();
                const saveResult = autoSaveChanges();
                if (saveResult) {
                    showToast('✅ Zapisano pomyślnie!');
                } else if (state.selectedPromptId) {
                    showToast('⚠️ Nie można zapisać. Sprawdź konsolę.', 'error');
                }
                return;
            }

            // Escape - Zamknij modales i overlays
            if (key === 'escape') {
                e.preventDefault();
                
                if (!searchModal.classList.contains('hidden')) {
                    closeSearchModal();
                    return;
                }
                if (!snippetModal.classList.contains('hidden')) {
                    snippetModal.classList.add('hidden');
                    return;
                }
                if (!confirmationModal.classList.contains('hidden')) {
                    modalCancel.click();
                    return;
                }
                if (!inputModal.classList.contains('hidden')) {
                    inputModalCancel.click();
                    return;
                }
                if (document.getElementById('fullscreen-overlay')) {
                    handleExitFullscreen();
                    return;
                }
            }
            
            // Skróty tylko poza edytorami
            if (isInEditor) return;
            
            // Alt+P - Dodaj prompt do projektu
            if (e.altKey && !e.ctrlKey && !e.shiftKey && key === 'p') {
                e.preventDefault();
                e.stopPropagation();
                if (!state.selectedProjectId && state.projects.length === 1) {
                    addPromptHandler(state.projects[0].id);
                } else {
                    addPromptHandler();
                }
                return;
            }
            
            // Ctrl+Shift+F - Focus na wyszukiwanie projektów
            if (e.ctrlKey && e.shiftKey && key === 'f') {
                e.preventDefault();
                e.stopPropagation();
                treeSearch.focus();
                treeSearch.select();
                return;
            }
        }, { capture: true }); // Używamy capture: true dla większej niezawodności

        

        
        


        // Typography: helpers
        const applyEditorFontSize = (value) => {
            const v = parseFloat(value).toFixed(2);
            document.documentElement.style.setProperty('--editor-font-size', `${v}rem`);
            fontSizeDisplay.textContent = v;
            localStorage.setItem('editorFontSize', v);
        };

        const applyLineHeight = (value) => {
            const v = Math.max(1.0, parseFloat(value)).toFixed(2);
            document.documentElement.style.setProperty('--editor-line-height', v);
            lineHeightDisplay.textContent = v;
            localStorage.setItem('editorLineHeight', v);
        };

        const applyParagraphSpacing = (value) => {
            const v = Math.max(0.0, parseFloat(value)).toFixed(2);
            document.documentElement.style.setProperty('--editor-paragraph-spacing', `${v}rem`);
            paragraphSpacingDisplay.textContent = v;
            localStorage.setItem('editorParagraphSpacing', v);
        };

        const applyFontFamily = (family) => {
            document.documentElement.style.setProperty('--editor-font-family', family);
            localStorage.setItem('fontFamily', family);
        };

        // Typography: listeners
        if (fontSizeUpBtn && fontSizeDownBtn) {
            fontSizeUpBtn.onclick = () => {
                const curr = parseFloat(localStorage.getItem('editorFontSize') || '1.00');
                applyEditorFontSize((curr + 0.05).toFixed(2));
            };
            fontSizeDownBtn.onclick = () => {
                const curr = parseFloat(localStorage.getItem('editorFontSize') || '1.00');
                applyEditorFontSize(Math.max(0.60, curr - 0.05).toFixed(2));
            };
        }

        if (lineHeightUpBtn && lineHeightDownBtn) {
            lineHeightUpBtn.onclick = () => {
                const curr = parseFloat(localStorage.getItem('editorLineHeight') || '1.50');
                applyLineHeight((curr + 0.05).toFixed(2));
            };
            lineHeightDownBtn.onclick = () => {
                const curr = parseFloat(localStorage.getItem('editorLineHeight') || '1.50');
                applyLineHeight(Math.max(1.00, curr - 0.05).toFixed(2));
            };
        }

        if (paragraphSpacingUpBtn && paragraphSpacingDownBtn) {
            paragraphSpacingUpBtn.onclick = () => {
                const curr = parseFloat((localStorage.getItem('editorParagraphSpacing') || '1.00'));
                applyParagraphSpacing((curr + 0.10).toFixed(2));
            };
            paragraphSpacingDownBtn.onclick = () => {
                const curr = parseFloat((localStorage.getItem('editorParagraphSpacing') || '1.00'));
                applyParagraphSpacing(Math.max(0.00, curr - 0.10).toFixed(2));
            };
        }

        if (fontFamilySelect) {
            fontFamilySelect.onchange = (e) => applyFontFamily(e.target.value);
        }

        // Drag & Drop File Import
        let dragCounter = 0;
        const dropZoneOverlay = document.createElement('div');
        dropZoneOverlay.id = 'drop-zone-overlay';
        dropZoneOverlay.className = 'hidden fixed inset-0 bg-blue-500/20 backdrop-blur-sm z-[9999] flex items-center justify-center';
        dropZoneOverlay.innerHTML = `
            <div class="bg-white dark:bg-slate-800 rounded-2xl p-12 shadow-2xl border-4 border-dashed border-blue-500 dark:border-blue-400 text-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-24 w-24 mx-auto mb-4 text-blue-500 dark:text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                </svg>
                <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-100 mb-2">Upuść plik JSON tutaj</h3>
                <p class="text-slate-600 dark:text-slate-400">aby zaimportować dane</p>
            </div>
        `;
        document.body.appendChild(dropZoneOverlay);

        document.addEventListener('dragenter', (e) => {
            e.preventDefault();
            dragCounter++;
            if (dragCounter === 1 && e.dataTransfer.types.includes('Files')) {
                dropZoneOverlay.classList.remove('hidden');
            }
        });

        document.addEventListener('dragleave', (e) => {
            e.preventDefault();
            dragCounter--;
            if (dragCounter === 0) {
                dropZoneOverlay.classList.add('hidden');
            }
        });

        document.addEventListener('dragover', (e) => {
            e.preventDefault();
        });

        document.addEventListener('drop', (e) => {
            e.preventDefault();
            dragCounter = 0;
            dropZoneOverlay.classList.add('hidden');

            const files = e.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];

                // Check if it's a JSON file
                if (file.type === 'application/json' || file.name.endsWith('.json')) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            const importedState = JSON.parse(event.target.result);
                            if (importedState && Array.isArray(importedState.projects)) {
                                showConfirmation(
                                    'Importować dane?',
                                    `Plik: ${file.name}<br>Spowoduje to nadpisanie wszystkich obecnych danych.`,
                                    () => {
                                        state = { projects: [], snippets: [], selectedProjectId: null, selectedPromptId: null, selectedVersionId: null, sortMode: 'manual' };
                                        loadData();
                                        state = importedState;
                                        saveData();
                                        renderAll();
                                        showToast(`✅ Zaimportowano z: ${file.name}`);
                                    },
                                    'Importuj'
                                );
                            } else {
                                throw new Error('Invalid file format');
                            }
                        } catch (err) {
                            console.error('Error importing file:', err);
                            showToast('❌ Błąd: Nieprawidłowy format pliku JSON', 'error');
                        }
                    };
                    reader.readAsText(file);
                } else {
                    showToast('⚠️ Tylko pliki JSON są wspierane', 'error');
                }
            }
        });

        // --- 17. THEME & PERSONALIZATION / MOTYWY I PERSONALIZACJA ---

        // Dark Mode Functions
        const enableDarkMode = () => {
            document.documentElement.classList.add('dark');
            if (darkModeIconSun) darkModeIconSun.classList.remove('hidden');
            if (darkModeIconMoon) darkModeIconMoon.classList.add('hidden');
            localStorage.setItem('darkMode', 'enabled');
        };

        const disableDarkMode = () => {
            document.documentElement.classList.remove('dark');
            if (darkModeIconSun) darkModeIconSun.classList.add('hidden');
            if (darkModeIconMoon) darkModeIconMoon.classList.remove('hidden');
            localStorage.setItem('darkMode', 'disabled');
        };

        const toggleDarkMode = () => {
            if (document.documentElement.classList.contains('dark')) {
                disableDarkMode();
            } else {
                enableDarkMode();
            }
        };

        // Dark Mode Toggle Button
        if (darkModeToggle) {
            darkModeToggle.addEventListener('click', toggleDarkMode);
        }

        // Auto-detect system preference for dark mode
        const initializeDarkMode = () => {
            const savedDarkMode = localStorage.getItem('darkMode');

            if (savedDarkMode === 'enabled') {
                enableDarkMode();
            } else if (savedDarkMode === 'disabled') {
                disableDarkMode();
            } else {
                // No saved preference, use system preference
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    enableDarkMode();
                } else {
                    disableDarkMode();
                }
            }
        };

        // Listen for system theme changes
        if (window.matchMedia) {
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
                // Only auto-switch if user hasn't manually set preference
                if (!localStorage.getItem('darkMode')) {
                    if (e.matches) {
                        enableDarkMode();
                    } else {
                        disableDarkMode();
                    }
                }
            });
        }

        // Initialize dark mode immediately (before other initialization)
        initializeDarkMode();

        // --- 18. INITIALIZATION / INICJALIZACJA ---
        applyEditorFontSize(localStorage.getItem('editorFontSize') || '1.0');
        applyLineHeight(localStorage.getItem('editorLineHeight') || '1.5');
        applyParagraphSpacing(localStorage.getItem('editorParagraphSpacing') || '1.0');

        const savedFontFamily = localStorage.getItem('fontFamily');
        if (savedFontFamily) {
            fontFamilySelect.value = savedFontFamily;
            applyFontFamily(savedFontFamily);
        }

        loadData();
        sortModeSelect.value = state.sortMode;
        renderAll();
        updateSidebarTop();
        
        // Wywołaj updateCombinedOutput jeśli jest wybrany prompt
        if (state.selectedPromptId) {
            setTimeout(() => {
                updateCombinedOutput();
            }, 100);
        }
        
        // Initialize Adaptive Workspace
        initializeAdaptiveWorkspace();
        
        // Initialize focus mode from localStorage
        if (localStorage.getItem('focusMode') === 'true') {
            focusMode = false; // Set to false so toggle will set it to true
            toggleFocusMode();
        }
        
        // Check if we're on desktop and show initial hint
        setTimeout(() => {
            if (window.innerWidth >= 1024 && !localStorage.getItem('workspaceHintShown')) {
                showToast('💡 Tip: Przeciągnij granicę między panelami lub użyj Ctrl+\\ dla Focus Mode');
                localStorage.setItem('workspaceHintShown', 'true');
            }
        }, 2000);
    });
    </script>
</body>

</html>
